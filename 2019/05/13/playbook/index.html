<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="摇旗呐喊的热情,携光阴渐远去,人世间悲喜烂剧,昼夜轮播不停,纷飞的滥情男女,情仇爱恨别离,一代人终将老去，但总有人正年轻" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    Playbook |  Nero 的个人博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-playbook"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Playbook
</h1>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/playbook/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Playbook"><a href="#Playbook" class="headerlink" title="Playbook"></a>Playbook</h1><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#安装一个httpd 并启动</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment">#yum模块 安装httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="comment">#systemd模块 启动并设置开机启动</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">startde</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web1</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> </span><br><span class="line">        <span class="attr">content:</span> <span class="string">&#x27;this is the web1&#x27;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web2</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">&#x27;this is the web2&#x27;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法2</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#安装一个httpd 并启动</span></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    <span class="comment">#yum模块 安装httpd</span></span><br><span class="line">    - name: install httpd</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line">    <span class="comment">#systemd模块 启动并设置开机启动</span></span><br><span class="line">    - name: start httpd</span><br><span class="line">      systemd: name=httpd state=startde enabled=yes </span><br><span class="line">- hosts: web1</span><br><span class="line">  tasks:</span><br><span class="line">    - name: web1 file</span><br><span class="line">      copy: content=<span class="string">&#x27;this is the web1&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line">    </span><br><span class="line">- hosts: web2</span><br><span class="line">  tasks:</span><br><span class="line">    - name: web2 file</span><br><span class="line">      copy: content=<span class="string">&#x27;this is the web2&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -C httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="语法校验"><a href="#语法校验" class="headerlink" title="语法校验"></a>语法校验</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --syntax-check httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="真正执行"><a href="#真正执行" class="headerlink" title="真正执行"></a>真正执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook  httpd.yml</span><br></pre></td></tr></table></figure>

<h2 id="触发handlers"><a href="#触发handlers" class="headerlink" title="触发handlers"></a>触发handlers</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment">#此任务如执行成功就触发handlers 的 restart httpd任务</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web2</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">content=&#x27;this</span> <span class="string">is</span> <span class="string">the</span> <span class="string">web2&#x27;</span> <span class="string">dest=/var/www/html/index.html</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>

<h1 id="变量vars"><a href="#变量vars" class="headerlink" title="变量vars"></a>变量vars</h1><h2 id="定义变量方式"><a href="#定义变量方式" class="headerlink" title="定义变量方式"></a>定义变量方式</h2><ul>
<li>通过命令行定义变量</li>
<li>通过playbook文件中定义变量</li>
<li>通过主机清单定义组的变量或者主机的变量</li>
</ul>
<h2 id="变量优先级"><a href="#变量优先级" class="headerlink" title="变量优先级"></a>变量优先级</h2><ul>
<li>命令行变量  &gt;  playbook变量  &gt; 主机清单变量</li>
</ul>
<h2 id="playboot定义变量示例"><a href="#playboot定义变量示例" class="headerlink" title="playboot定义变量示例"></a>playboot定义变量示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#playbook 定义变量 此方式只在此任务生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">db_package:</span> <span class="string">mariadb-server</span></span><br><span class="line">  <span class="attr">task:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vars_files 方式定义playbook变量</span></span><br><span class="line">~ ]<span class="comment"># vim vars.yml</span></span><br><span class="line">web_package: httpd</span><br><span class="line">db_package: mariadb-server</span><br><span class="line"><span class="comment">#playbook引用变量文件</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  <span class="comment">#vars_files: ./vars.yml</span></span><br><span class="line">  vars_files:</span><br><span class="line">    - ./vars.yml</span><br><span class="line">  task:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - <span class="string">&quot;&#123;&#123; web_package &#125;&#125;&quot;</span></span><br><span class="line">          - <span class="string">&quot;&#123;&#123; db_package &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>

<h2 id="主机清单定义变量示例"><a href="#主机清单定义变量示例" class="headerlink" title="主机清单定义变量示例"></a>主机清单定义变量示例</h2><ul>
<li>主机清单变量包括 主机变量 和组变量 其中 主机变量 &gt; 组变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此方式 官方不推荐</span></span><br><span class="line"><span class="comment">#定义变量</span></span><br><span class="line">vim hosts</span><br><span class="line">[web]</span><br><span class="line">192.168.1.123</span><br><span class="line">192.168.1.124</span><br><span class="line">[web:vars]</span><br><span class="line">file_name=file1</span><br><span class="line"></span><br><span class="line"><span class="comment">#引用变量</span></span><br><span class="line">---</span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name create file</span><br><span class="line">      file:</span><br><span class="line">        path: /tmp/&#123;&#123; file_name &#125;&#125;</span><br><span class="line">        state: touch</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方推荐的范式</span></span><br><span class="line"><span class="comment"># 在ansible的项目目录中创建额外的两个变量目录 分别是 host_vars 和 group_vars 名字必须是这两个</span></span><br><span class="line"><span class="comment"># group_vars目录用于保存针对某个组生效的变量文件 文件名应该与组名相同 此时playbook文件此组的任务中无需配置 自动加载此文件位变量文件</span></span><br><span class="line"><span class="comment"># 如果你想所有组都生效 可以利用自带的特殊组 all  在group_vars中建立all文件别再文件中编写变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group_vars 示例</span></span><br><span class="line">vim group_vars/web</span><br><span class="line">file_name=file1</span><br><span class="line"><span class="comment">#引用变量</span></span><br><span class="line">---</span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name create file</span><br><span class="line">      file:</span><br><span class="line">        path: /tmp/&#123;&#123; file_name &#125;&#125;</span><br><span class="line">        state: touch</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="命令行定义变量"><a href="#命令行定义变量" class="headerlink" title="命令行定义变量"></a>命令行定义变量</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令行定义变量优先级最好 可以覆盖所有相同名称的变量</span></span><br><span class="line">ansible-playbook f1.yml -e <span class="string">&quot;web_package=httpd&quot;</span> -e <span class="string">&quot;db_package=mariadb-server&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="层级变量定义"><a href="#层级变量定义" class="headerlink" title="层级变量定义"></a>层级变量定义</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义变量</span></span><br><span class="line"><span class="string">vim</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">rainbow:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">db_package:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">code:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">filename:</span> <span class="string">cede_filename</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#引用变量</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="comment">#vars_files: ./vars.yml</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./vars.yml</span></span><br><span class="line">  <span class="attr">task:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; rainbow.web.web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; rainbow.web.db_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h1 id="变量注册register"><a href="#变量注册register" class="headerlink" title="变量注册register"></a>变量注册register</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># ss -tnlp 的执行结果将会保存在 net_prot这个变量中</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">net_prot</span></span><br><span class="line">      <span class="comment">#打印出一个变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">optput</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; net_prot &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#输出结果</span><br><span class="line">TASK [optput network port status] *******************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">    #可以看到 输出是json格式mag 里面的内容内容 就是 你定义的变量的内容 可以使用 &#123;&#123; net_prot.stdout_lines &#125;&#125; 来只输出 标准输出的数据 </span><br><span class="line">ok: [192.168.1.81] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: true, </span><br><span class="line">        &quot;cmd&quot;: &quot;ss -tnlp&quot;, </span><br><span class="line">        &quot;delta&quot;: &quot;0:00:00.022127&quot;, </span><br><span class="line">        &quot;end&quot;: &quot;2020-12-30 14:08:51.630273&quot;, </span><br><span class="line">        &quot;failed&quot;: false, </span><br><span class="line">        &quot;rc&quot;: 0, </span><br><span class="line">        &quot;start&quot;: &quot;2020-12-30 14:08:51.608146&quot;, </span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;, </span><br><span class="line">        &quot;stderr_lines&quot;: [], </span><br><span class="line">        &quot;stdout&quot;: &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              \nLISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=33))\nLISTEN     0      128    192.168.1.83:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2156,fd=3))\nLISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=10))\nLISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=12))\nLISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=3049,fd=3))\nLISTEN     0      128    192.168.1.83:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=2339,fd=3))\nLISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2212,fd=3))\nLISTEN     0      128    127.0.0.1:41836                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=11))\nLISTEN     0      128    192.168.1.83:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=11))\nLISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=3160,fd=7))\nLISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=823,fd=3))\nLISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=29))\nLISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=823,fd=4))&quot;, </span><br><span class="line">            #这里是标准输出多行结果</span><br><span class="line">        &quot;stdout_lines&quot;: [</span><br><span class="line">            &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              &quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=33))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2156,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=10))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=12))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=3049,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=2339,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2212,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:41836                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=11))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=11))&quot;, </span><br><span class="line">            &quot;LISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=3160,fd=7))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=823,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=29))&quot;, </span><br><span class="line">            <span class="string">&quot;LISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=823,fd=4))&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># ss -tnlp 的执行结果将会保存在 net_prot这个变量中</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">net_prot</span></span><br><span class="line">      <span class="comment">#打印出一个变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">optput</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; net_prot.stdout_lines &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># net_prot.stdout_lines  输出结果</span><br><span class="line">TASK [optput network port status] ******************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.1.81] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              &quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=35))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=10))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2462,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=12))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=4271,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:2379                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=7))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:2379                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=6))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=3482,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2574,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:2380                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=5))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:32783                    *:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=12))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=11))&quot;, </span><br><span class="line">        &quot;LISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=4354,fd=7))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=827,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=36))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:8080                  [::]:*                   users:((\&quot;traefik\&quot;,pid=4836,fd=9))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:80                    [::]:*                   users:((\&quot;traefik\&quot;,pid=4836,fd=8))&quot;, </span><br><span class="line">        <span class="string">&quot;LISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=827,fd=4))&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="facts变量"><a href="#facts变量" class="headerlink" title="facts变量"></a>facts变量</h1><ul>
<li>facts变量 是在被控主机上自动采集到的信息</li>
<li>包含主机名 ip 系统版本 cpu 内存 磁盘状态等信息</li>
</ul>
<h2 id="获取一台主机的facts变量信息"><a href="#获取一台主机的facts变量信息" class="headerlink" title="获取一台主机的facts变量信息"></a>获取一台主机的facts变量信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.1.81 -m setup</span><br></pre></td></tr></table></figure>

<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#123;&#123; ansible_memory_mb.nocache.free &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关闭facts获取"><a href="#关闭facts获取" class="headerlink" title="关闭facts获取"></a>关闭facts获取</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认执行playbook的时候每次首先都要自动获取facts</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  <span class="comment"># 关闭facts采集</span></span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars: </span><br><span class="line">    - zabbix_server: 172.16.1.71</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Zabbix Agent Configure</span><br><span class="line">      template: src=./zabbix_agentd.conf dest=/tmp/zabbix_agent.conf</span><br></pre></td></tr></table></figure>

<h1 id="条件执行"><a href="#条件执行" class="headerlink" title="条件执行"></a>条件执行</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#根据系统版本判断是否执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#语法1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      <span class="comment">#当facts变量 ansible_distribution 等于 CentOS 才执行此task</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">Ubuntu</span></span><br><span class="line">      <span class="attr">apt:</span> <span class="string">name=httpd2</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment">#语法2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span> </span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="comment">#当facts变量 ansible_distribution 等于 CentOS 才执行此task</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nsible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">Ubuntu</span></span><br><span class="line">      <span class="attr">apt:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd2</span> </span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Ubuntu&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串匹配.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">Nginx</span> <span class="string">Repos</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx_tet</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># ansible_hostname是获取的主机名 此主机名以web开头 或者以lb开头的 执行此任务 or 后可以换行</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;web*&quot;)</span> <span class="string">or</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;lb*&quot;))</span></span><br></pre></td></tr></table></figure>

<h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#标准循环</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="comment"># item变量 来自with_items列表 会循环执行 没一个值都会执行一次</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mariadb</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#变量循环</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ensure a list of packages installed</span><br><span class="line">      yum: name= <span class="string">&quot;&#123;&#123; packages &#125;&#125;&quot;</span> state=present</span><br><span class="line">      vars:</span><br><span class="line">        packages:</span><br><span class="line">          - httpd</span><br><span class="line">          - httpd-tools</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字典循环</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Add Users</span><br><span class="line">      user: name=&#123;&#123; item.name &#125;&#125; groups=&#123;&#123; item.groups &#125;&#125; state=present</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: <span class="string">&#x27;testuser1&#x27;</span>, groups: <span class="string">&#x27;bin&#x27;</span> &#125;</span><br><span class="line">        - &#123; name: <span class="string">&#x27;testuser2&#x27;</span>, groups: <span class="string">&#x27;root&#x27;</span> &#125;</span><br><span class="line"><span class="comment">#示例2        </span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Rsync configure and Rsync passwd</span><br><span class="line">      copy: src=&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; item.dest &#125;&#125; mode=&#123;&#123; item.mode &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; src: <span class="string">&quot;./rsyncd.conf&quot;</span>, dest: <span class="string">&quot;/etc/rsyncd.conf&quot;</span>, mode: <span class="string">&quot;0644&quot;</span> &#125;</span><br><span class="line">        - &#123; src: <span class="string">&quot;./rsync.passwd&quot;</span>, dest: <span class="string">&quot;/tmp/rsync.passwd&quot;</span>, mode: <span class="string">&quot;0600&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><ul>
<li>同一个 handlers任务,无论playbook中触发了多少次 只会在tasks任务执行完最后执行一次</li>
<li>只有task任务在被控主机发生了改变 才会触发 handlers任务</li>
<li>不能使用 handlers 代替tasks</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="comment">#正常情况下handlers被调用,但随后的task失败后整个任务停止,handlers 不会被调用</span></span><br><span class="line">  <span class="comment">#此配置是指 只要handlers被调用就必须执行handlers,无论后面是成功还是失败</span></span><br><span class="line">  <span class="comment">#不常用 通常用不到</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Http</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">httpd</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line">      <span class="comment">#当此任务执行成功且目标主机发生改变触发以下两个handlers任务</span></span><br><span class="line">      <span class="attr">notify:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">PHP</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span> </span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">PHP</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=php-fpm</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>



<h1 id="任务标签"><a href="#任务标签" class="headerlink" title="任务标签"></a>任务标签</h1><h2 id="配置标签"><a href="#配置标签" class="headerlink" title="配置标签"></a>配置标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim test.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8083</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Install Http Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line">      tags: install_httpd</span><br><span class="line"></span><br><span class="line">    - name: configure httpd server</span><br><span class="line">      template: src=./httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">      <span class="comment">#当此任务执行成功且目标主机发生改变触发以下两个handlers任务</span></span><br><span class="line">      notify: </span><br><span class="line">        - Restart Httpd Server</span><br><span class="line">      tags: configure_httpd</span><br><span class="line">    - name: start httpd server</span><br><span class="line">      service: name=httpd state=started enabled=yes</span><br><span class="line">      tags: start_httpd</span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd Server</span><br><span class="line">      systemd: name=httpd state=restarted </span><br></pre></td></tr></table></figure>

<h2 id="查看playbook中的标签"><a href="#查看playbook中的标签" class="headerlink" title="查看playbook中的标签"></a>查看playbook中的标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看playbook中的标签</span></span><br><span class="line">╰─➤  ansible-playbook test.yml --list-tags</span><br><span class="line">playbook: test.yml</span><br><span class="line"></span><br><span class="line">  play <span class="comment">#1 (webservers): webservers      TAGS: []</span></span><br><span class="line">      TASK TAGS: [configure_httpd, install_httpd, start_httpd]</span><br></pre></td></tr></table></figure>
<h2 id="指定执行某个标签的任务"><a href="#指定执行某个标签的任务" class="headerlink" title="指定执行某个标签的任务"></a>指定执行某个标签的任务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定执行某个标签的任务</span></span><br><span class="line">ansible-playbook test.yml -t start_httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定运行多个标签的任务</span></span><br><span class="line">ansible-playbook test.yml -t install_httpd,start_httpd</span><br></pre></td></tr></table></figure>

<h1 id="Playbook文件复用"><a href="#Playbook文件复用" class="headerlink" title="Playbook文件复用"></a>Playbook文件复用</h1><h2 id="从文件调用tasks任务列表"><a href="#从文件调用tasks任务列表" class="headerlink" title="从文件调用tasks任务列表"></a>从文件调用tasks任务列表</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从文件调用tasks任务列表</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">f1.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">f2.yml</span></span><br></pre></td></tr></table></figure>

<h2 id="tasks任务列表文件格式"><a href="#tasks任务列表文件格式" class="headerlink" title="tasks任务列表文件格式"></a>tasks任务列表文件格式</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: Install Http Server</span><br><span class="line">  yum: name=httpd state=present</span><br><span class="line">  </span><br><span class="line">- name: start httpd server</span><br><span class="line">  service: name=httpd state=started enabled=yes</span><br></pre></td></tr></table></figure>

<h2 id="从文件调用整个playbook文件"><a href="#从文件调用整个playbook文件" class="headerlink" title="从文件调用整个playbook文件"></a>从文件调用整个playbook文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#顺序执行多个playbook</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">install_httpd.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">install_mysql.yml</span></span><br></pre></td></tr></table></figure>

<h1 id="忽略task任务失败"><a href="#忽略task任务失败" class="headerlink" title="忽略task任务失败"></a>忽略task任务失败</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Http</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      <span class="comment">#如果此任务失败继续执行其他任务 不会终止此playbook</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h1 id="changed状态的抑制"><a href="#changed状态的抑制" class="headerlink" title="changed状态的抑制"></a>changed状态的抑制</h1><ul>
<li>changed_when中的条件成立时，将对应任务的执行状态设置为changed</li>
<li>changed_when  等于false 时  永远都是ok 除非报错</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例1</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8083</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get port</span><br><span class="line">      <span class="comment">#很多shell命令一直都是changed状态无论执行多少次</span></span><br><span class="line">      shell: <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="comment">#抑制changed状态, 永远都是ok状态</span></span><br><span class="line">      changed_when: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例2字符串匹配</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chack</span> <span class="string">nginx</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;nginx -t&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_t</span></span><br><span class="line">      <span class="comment">#如果变量中包含successful字符串 才会是changed状态,否则报错 报错则不会触发restart nginx的handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="string">nginx_t.stdout.find(&#x27;successful&#x27;)</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> </span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例3 混合使用</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chack</span> <span class="string">nginx</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;nginx -t&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_t</span></span><br><span class="line">      <span class="attr">changed_when:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx_t.stdout.find(&#x27;successful&#x27;)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h1 id="ansible-vault-加密"><a href="#ansible-vault-加密" class="headerlink" title="ansible-vault 加密"></a>ansible-vault 加密</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">ansible-vault [-h] [--version] [-v]</span><br><span class="line">                     &#123;create,decrypt,edit,view,encrypt,encrypt_string,rekey&#125;</span><br><span class="line">                     ...</span><br><span class="line"><span class="comment">#动作</span></span><br><span class="line">    create              Create new vault encrypted file</span><br><span class="line">    decrypt             Decrypt vault encrypted file <span class="comment">#移除密码</span></span><br><span class="line">    edit                Edit vault encrypted file <span class="comment">#编辑一个加密文件</span></span><br><span class="line">    view                View vault encrypted file <span class="comment">#查看一个加密的文件</span></span><br><span class="line">    encrypt             Encrypt YAML file <span class="comment">#加密一个文件</span></span><br><span class="line">    encrypt_string      Encrypt a string <span class="comment">#加密字符串</span></span><br><span class="line">    rekey               Re-key a vault encrypted file  <span class="comment">#修改密码</span></span><br></pre></td></tr></table></figure>

<h1 id="jinja2模板"><a href="#jinja2模板" class="headerlink" title="jinja2模板"></a>jinja2模板</h1><h2 id="变量调用"><a href="#变量调用" class="headerlink" title="变量调用"></a>变量调用</h2><ul>
<li>jinja2变量调用 同样适用 表示变量</li>
<li>变量可以使用playbook中可以使用的所有变量包括facts变量</li>
</ul>
<h2 id="模板的推送"><a href="#模板的推送" class="headerlink" title="模板的推送"></a>模板的推送</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./motd.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br></pre></td></tr></table></figure>

<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送示例</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server_name:</span> <span class="string">www.nero.com</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nginx</span> <span class="string">COnfigure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./nero.com.conf.j2</span> <span class="string">dest=/etc/nginx/conf.d/nero.com.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#jinja2模板示例</span><br><span class="line"></span><br><span class="line">upstream &#123;&#123; server_name &#125;&#125; &#123;</span><br><span class="line">#循环语句 </span><br><span class="line">&#123;% for i in range(1,20) %&#125;</span><br><span class="line">  server 172.16.1.&#123;&#123;i&#125;&#125;:&#123;&#123;http_port&#125;&#125;;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; http_port &#125;&#125;;</span><br><span class="line">	server_name &#123;&#123; server_name &#125;&#125;;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://&#123;&#123; server_name &#125;&#125;;</span><br><span class="line">		proxy_set_header Host $http_host;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Keepalived</span> <span class="string">Configure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./kee.conf.j2</span> <span class="string">dest=/tmp/keepalived.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#模板内容</span><br><span class="line">global_defs &#123;     </span><br><span class="line">    router_id &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> #判断语句</span><br><span class="line">&#123;%if ansible_hostname ==&quot;web01&quot; %&#125;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">&#123;%elif ansible_hostname == &quot;web02&quot; %&#125;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line"></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">10.0</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送.</span></span><br><span class="line"><span class="comment">#变量的开关</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">PORT:</span> <span class="number">13366</span></span><br><span class="line">    <span class="comment">#关闭这个变量</span></span><br><span class="line">    <span class="comment">#PORT: false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">mysql</span> <span class="string">Configure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./my.cnf.j2</span> <span class="string">dest=/tmp/my.cnf</span></span><br></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#判断变量是否有值</span><br><span class="line">&#123;% if PORT %&#125;</span><br><span class="line">#如果 PORT 变量有值就使用此配置</span><br><span class="line">bind-address=0.0.0.0:&#123;&#123; PORT &#125;&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">#PORT没有值 就使用3306</span><br><span class="line">bind-address=0.0.0.0:3306</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h1><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#手动创建目录结构 </span></span><br><span class="line"><span class="built_in">cd</span> /etc/ansible/roles/</span><br><span class="line">mkdir nfs/&#123;vars,file,meta,tasks,handlers,templates&#125; -p</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  tree</span><br><span class="line">.</span><br><span class="line">└── nfs				<span class="comment">#角色名称</span></span><br><span class="line">    ├── file         <span class="comment">#存放文件</span></span><br><span class="line">    ├── handlers     <span class="comment">#触发任务</span></span><br><span class="line">    ├── meta         <span class="comment">#依赖关系</span></span><br><span class="line">    ├── tasks        <span class="comment">#具体任务 只能加载main.yml 再有main调用其他文件</span></span><br><span class="line">    ├── templates    <span class="comment">#模板文件</span></span><br><span class="line">    └── vars         <span class="comment">#定义变量</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用ansible-galaxy 生成结构</span></span><br><span class="line">ansible-galaxy init <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">╰─➤  tree</span><br><span class="line">.</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── defaults</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── files</span><br><span class="line">    ├── handlers</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── meta</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── README.md</span><br><span class="line">    ├── tasks</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── templates</span><br><span class="line">    ├── tests</span><br><span class="line">    │   ├── inventory</span><br><span class="line">    │   └── test.yml</span><br><span class="line">    └── vars</span><br><span class="line">        └── main.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat roles/wordpress/meta/main.yml</span><br><span class="line">---</span><br><span class="line">dependencies:</span><br><span class="line">  - &#123; role: nginx &#125;</span><br><span class="line">  - &#123; role: php-fpm &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#此时wordpress的role 会先执行 nginx 和php-fpm 的role 然后在执行本身wordpress的role</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2019/05/13/%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            常用模块
          
        </div>
      </a>
    
    
      <a href="/2017/05/26/1-%E6%8C%87%E6%A0%87%E7%B1%BB%E5%9E%8B/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">1.指标类型</div>
      </a>
    
  </nav>

   
<!-- valine评论 -->
<div id="vcomments-box">
  <div id="vcomments"></div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script>
<script>
  new Valine({
    el: "#vcomments",
    app_id: "",
    app_key: "",
    path: window.location.pathname,
    avatar: "monsterid",
    placeholder: "给我的文章加点评论吧~",
    recordIP: true,
  });
  const infoEle = document.querySelector("#vcomments .info");
  if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
    infoEle.childNodes.forEach(function (item) {
      item.parentNode.removeChild(item);
    });
  }
</script>
<style>
  #vcomments-box {
    padding: 5px 30px;
  }

  @media screen and (max-width: 800px) {
    #vcomments-box {
      padding: 5px 0px;
    }
  }

  #vcomments-box #vcomments {
    background-color: #fff;
  }

  .v .vlist .vcard .vh {
    padding-right: 20px;
  }

  .v .vlist .vcard {
    padding-left: 10px;
  }
</style>

 
     
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> Nero
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo.png" alt="Nero 的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->


<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>