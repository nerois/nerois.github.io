<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="摇旗呐喊的热情,携光阴渐远去,人世间悲喜烂剧,昼夜轮播不停,纷飞的滥情男女,情仇爱恨别离,一代人终将老去，但总有人正年轻" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Nero 的个人博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/back4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Nero 的个人博客</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
        <img
          src="/images/logo.png"
          class="cover-logo"
          alt="Nero 的个人博客"
        />
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['摇旗呐喊的热情,携光阴渐远去,', '人世间悲喜烂剧,昼夜轮播不停,', '纷飞的滥情男女, 情仇爱恨别离,一代人终将老去，但总有人正年轻'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <article class="articles">
    
    
    
    
    <article
  id="post-prometheus-operator/Documentation/user-guides/webhook"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/webhook/" class="article-date">
  <time datetime="2020-12-12T13:30:47.294Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Admission-webhooks"><a href="#Admission-webhooks" class="headerlink" title="Admission webhooks"></a>Admission webhooks</h1><p>This document describes how to set up an admission webhook to validate<br>PrometheusRules, and thus preventing Prometheus from loading invalid<br>configuration.</p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>This guide assumes that you have already <a href="Documentation/user-guides/getting-started.md">deployed the Prometheus<br>Operator</a> and that <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#how-do-i-turn-on-an-admission-controller">admission<br>controllers are<br>enabled</a><br>on your cluster.</p>
<p>Admission webhooks require TLS, and as such this guide also assumes that you<br>have a TLS certificate and key ready.</p>
<h2 id="Preparing-the-Operator"><a href="#Preparing-the-Operator" class="headerlink" title="Preparing the Operator"></a>Preparing the Operator</h2><p>A secret needs to be created from the TLS certificate and key, assuming the<br>certificate is in <code>tls.crt</code> and the key in <code>tls.key</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls prometheus-operator-certs --cert=tls.crt --key=tls.key</span><br></pre></td></tr></table></figure>

<p>The Prometheus Operator will serve the admission webhook. However, to do so, it<br>requires being available over TLS, and not only plain HTTP. Thus the following<br>flags need to be added to the Prometheus Operator deployment:</p>
<ul>
<li><p><code>--web.enable-tls=true</code> to enable the Prometheus Operator to serve its API<br>over TLS,</p>
</li>
<li><p><code>--web.cert-file</code> to load the TLS certificate to use,</p>
</li>
<li><p><code>--web.key-file</code> to load the associate key.</p>
</li>
</ul>
<h2 id="Deploying-the-admission-webhook"><a href="#Deploying-the-admission-webhook" class="headerlink" title="Deploying the admission webhook"></a>Deploying the admission webhook</h2><p>Two variants of the admission webhook are available: a validating webhook and a<br>mutating webhook. Both reject invalid <code>PrometheusRule</code> resources. The mutating<br>variant also adds annotations to validated <code>PrometheusRule</code>s</p>
<p>The following example deploys the validating admission webhook:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">admissionregistration.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ValidatingWebhookConfiguration</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator-rulesvalidation</span></span><br><span class="line"><span class="attr">webhooks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">clientConfig:</span></span><br><span class="line">      <span class="attr">caBundle:</span> <span class="string">SOMECABASE64ENCODED==</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/admission-prometheusrules/validate</span></span><br><span class="line">    <span class="attr">failurePolicy:</span> <span class="string">Fail</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheusrulemutate.monitoring.coreos.com</span></span><br><span class="line">    <span class="attr">namespaceSelector:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line">        <span class="attr">apiVersions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        <span class="attr">operations:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">CREATE</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">UPDATE</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">prometheusrules</span></span><br></pre></td></tr></table></figure>

<p>The <code>caBundle</code> contains the base64-encoded CA certificate used to sign the<br>webhook’s certificate.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/user-guides/running-exporters"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/running-exporters/" class="article-date">
  <time datetime="2020-12-12T13:30:47.281Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.
</div>

<h1 id="Running-Exporters"><a href="#Running-Exporters" class="headerlink" title="Running Exporters"></a>Running Exporters</h1><p>Running exporters and scraping them with Prometheus configured by the prometheus-operator.</p>
<h2 id="The-goal-of-ServiceMonitor-s"><a href="#The-goal-of-ServiceMonitor-s" class="headerlink" title="The goal of ServiceMonitor(s)"></a>The goal of ServiceMonitor(s)</h2><p>The goal for one ServiceMonitor should be to cover a large number of Services. This can be achieved by creating a generic <code>ServiceMonitor</code>.</p>
<h2 id="Create-a-service-that-exposes-Pod-s"><a href="#Create-a-service-that-exposes-Pod-s" class="headerlink" title="Create a service that exposes Pod(s)"></a>Create a service that exposes Pod(s)</h2><p>Scraping an exporter or separate metrics port requires a service that targets the Pod(s) of the exporter or application.</p>
<p>The following examples create a Service for the <code>kube-state-metrics</code>, and a generic ServiceMonitor which may be used for more than simply the <code>kube-state-metrics</code> Service.</p>
<p>The order in which the <code>Service</code> and <code>ServiceMonitor</code> is created is not important.</p>
<h3 id="kube-state-metrics-Service-example"><a href="#kube-state-metrics-Service-example" class="headerlink" title="kube-state-metrics Service example"></a>kube-state-metrics Service example</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">    k8s-app: kube-state-metrics</span><br><span class="line">  annotations:</span><br><span class="line">    alpha.monitoring.coreos.com&#x2F;non-namespaced: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: metrics</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: kube-state-metrics</span><br></pre></td></tr></table></figure>

<p>This Service targets all Pods with the label <code>k8s-app: kube-state-metrics</code>.</p>
<h3 id="Generic-ServiceMonitor-example"><a href="#Generic-ServiceMonitor-example" class="headerlink" title="Generic ServiceMonitor example"></a>Generic ServiceMonitor example</h3><p>This ServiceMonitor targets <strong>all</strong> Services with the label <code>k8s-app</code> (<code>spec.selector</code>) any value, in the namespaces <code>kube-system</code> and <code>monitoring</code> (<code>spec.namespaceSelector</code>).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com&#x2F;v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-apps-http</span><br><span class="line">  labels:</span><br><span class="line">    k8s-apps: http</span><br><span class="line">spec:</span><br><span class="line">  jobLabel: k8s-app</span><br><span class="line">  selector:</span><br><span class="line">    matchExpressions:</span><br><span class="line">    - &#123;key: k8s-app, operator: Exists&#125;</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - kube-system</span><br><span class="line">    - monitoring</span><br><span class="line">  endpoints:</span><br><span class="line">  - port: http-metrics</span><br><span class="line">    interval: 15s</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><h3 id="Namespace-“limits”-things-to-keep-in-mind"><a href="#Namespace-“limits”-things-to-keep-in-mind" class="headerlink" title="Namespace “limits”/things to keep in mind"></a>Namespace “limits”/things to keep in mind</h3><p>See the ServiceMonitor Documentation:</p>
<blockquote>
<p>While <code>ServiceMonitors</code> must live in the same namespace as the Prometheus<br>resource, discovered targets may come from any namespace. This allows<br>cross-namespace monitoring use cases, for example, for meta-monitoring. Use the<br><code>namespaceSelector</code> of the <code>ServiceMonitorSpec</code> to restrict the<br>namespaces from which Endpoints objects may be discovered.</p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/user-guides/linting"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/linting/" class="article-date">
  <time datetime="2020-12-12T13:30:47.266Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Linting"><a href="#Linting" class="headerlink" title="Linting"></a>Linting</h1><p>This document describes how to use the standalone linting tool to validate your Prometheus Operator <a href="../design.md">CRD-based</a> configuration files.</p>
<h2 id="Getting-linter"><a href="#Getting-linter" class="headerlink" title="Getting linter"></a>Getting linter</h2><p>To use the linter either get it with <code>go get -u github.com/coreos/prometheus-operator/cmd/po-lint</code> and executable is <code>$GOPATH/bin/po-lint</code>, or use the container image from <code>quay.io/coreos/po-tooling</code> and executable is <code>/go/bin/po-lint</code>.</p>
<h2 id="Using-linter"><a href="#Using-linter" class="headerlink" title="Using linter"></a>Using linter</h2><p>The <code>po-lint</code> executable takes a list of yaml files to check as command arguments. It will output any errors to stderr and returns with exit code <code>1</code> on errors, <code>0</code> otherwise.</p>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>Here is an example script to lint a <code>src</code> sub-directory full of Prometheus Operator CRD files with ether local <code>po-lint</code> or Dockerized version:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">LINTER=<span class="string">&quot;quay.io/coreos/prometheus-operator-lint&quot;</span></span><br><span class="line">SCRIPT=$(basename <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">lint_files</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [ -x <span class="string">&quot;<span class="subst">$(command -v po-lint)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Linting &#x27;<span class="variable">$&#123;2&#125;</span>&#x27; files in directory &#x27;<span class="variable">$&#123;1&#125;</span>&#x27;...&quot;</span></span><br><span class="line">    had_errors=0</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> $(find <span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span> -name <span class="string">&quot;<span class="variable">$&#123;2&#125;</span>&quot;</span>); <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;file&#125;</span>&quot;</span></span><br><span class="line">      po-lint <span class="string">&quot;<span class="variable">$&#123;file&#125;</span>&quot;</span></span><br><span class="line">      retval=$?</span><br><span class="line">      <span class="keyword">if</span> [ <span class="variable">$retval</span> -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">        had_errors=1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$&#123;had_errors&#125;</span></span><br><span class="line">  <span class="keyword">elif</span> [ -x <span class="string">&quot;<span class="subst">$(command -v docker)</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Using Dockerized linter.&quot;</span></span><br><span class="line">    docker run \</span><br><span class="line">           --rm \</span><br><span class="line">           --volume <span class="string">&quot;<span class="subst">$(pwd)</span>:/data:ro&quot;</span> \</span><br><span class="line">           --entrypoint <span class="string">&quot;/data/<span class="variable">$&#123;SCRIPT&#125;</span>&quot;</span> \</span><br><span class="line">           --workdir /data \</span><br><span class="line">           <span class="string">&quot;<span class="variable">$&#123;LINTER&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;2&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Linter executable not found.&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lint_files <span class="string">&quot;src&quot;</span> <span class="string">&quot;*.yaml&quot;</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/user-guides/getting-started"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/getting-started/" class="article-date">
  <time datetime="2020-12-12T13:30:47.260Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.<br><br>
This documentation is for an alpha feature. For questions and feedback on the Prometheus OCS Alpha program, email <a href="mailto:tectonic-alpha-feedback@coreos.com">tectonic-alpha-feedback@coreos.com</a>.
</div>

<h1 id="Prometheus-Operator"><a href="#Prometheus-Operator" class="headerlink" title="Prometheus Operator"></a>Prometheus Operator</h1><p>Operators were introduced by CoreOS as a class of software that operates other software, putting operational knowledge collected by humans into software. Read more in the original blog post, <a target="_blank" rel="noopener" href="https://coreos.com/blog/introducing-operators.html">Introducing Operators</a>.</p>
<p>The Prometheus Operator serves to make running Prometheus on top of Kubernetes as easy as possible, while preserving Kubernetes-native configuration options.</p>
<h2 id="Example-Prometheus-Operator-manifest"><a href="#Example-Prometheus-Operator-manifest" class="headerlink" title="Example Prometheus Operator manifest"></a>Example Prometheus Operator manifest</h2><p>To follow this getting started you will need a Kubernetes cluster you have access to. This <a href="../../bundle.yaml">example</a> describes a Prometheus Operator Deployment, and its required ClusterRole, ClusterRoleBinding, Service Account and Custom Resource Definitions.</p>
<h2 id="Related-resources"><a href="#Related-resources" class="headerlink" title="Related resources"></a>Related resources</h2><p>The Prometheus Operator introduces additional resources in Kubernetes to declare the desired state of a Prometheus and Alertmanager cluster as well as the Prometheus configuration. The resources it introduces are:</p>
<ul>
<li><code>Prometheus</code></li>
<li><code>Alertmanager</code></li>
<li><code>ServiceMonitor</code></li>
</ul>
<blockquote>
<p>See the <a href="alerting.md">Alerting guide</a> for more information about the <code>Alertmanager</code> resource, or the <a href="../design.md">Design document</a> for an overview of all resources introduced by the Prometheus Operator.</p>
</blockquote>
<p>The Prometheus resource declaratively describes the desired state of a Prometheus deployment, while a ServiceMonitor describes the set of targets to be monitored by Prometheus.</p>
<p><img src="images/architecture.png" alt="Prometheus Operator Architecture" title="Prometheus Operator Architecture"></p>
<p>The Prometheus resource includes a field called <code>serviceMonitorSelector</code>, which defines a selection of ServiceMonitors to be used. By default and before the version <code>v0.19.0</code>, ServiceMonitors must be installed in the same namespace as the Prometheus instance. With the Prometheus Operator <code>v0.19.0</code> and above, ServiceMonitors can be selected outside the Prometheus namespace via the <code>serviceMonitorNamespaceSelector</code> field of the Prometheus resource.</p>
<p>First, deploy three instances of a simple example application, which listens and exposes metrics on port <code>8080</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fabxc/instrumented_app</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>The ServiceMonitor has a label selector to select Services and their underlying Endpoint objects. The Service object for the example application selects the Pods by the <code>app</code> label having the <code>example-app</code> value. The Service object also specifies the port on which the metrics are exposed.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>This Service object is discovered by a ServiceMonitor, which selects in the same way. The <code>app</code> label must have the value <code>example-app</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure>

<h2 id="Enable-RBAC-rules-for-Prometheus-pods"><a href="#Enable-RBAC-rules-for-Prometheus-pods" class="headerlink" title="Enable RBAC rules for Prometheus pods"></a>Enable RBAC rules for Prometheus pods</h2><p>If <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/">RBAC</a> authorization is activated, you must create RBAC rules for both Prometheus <em>and</em> Prometheus Operator. A ClusterRole and a ClusterRoleBinding for the Prometheus Operator were created in the example Prometheus Operator manifest above. The same must be done for the Prometheus Pods.</p>
<p>Create a ClusterRole and ClusterRoleBinding for the Prometheus Pods:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<p>For more information, see the <a href="../rbac.md">Prometheus Operator RBAC guide</a>.</p>
<h2 id="Include-ServiceMonitors"><a href="#Include-ServiceMonitors" class="headerlink" title="Include ServiceMonitors"></a>Include ServiceMonitors</h2><p>A Prometheus object defines the <code>serviceMonitorSelector</code> to specify which ServiceMonitors should be included. Above the label <code>team: frontend</code> was specified, so that’s what the Prometheus object selects by.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">  <span class="attr">enableAdminAPI:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you have RBAC authorization activated, use the RBAC aware <a href="../../example/rbac/prometheus/prometheus.yaml">Prometheus manifest</a> instead.</p>
</blockquote>
<p>This enables the frontend team to create new ServiceMonitors and Services which allow Prometheus to be dynamically reconfigured.</p>
<h2 id="Include-PodMonitors"><a href="#Include-PodMonitors" class="headerlink" title="Include PodMonitors"></a>Include PodMonitors</h2><p>Finally, a Prometheus object defines the <code>podMonitorSelector</code> to specify which PodMonitors should be included. Above the label <code>team: frontend</code> was specified, so that’s what the Prometheus object selects by.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">podMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">  <span class="attr">enableAdminAPI:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>If you have RBAC authorization activated, use the RBAC aware <a href="../../example/rbac/prometheus/prometheus.yaml">Prometheus manifest</a> instead.</p>
</blockquote>
<p>This enables the frontend team to create new PodMonitors which allow Prometheus to be dynamically reconfigured.</p>
<h2 id="Expose-the-Prometheus-instance"><a href="#Expose-the-Prometheus-instance" class="headerlink" title="Expose the Prometheus instance"></a>Expose the Prometheus instance</h2><p>To access the Prometheus instance it must be exposed to the outside. This example exposes the instance using a Service of type <code>NodePort</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30900</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>

<p>Once this Service is created the Prometheus web UI is available under the node’s IP address on port <code>30900</code>. The targets page in the web UI now shows that the instances of the example application have successfully been discovered.</p>
<blockquote>
<p>Exposing the Prometheus web UI may not be an applicable solution. Read more about the possibilities of exposing it in the <a href="exposing-prometheus-and-alertmanager.md">exposing Prometheus and Alertmanager guide</a>.</p>
</blockquote>
<h2 id="Expose-the-Prometheus-Admin-API"><a href="#Expose-the-Prometheus-Admin-API" class="headerlink" title="Expose the Prometheus Admin API"></a>Expose the Prometheus Admin API</h2><p>Prometheus Admin API allows access to delete series for a certain time range, cleanup tombstones, capture snapshots, etc. More information about the admin API can be found in <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis">Prometheus official documentation</a><br>This API access is disabled by default and can be toggled using this boolean flag. The following example exposes the admin API:</p>
<blockquote>
<p>WARNING: Enabling the admin APIs enables mutating endpoints, to delete data,<br>shutdown Prometheus, and more. Enabling this should be done with care and the<br>user is advised to add additional authentication authorization via a proxy to<br>ensure only clients authorized to perform these actions can do so.</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">  <span class="attr">enableAdminAPI:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>Further reading:</p>
<ul>
<li><a href="alerting.md">Alerting</a> describes using the Prometheus Operator go manage Alertmanager clusters.</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/user-guides/basic-auth"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/basic-auth/" class="article-date">
  <time datetime="2020-12-12T13:30:47.246Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.
</div>

<h2 id="Basic-auth-for-targets"><a href="#Basic-auth-for-targets" class="headerlink" title="Basic auth for targets"></a>Basic auth for targets</h2><p>To authenticate a <code>ServiceMonitor</code>s over a metrics endpoint use <a href="../api.md#basicauth"><code>basicAuth</code></a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-apps:</span> <span class="string">basic-auth-example</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-auth-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">basicAuth:</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">metrics</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">logging</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">dG9vcg==</span> <span class="comment"># toor</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">YWRtaW4=</span> <span class="comment"># admin</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/user-guides/alerting"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/user-guides/alerting/" class="article-date">
  <time datetime="2020-12-12T13:30:47.239Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.<br><br>
This documentation is for an alpha feature. For questions and feedback on the Prometheus OCS Alpha program, email <a href="mailto:tectonic-alpha-feedback@coreos.com">tectonic-alpha-feedback@coreos.com</a>.
</div>

<h1 id="Alerting"><a href="#Alerting" class="headerlink" title="Alerting"></a>Alerting</h1><p>This guide assumes you have a basic understanding of the <code>Prometheus</code> resource and have read the <a href="getting-started.md">getting started guide</a>.</p>
<p>The Prometheus Operator introduces an Alertmanager resource, which allows users to declaratively describe an Alertmanager cluster. To successfully deploy an Alertmanager cluster, it is important to understand the contract between Prometheus and Alertmanager.</p>
<p>The Alertmanager may be used to:</p>
<ul>
<li>Deduplicate alerts fired by Prometheus</li>
<li>Silence alerts</li>
<li>Route and send grouped notifications via providers (PagerDuty, OpsGenie, …)</li>
</ul>
<p>Prometheus’ configuration also includes “rule files”, which contain the <a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/">alerting rules</a>. When an alerting rule triggers it fires that alert against <em>all</em> Alertmanager instances, on <em>every</em> rule evaluation interval. The Alertmanager instances communicate to each other which notifications have already been sent out. For more information on this system design, see the <a href="../high-availability.md">High Availability scheme description</a>.</p>
<p>First, create an example Alertmanager cluster, with three instances.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Alertmanager</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>The Alertmanager instances will not be able to start up, unless a valid configuration is given. The following example configuration sends notifications against a non-existent <code>webhook</code>, allowing the Alertmanager to start up, without issuing any notifications.<br>For more information on configuring Alertmanager, see the Prometheus <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/">Alerting Configuration document</a>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> [<span class="string">&#x27;job&#x27;</span>]</span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">12h</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">&#x27;webhook&#x27;</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;webhook&#x27;</span></span><br><span class="line">  <span class="attr">webhook_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://alertmanagerwh:30500/&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Save the above Alertmanager config in a file called <code>alertmanager.yaml</code> and create a secret from it using <code>kubectl</code>.</p>
<p>Alertmanager instances require the secret resource naming to follow the format<br><code>alertmanager-&#123;ALERTMANAGER_NAME&#125;</code>. In the previous example, the name of the Alertmanager is <code>example</code>, so the secret name must be <code>alertmanager-example</code>, and the name of the config file <code>alertmanager.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create secret generic alertmanager-example --from-file=alertmanager.yaml</span><br></pre></td></tr></table></figure>

<p>Note that Alertmanager configurations can use templates (<code>.tmpl</code> files), which can be added on the secret along with the <code>alertmanager.yaml</code> config file. For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager-example</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alertmanager.yaml:</span> &#123;<span class="string">BASE64_CONFIG</span>&#125;</span><br><span class="line">  <span class="attr">template_1.tmpl:</span> &#123;<span class="string">BASE64_TEMPLATE_1</span>&#125;</span><br><span class="line">  <span class="attr">template_2.tmpl:</span> &#123;<span class="string">BASE64_TEMPLATE_2</span>&#125;</span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>Templates will be placed on the same path as the configuration. To load the templates, the configuration (<code>alertmanager.yaml</code>) should point to them:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">templates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#x27;*.tmpl&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Once created this Secret is mounted by Alertmanager Pods created through the Alertmanager object.</p>
<p>To be able to view the web UI, expose it through a Service. A simple way to do this is to use a Service of type <code>NodePort</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30903</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">alertmanager:</span> <span class="string">example</span></span><br></pre></td></tr></table></figure>

<p>Once created it allows the web UI to be accessible via a Node’s IP and the port <code>30903</code>.</p>
<p>This Alertmanager cluster is now fully functional and highly available, but no alerts are fired against it. Create  Prometheus instances to fire alerts to the Alertmanagers.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">alertmanager-example</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">ruleSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">example</span></span><br></pre></td></tr></table></figure>

<p>The above configuration specifies a <code>Prometheus</code> that finds all of the Alertmanagers behind the <code>Service</code> created with <code>alertmanager-example-service.yaml</code>. The <code>alertmanagers</code> <code>name</code> and <code>port</code> fields should match those of the <code>Service</code> to allow this to occur.</p>
<p>Prometheus rule files are held in <code>PrometheusRule</code> custom resources. Use the label selector field <code>ruleSelector</code> in the Prometheus object to define the rule files that you want to be mounted into Prometheus.</p>
<p>The best practice is to label the <code>PrometheusRule</code>s containing rule files with <code>role: alert-rules</code> as well as the name of the Prometheus object, <code>prometheus: example</code> in this case.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PrometheusRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">example</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-example-rules</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">./example.rules</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ExampleAlert</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">vector(1)</span></span><br></pre></td></tr></table></figure>

<p>The example <code>PrometheusRule</code> always immediately triggers an alert, which is only for demonstration purposes. To validate that everything is working properly have a look at each of the Prometheus web UIs.</p>
<p>Use kubectl’s proxy functionality to view the web UI without a Service.</p>
<p>Run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port=8001</span><br></pre></td></tr></table></figure>

<p>Then the web UI of each Prometheus instance can be viewed, they both have a firing alert called <code>ExampleAlert</code>, as defined in the loaded alerting rules.</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-0:9090/alerts">http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-0:9090/alerts</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-1:9090/alerts">http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-1:9090/alerts</a></li>
</ul>
<p>Looking at the status page for “Runtime &amp; Build Information” on the Prometheus web UI shows the discovered and active Alertmanagers that the Prometheus instance will fire alerts against.</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-0:9090/status">http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-0:9090/status</a></li>
<li><a target="_blank" rel="noopener" href="http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-1:9090/status">http://localhost:8001/api/v1/proxy/namespaces/default/pods/prometheus-example-1:9090/status</a></li>
</ul>
<p>These show three discovered Alertmanagers.</p>
<p>Heading to the Alertmanager web UI now shows one active alert, although all Prometheus instances are firing it. <a target="_blank" rel="noopener" href="https://prometheus.io/docs/alerting/configuration/">Configuring the Alertmanager</a> further allows custom alert routing, grouping and notification mechanisms.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/troubleshooting"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/troubleshooting/" class="article-date">
  <time datetime="2020-12-12T13:30:47.222Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.
</div>

<h1 id="FAQ-Troubleshooting"><a href="#FAQ-Troubleshooting" class="headerlink" title="FAQ / Troubleshooting"></a>FAQ / Troubleshooting</h1><h3 id="RBAC-on-Google-Container-Engine-GKE"><a href="#RBAC-on-Google-Container-Engine-GKE" class="headerlink" title="RBAC on Google Container Engine (GKE)"></a>RBAC on Google Container Engine (GKE)</h3><p>When you try to create <code>ClusterRole</code> (<code>kube-state-metrics</code>, <code>prometheus</code> <code>prometheus-operator</code>, etc.) on GKE Kubernetes cluster running 1.6 version, you will probably run into permission errors:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;....&gt;</span><br><span class="line">Error from server (Forbidden): error when creating </span><br><span class="line">&quot;manifests&#x2F;prometheus-operator&#x2F;prometheus-operator-cluster-role.yaml&quot;: </span><br><span class="line">clusterroles.rbac.authorization.k8s.io &quot;prometheus-operator&quot; is forbidden: attempt to grant extra privileges:</span><br><span class="line">&lt;....&gt;</span><br><span class="line">&#96;&#96;&#96;&#96;</span><br><span class="line"></span><br><span class="line">This is due to the way Container Engine checks permissions. From [Google Kubernetes Engine docs](https:&#x2F;&#x2F;cloud.google.com&#x2F;kubernetes-engine&#x2F;docs&#x2F;how-to&#x2F;role-based-access-control):</span><br><span class="line"></span><br><span class="line">&gt; Because of the way Container Engine checks permissions when you create a Role or ClusterRole, you must first create a RoleBinding that grants you all of the permissions included in the role you want to create.</span><br><span class="line">&gt; An example workaround is to create a RoleBinding that gives your Google identity a cluster-admin role before attempting to create additional Role or ClusterRole permissions.</span><br><span class="line">&gt; This is a known issue in the Beta release of Role-Based Access Control in Kubernetes and Container Engine version 1.6.</span><br><span class="line"></span><br><span class="line">To overcome this, you must grant your current Google identity &#96;cluster-admin&#96; Role:</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;console</span><br><span class="line"># get current google identity</span><br><span class="line">$ gcloud info | grep Account</span><br><span class="line">Account: [myname@example.org]</span><br><span class="line"></span><br><span class="line"># grant cluster-admin to your current identity</span><br><span class="line">$ kubectl create clusterrolebinding myname-cluster-admin-binding --clusterrole&#x3D;cluster-admin --user&#x3D;myname@example.org</span><br><span class="line">Clusterrolebinding &quot;myname-cluster-admin-binding&quot; created</span><br></pre></td></tr></table></figure>

<h3 id="Troubleshooting-ServiceMonitor-changes"><a href="#Troubleshooting-ServiceMonitor-changes" class="headerlink" title="Troubleshooting ServiceMonitor changes"></a>Troubleshooting ServiceMonitor changes</h3><p>When creating/deleting/modifying <code>ServiceMonitor</code> objects it is sometimes not as obvious what piece is not working properly. This section gives a step by step guide how to troubleshoot such actions on a <code>ServiceMonitor</code> object.</p>
<h4 id="Overview-of-ServiceMonitor-tagging-and-related-elements"><a href="#Overview-of-ServiceMonitor-tagging-and-related-elements" class="headerlink" title="Overview of ServiceMonitor tagging and related elements"></a>Overview of <code>ServiceMonitor</code> tagging and related elements</h4><p>A common problem related to <code>ServiceMonitor</code> identification by Prometheus is related to an incorrect tagging, that does not match the <code>Prometheus</code> custom resource definition scope, or lack of permission for the Prometheus <code>ServiceAccount</code> to <em>get, list, watch</em> <code>Services</code> and <code>Endpoints</code> from the target application being monitored. As a general guideline consider the diagram below, giving an example of a <code>Deployment</code> and <code>Service</code> called <code>my-app</code>, being monitored by Prometheus based on a <code>ServiceMonitor</code> named <code>my-service-monitor</code>:</p>
<p><img src="/2020/12/12/prometheus-operator/Documentation/troubleshooting/custom-metrics-elements.png" alt="flow diagram"></p>
<p>Note: The <code>ServiceMonitor</code> references a <code>Service</code> (not a <code>Deployment</code>, or a <code>Pod</code>), by labels <em>and</em> by the port name in the <code>Service</code>. This <em>port name</em> is optional in Kubernetes, but must be specified for the <code>ServiceMonitor</code> to work. It is not the same as the port name on the <code>Pod</code> or container, although it can be.</p>
<h4 id="Has-my-ServiceMonitor-been-picked-up-by-Prometheus"><a href="#Has-my-ServiceMonitor-been-picked-up-by-Prometheus" class="headerlink" title="Has my ServiceMonitor been picked up by Prometheus?"></a>Has my <code>ServiceMonitor</code> been picked up by Prometheus?</h4><p><code>ServiceMonitor</code> objects are selected by the <code>serviceMonitorSelector</code> of a Prometheus object. The name of a <code>ServiceMonitor</code> is encoded in the Prometheus configuration, so you can simply grep whether it is present there. The configuration generated by the Prometheus Operator is stored in a Kubernetes <code>Secret</code>, named after the Prometheus object name prefixed with <code>prometheus-</code> and is located in the same namespace as the Prometheus object. For example for a Prometheus object called <code>k8s</code> one can find out if the <code>ServiceMonitor</code> named <code>my-service-monitor</code> has been picked up with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n monitoring get secret prometheus-k8s -ojson | jq -r &#39;.data[&quot;prometheus.yaml.gz&quot;]&#39; | base64 -d | gunzip | grep &quot;my-service-monitor&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Prometheus-kubelet-metrics-server-returned-HTTP-status-403-Forbidden"><a href="#Prometheus-kubelet-metrics-server-returned-HTTP-status-403-Forbidden" class="headerlink" title="Prometheus kubelet metrics server returned HTTP status 403 Forbidden"></a>Prometheus kubelet metrics server returned HTTP status 403 Forbidden</h3><p>Prometheus is installed, all looks good, however the <code>Targets</code> are all showing as down. All permissions seem to be good, yet no joy. Prometheus pulling metrics from all namespaces expect kube-system, and Prometheus has access to all namespaces including kube-system.</p>
<h4 id="Did-you-check-the-webhooks"><a href="#Did-you-check-the-webhooks" class="headerlink" title="Did you check the webhooks?"></a>Did you check the webhooks?</h4><p>Issue has been resolved by amending the webhooks to use <code>0.0.0.0</code> instead of <code>127.0.0.1</code>. Follow the below commands and it will update the webhooks which allows connections to all <code>clusterIP&#39;s</code>  in all <code>namespaces</code> and not just <code>127.0.0.1</code>.</p>
<p><strong>Update the kubelet service to include webhook and restart:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">KUBEADM_SYSTEMD_CONF&#x3D;&#x2F;etc&#x2F;systemd&#x2F;system&#x2F;kubelet.service.d&#x2F;10-kubeadm.conf</span><br><span class="line">sed -e &quot;&#x2F;cadvisor-port&#x3D;0&#x2F;d&quot; -i &quot;$KUBEADM_SYSTEMD_CONF&quot;</span><br><span class="line">if ! grep -q &quot;authentication-token-webhook&#x3D;true&quot; &quot;$KUBEADM_SYSTEMD_CONF&quot;; then</span><br><span class="line">  sed -e &quot;s&#x2F;--authorization-mode&#x3D;Webhook&#x2F;--authentication-token-webhook&#x3D;true --authorization-mode&#x3D;Webhook&#x2F;&quot; -i &quot;$KUBEADM_SYSTEMD_CONF&quot;</span><br><span class="line">fi</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>

<p><strong>Modify the kube controller and kube scheduler to allow for reading data:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -e &quot;s&#x2F;- --address&#x3D;127.0.0.1&#x2F;- --address&#x3D;0.0.0.0&#x2F;&quot; -i &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-controller-manager.yaml</span><br><span class="line">sed -e &quot;s&#x2F;- --address&#x3D;127.0.0.1&#x2F;- --address&#x3D;0.0.0.0&#x2F;&quot; -i &#x2F;etc&#x2F;kubernetes&#x2F;manifests&#x2F;kube-scheduler.yaml</span><br></pre></td></tr></table></figure>

<h3 id="Using-textual-port-number-instead-of-port-name"><a href="#Using-textual-port-number-instead-of-port-name" class="headerlink" title="Using textual port number instead of port name"></a>Using textual port number instead of port name</h3><p>The ServiceMonitor expects to use the port name as defined on the Service. So, using the Service example from the<br>diagram above, we have this Service definition:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: my-app</span><br><span class="line">  name: my-app</span><br><span class="line">...</span><br><span class="line">  spec:</span><br><span class="line">    ports:</span><br><span class="line">      - name: metrics</span><br><span class="line">        port: 8080</span><br><span class="line">    selector:</span><br><span class="line">      k8s-app: my-app</span><br></pre></td></tr></table></figure>

<p>We would then define the service monitor using <code>metrics</code> as the port not <code>&quot;8080&quot;</code>. E.g.</p>
<p><strong>CORRECT</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">spec:</span><br><span class="line">...</span><br><span class="line">  endpoints:</span><br><span class="line">    - port: metrics</span><br></pre></td></tr></table></figure>

<p><strong>INCORRECT</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">spec:</span><br><span class="line">...</span><br><span class="line">  endpoints:</span><br><span class="line">    - port: &quot;8080&quot;</span><br></pre></td></tr></table></figure>

<p>The incorrect example will give an error along these lines <code>spec.endpoints.port in body must be of type string: &quot;integer&quot;</code></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/thanos"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/thanos/" class="article-date">
  <time datetime="2020-12-12T13:30:47.215Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Thanos-and-the-Prometheus-Operator"><a href="#Thanos-and-the-Prometheus-Operator" class="headerlink" title="Thanos and the Prometheus Operator"></a>Thanos and the Prometheus Operator</h1><p><em>Note: This guide is valid for Prometheus Operator v0.28+ and Thanos v0.2+ and above.</em></p>
<p><a target="_blank" rel="noopener" href="https://github.com/thanos-io/thanos/">Thanos</a> is a set of components that can be composed into a highly available,<br>multi Prometheus metric system with potentially unlimited storage capacity, if your Object Storage allows for it.</p>
<p>Before continuing with Prometheus Operator Thanos integration, it is recommended to read more about Thanos in the <a target="_blank" rel="noopener" href="https://thanos.io/getting-started.md/">documentation</a>.</p>
<h2 id="What-Prometheus-Operator-helps-with"><a href="#What-Prometheus-Operator-helps-with" class="headerlink" title="What Prometheus Operator helps with?"></a>What Prometheus Operator helps with?</h2><p>Prometheus Operator operates <code>Prometheus</code> and optionally <code>ThanosRuler</code> components.<br>Other Thanos components, such as the querier and store gateway, must be configured<br>separately.  The Thanos system integrates with Prometheus by adding a Thanos<br>sidecar to each Prometheus instance.  The Thanos sidecar can be configured directly in the <code>Prometheus</code> CRD. This Sidecar can hook into the Thanos querying system as well as <strong>optionally</strong> back up your data in object storage.</p>
<p>Each component other than the sidecar and <code>ThanosRuler</code> is deployed independently of the Prometheus Operator and its Thanos configuration. The<br><a target="_blank" rel="noopener" href="https://github.com/thanos-io/kube-thanos/">kube-thanos</a> project has some starting points for other Thanos components deployments.</p>
<p>In short, for the Thanos integration using the Prometheus Operator to work correctly you will need to have these extra components installed and configured.</p>
<h2 id="Prometheus-Custom-Resource-with-Thanos-Sidecar"><a href="#Prometheus-Custom-Resource-with-Thanos-Sidecar" class="headerlink" title="Prometheus Custom Resource with Thanos Sidecar"></a>Prometheus Custom Resource with Thanos Sidecar</h2><p>The <code>Prometheus</code> CRD has support for adding a Thanos sidecar to the Prometheus<br>Pod. To enable the sidecar, reference the following examples.</p>
<p>This is the simplest configuration change that needs to be made to your<br>Prometheus Custom Resource, after creating the secret.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  ...</span><br><span class="line">  thanos:</span><br><span class="line">    baseImage: quay.io&#x2F;thanos&#x2F;thanos</span><br><span class="line">    version: v0.8.1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Note: If you’re using Istio you may need to also set <code>ListenLocal</code> on the Thanos spec due to Istio’s forwarding of traffic to localhost.</p>
<h2 id="Configuring-Thanos-Object-Storage"><a href="#Configuring-Thanos-Object-Storage" class="headerlink" title="Configuring Thanos Object Storage"></a>Configuring Thanos Object Storage</h2><p>If you want sidecar to be able to upload blocks to object storage you need to tell Prometheus Operator about it.</p>
<p>In this mode, sidecar assumes an existing Kubernetes Secret containing the Thanos configuration.<br>Inside this secret you configure how to run Thanos with your object storage.</p>
<p>For more information and examples about the configuration itself, take a look at the Thanos documentation:<br><a target="_blank" rel="noopener" href="https://github.com/thanos-io/thanos/blob/master/docs/storage.md">https://github.com/thanos-io/thanos/blob/master/docs/storage.md</a></p>
<p>Once you have written your configuration save it to a file.<br>Here’s an example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">type:</span> <span class="string">s3</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">bucket:</span> <span class="string">thanos</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">ams3.digitaloceanspaces.com</span></span><br><span class="line">  <span class="attr">access_key:</span> <span class="string">XXX</span></span><br><span class="line">  <span class="attr">secret_key:</span> <span class="string">XXX</span></span><br></pre></td></tr></table></figure>

<p>Let’s assume you saved this file to <code>/tmp/thanos-config.yaml</code>. You can use the following command to create a secret called <code>thanos-objstore-config</code> inside your cluster in the <code>monitoring</code> namespace.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n monitoring create secret generic thanos-objstore-config --from-file&#x3D;thanos.yaml&#x3D;&#x2F;tmp&#x2F;thanos-config.yaml</span><br></pre></td></tr></table></figure>

<p>And then you can specify this secret inside Thanos part of the Prometheus CRD we mentioned <a href="#prometheus-custom-resource-with-thanos-sidecar">earlier</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  ...</span><br><span class="line">  thanos:</span><br><span class="line">    baseImage: quay.io&#x2F;thanos&#x2F;thanos</span><br><span class="line">    version: v0.8.1</span><br><span class="line">    objectStorageConfig:</span><br><span class="line">      key: thanos.yaml</span><br><span class="line">      name: thanos-objstore-config</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>This will attach Thanos sidecar that will backup all <em>new blocks</em> that Prometheus produces every 2 hours to the object storage.</p>
<p>NOTE: This option will also disable local Prometheus compaction. This means that Thanos compactor is the main singleton component<br>responsible for compactions on a global, object storage level.</p>
<h2 id="Thanos-Ruler"><a href="#Thanos-Ruler" class="headerlink" title="Thanos Ruler"></a>Thanos Ruler</h2><p>The <a target="_blank" rel="noopener" href="https://github.com/thanos-io/thanos/blob/master/docs/components/rule.md">Thanos Ruler</a> component allows recording and alerting rules to be processed across<br>multiple Promtheus instances.  A <code>ThanosRuler</code> instance requires at least one <code>queryEndpoint</code> which points to the location of Thanos Queriers or Prometheus instances.  The <code>queryEndpoints</code> are used to configure the <code>--query</code> arguments(s) of the Thanos runtime.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">apiVersion: monitoring.coreos.com&#x2F;v1</span><br><span class="line">kind: ThanosRuler</span><br><span class="line">metadata:</span><br><span class="line">  name: thanos-ruler-demo</span><br><span class="line">  labels:</span><br><span class="line">    example: thanos-ruler</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  image: quay.io&#x2F;thanos&#x2F;thanos</span><br><span class="line">  ruleSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      role: my-thanos-rules</span><br><span class="line">  queryEndpoints:</span><br><span class="line">    - dnssrv+_http._tcp.my-thanos-querier.monitoring.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>The recording and alerting rules used by a <code>ThanosRuler</code> component, are configured using the same <code>PrometheusRule</code> objects which are used by Prometheus.  In the given example, the rules contained in any <code>PrometheusRule</code> object which match the label <code>role=my-thanos-rules</code> will be added to the Thanos Ruler POD.</p>
<h2 id="Other-Thanos-Components"><a href="#Other-Thanos-Components" class="headerlink" title="Other Thanos Components"></a>Other Thanos Components</h2><p>Deploying the sidecar was the first step towards getting Thanos up and running, but there are more components to be deployed, that complete Thanos:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://thanos.io/components/query.md/">Querier</a></li>
</ul>
<p>Additionally, when object storage backup is desired:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://thanos.io/components/store.md/">Store</a></li>
<li><a target="_blank" rel="noopener" href="https://thanos.io/components/compact.md/">Compactor</a></li>
</ul>
<p>Again, take a look at the Thanos documentation for more details on these components: <a target="_blank" rel="noopener" href="https://thanos.io/quick-tutorial.md">https://thanos.io/quick-tutorial.md</a></p>
<p>kube-thanos project has already supported several thanos components.<br>For more details, please checkout <a target="_blank" rel="noopener" href="https://github.com/thanos-io/kube-thanos/">kube-thanos</a>.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/rbac"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/rbac/" class="article-date">
  <time datetime="2020-12-12T13:30:47.208Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.
</div>

<h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>RBAC for the Prometheus Operator involves two parts, RBAC rules for the Operator itself and RBAC rules for the Prometheus Pods themselves created by the Operator as Prometheus requires access to the Kubernetes API for target and Alertmanager discovery.</p>
<h2 id="Prometheus-Operator-RBAC"><a href="#Prometheus-Operator-RBAC" class="headerlink" title="Prometheus Operator RBAC"></a>Prometheus Operator RBAC</h2><p>In order for the Prometheus Operator to work in an RBAC based authorization environment, a <code>ClusterRole</code> with access to all the resources the Operator requires for the Kubernetes API needs to be created. This section is intended to describe, why the specified rules are required.</p>
<p>Here is a ready to use manifest of a <code>ClusterRole</code> that can be used to start the Prometheus Operator:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v0.39.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alertmanagers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alertmanagers/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheuses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheuses/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">thanosrulers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">thanosrulers/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">servicemonitors</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">podmonitors</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheusrules</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: A cluster admin is required to create this <code>ClusterRole</code> and create a <code>ClusterRoleBinding</code> or <code>RoleBinding</code> to the <code>ServiceAccount</code> used by the Prometheus Operator <code>Pod</code>. The <code>ServiceAccount</code> used by the Prometheus Operator <code>Pod</code> can be specified in the <code>Deployment</code> object used to deploy it.</p>
</blockquote>
<p>When the Prometheus Operator boots up for the first time it registers the <code>customresourcedefinitions</code> it uses, therefore the <code>create</code> action on those is required.</p>
<p>As the Prometheus Operator works extensively with the <code>customresourcedefinitions</code> it registers, it requires all actions on those objects. Those are:</p>
<ul>
<li><code>alertmanagers</code></li>
<li><code>prometheuses</code></li>
<li><code>servicemonitors</code></li>
</ul>
<p>Alertmanager and Prometheus clusters are created using <code>statefulsets</code> therefore all changes to an Alertmanager or Prometheus object result in a change to the <code>statefulsets</code>, which means all actions must be permitted.</p>
<p>Additionally as the Prometheus Operator takes care of generating configurations for Prometheus to run, it requires all actions on <code>configmaps</code>.</p>
<p>When the Prometheus Operator performs version migrations from one version of Prometheus or Alertmanager to the other it needs to <code>list</code> <code>pods</code> running an old version and <code>delete</code> those.</p>
<p>The Prometheus Operator reconciles <code>services</code> called <code>prometheus-operated</code> and <code>alertmanager-operated</code>, which are used as governing <code>Service</code>s for the <code>StatefulSet</code>s. To perform this reconciliation</p>
<p>As the kubelet is currently not self-hosted, the Prometheus Operator has a feature to synchronize the IPs of the kubelets into an <code>Endpoints</code> object, which requires access to <code>list</code> and <code>watch</code> of <code>nodes</code> (kubelets) and <code>create</code> and <code>update</code> for <code>endpoints</code>.</p>
<h2 id="Prometheus-RBAC"><a href="#Prometheus-RBAC" class="headerlink" title="Prometheus RBAC"></a>Prometheus RBAC</h2><p>The Prometheus server itself accesses the Kubernetes API to discover targets and Alertmanagers. Therefore a separate <code>ClusterRole</code> for those Prometheus servers needs to exist.</p>
<p>As Prometheus does not modify any Objects in the Kubernetes API, but just reads them it simply requires the <code>get</code>, <code>list</code>, and <code>watch</code> actions. As Prometheus can also be used to scrape metrics from the Kubernetes apiserver, it also requires access to the <code>/metrics/</code> endpoint of it.</p>
<p>In addition to the resources Prometheus itself needs to access, the Prometheus side-car needs to be able to <code>get</code> configmaps to be able to pull in rule files from configmap objects.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> [<span class="string">&quot;/metrics&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note: A cluster admin is required to create this <code>ClusterRole</code> and create a <code>ClusterRoleBinding</code> or <code>RoleBinding</code> to the <code>ServiceAccount</code> used by the Prometheus <code>Pod</code>s.  The <code>ServiceAccount</code> used by the Prometheus <code>Pod</code>s can be specified in the <code>Prometheus</code> object.</p>
</blockquote>
<h2 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h2><p>To demonstrate how to use a <code>ClusterRole</code> with a <code>ClusterRoleBinding</code> and a <code>ServiceAccount</code> here an example. It is assumed, that both of the <code>ClusterRole</code>s described above are already created.</p>
<p>Say the Prometheus Operator shall be deployed in the <code>default</code> namespace. First a <code>ServiceAccount</code> needs to be setup.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v0.39.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<p>Note that the <code>ServiceAccountName</code> also has to actually be used in the <code>PodTemplate</code> of the <code>Deployment</code> of the Prometheus Operator.</p>
<p>And then a <code>ClusterRoleBinding</code>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v0.39.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<p>Because the <code>Pod</code> that the Prometheus Operator is running in uses the <code>ServiceAccount</code> named <code>prometheus-operator</code> and the <code>RoleBinding</code> associates it with the <code>ClusterRole</code> named <code>prometheus-operator</code> it now has permission to access all the resources as described above.</p>
<p>When creating <code>Prometheus</code> objects the procedure is similar. It starts with a <code>ServiceAccount</code>.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br></pre></td></tr></table></figure>

<p>And then because the <code>ClusterRole</code> named <code>prometheus</code>, as described above, is likely to be used multiple times, a <code>ClusterRoleBinding</code> instead of a <code>RoleBinding</code> is used.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>See <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/access-authn-authz/authorization/">Using Authorization Plugins</a> for further usage information on RBAC components.</p>
</blockquote>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/Documentation/high-availability"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/Documentation/high-availability/" class="article-date">
  <time datetime="2020-12-12T13:30:47.187Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <br>
<div class="alert alert-info" role="alert">
    <i class="fa fa-exclamation-triangle"></i><b> Note:</b> Starting with v0.12.0, Prometheus Operator requires use of Kubernetes v1.7.x and up.
</div>

<h1 id="High-Availability"><a href="#High-Availability" class="headerlink" title="High Availability"></a>High Availability</h1><p>High availability is not only important for customer facing software, but if the monitoring infrastructure is not highly available, then there is a risk that operations people are not notified for alerts of the customer facing software. Therefore high availability must be just as thought through for the monitoring stack, as for anything else.</p>
<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>To run Prometheus in a highly available manner, two (or more) instances need to be running with the same configuration, that means they scrape the same targets, which in turn means they will have the same data in memory and on disk, which in turn means they are answering requests the same way. In reality this is not entirely true, as the scrape cycles can be slightly different, and therefore the recorded data can be slightly different. This means that single requests can differ slightly. For alert evaluation this situation does not change anything, as alerts are typically only fired when a certain query triggers for a period of time. For dashboarding this means sticky sessions (using <code>sessionAffinity</code> on a Kubernetes <code>Service</code>) should be used, to get consistent graphs when refreshing.</p>
<p>What all of the above means for Prometheus is that there is a problem when a single Prometheus instance is not able to scrape the entire infrastructure anymore. This is where Prometheus’ sharding feature comes into play. It divides the targets Prometheus scrapes into multiple groups, small enough for a single Prometheus instance to scrape. If possible functional sharding is recommended. What is meant by functional sharding is that all instances of Service A are being scraped by Prometheus A. When functional sharding is not enough anymore, Prometheus is also able to perform sharding automatically which is easier but also has other effects that need to be taken into account. Single shards of Prometheus can be run highly available as described before. To be able to query all data, Prometheus federation can be used to fan in the relevant data to perform queries and alerting, which is only necessary if these queries actually need data from multiple shards.</p>
<p>One of the goals with the Prometheus Operator is that we want to completely automate sharding and federation. We are currently implementing some of the groundwork to make this possible, and figuring out the best approach to do so, but it is definitely on the roadmap!</p>
<h2 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h2><p>The final step of the high availability scheme between Prometheus and Alertmanager is that Prometheus, when an alert triggers, actually fires alerts against <em>all</em> instances of an Alertmanager cluster. Prometheus can discover all Alertmanagers through the Kubernetes API.</p>
<p>The Alertmanager, starting with the <code>v0.5.0</code> release, ships with a high availability mode. It implements a gossip protocol to synchronize instances of an Alertmanager cluster regarding notifications that have been sent out, to prevent duplicate notifications. It is an AP (available and partition tolerant) system. Being an AP system, means that notifications are guaranteed to be sent at least once. </p>
<p>The Prometheus Operator ensures that Alertmanager clusters are properly configured to run highly available on Kubernetes, and allows easy configuration of Alertmanagers discovery for Prometheus.</p>
<h2 id="Exporters"><a href="#Exporters" class="headerlink" title="Exporters"></a>Exporters</h2><p>For exporters, high availability depends on the particular exporter. In the case of <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kube-state-metrics"><code>kube-state-metrics</code></a>, because it is effectively stateless, it is the same as running any other stateless service in a highly available manner. Simply run multiple replicas that are being load balanced. Key for this is that the backing service, in this case the Kubernetes apiserver is highly available, ensuring that the data source of <code>kube-state-metrics</code> is not a single point of failure.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2020
        <i class="ri-heart-fill heart_icon"></i> Nero
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo.png" alt="Nero 的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>