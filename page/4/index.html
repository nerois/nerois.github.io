<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="摇旗呐喊的热情,携光阴渐远去,人世间悲喜烂剧,昼夜轮播不停,纷飞的滥情男女,情仇爱恨别离,一代人终将老去，但总有人正年轻" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Nero 的个人博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/back4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Nero 的个人博客</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
        <img
          src="/images/logo.png"
          class="cover-logo"
          alt="Nero 的个人博客"
        />
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['摇旗呐喊的热情,携光阴渐远去,', '人世间悲喜烂剧,昼夜轮播不停,', '纷飞的滥情男女, 情仇爱恨别离,一代人终将老去，但总有人正年轻'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <article class="articles">
    
    
    
    
    <article
  id="post-Kube-prometheus-分解部署"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/"
    >prometheus-operator分解部署</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-05-13T03:14:26.000Z" itemprop="datePublished">2020-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/prometheus-operator/">prometheus-operator</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="分解部署"><a href="#分解部署" class="headerlink" title="分解部署"></a>分解部署</h1><ul>
<li>1 部署operator</li>
<li>2 部署K8S指标输出 相关</li>
<li>3 部署Prometheus实例</li>
<li>4 部署告警器</li>
<li>5 添加监控项</li>
<li>6 部署grafana</li>
<li>7 添加告警规则</li>
</ul>
<h2 id="1-部署operator"><a href="#1-部署operator" class="headerlink" title="1 部署operator"></a>1 部署operator</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拉取代码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/prometheus-operator/kube-prometheus.git</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分类资源清单</span></span><br><span class="line"><span class="built_in">cd</span> kube-prometheus/manifests</span><br><span class="line"><span class="comment">#创建目录用于分类</span></span><br><span class="line">mkdir &#123;prometheus,metrics,grafana,alertmanager,rules,serviceMonitor&#125;</span><br><span class="line"><span class="comment">#移动监控项相关清单到 serviceMonitor</span></span><br><span class="line">mv *serviceMonitor*.yaml serviceMonitor </span><br><span class="line"><span class="comment">#移动告警规则相关到 rules目录</span></span><br><span class="line">mv *rules*.yaml rules </span><br><span class="line"><span class="comment">#移动prometheus 实例相关清单到 prometheus目录</span></span><br><span class="line">mv prometheus*.yaml  prometheus</span><br><span class="line"><span class="comment">#移动指标输出相关清单到 metrics 目录</span></span><br><span class="line">mv kube-state-metrics-*.yaml metrics </span><br><span class="line">mv node-exporter-* metrics</span><br><span class="line"><span class="comment">#移动grafana相关清单到 grafana 目录</span></span><br><span class="line">mv grafana*.yaml grafana</span><br><span class="line"><span class="comment">#移动告警器相关到 alertmanager 目录</span></span><br><span class="line">mv alertmanager*.yaml alertmanager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  tree</span><br><span class="line">.</span><br><span class="line">├── alertmanager</span><br><span class="line">│   ├── alertmanager-alertmanager.yaml</span><br><span class="line">│   ├── alertmanager-secret.yaml</span><br><span class="line">│   ├── alertmanager-serviceAccount.yaml</span><br><span class="line">│   └── alertmanager-service.yaml</span><br><span class="line">├── grafana</span><br><span class="line">│   ├── grafana-dashboardDatasources.yaml</span><br><span class="line">│   ├── grafana-dashboardDefinitions.yaml</span><br><span class="line">│   ├── grafana-dashboardSources.yaml</span><br><span class="line">│   ├── grafana-deployment.yaml</span><br><span class="line">│   ├── grafana-serviceAccount.yaml</span><br><span class="line">│   └── grafana-service.yaml</span><br><span class="line">├── metrics</span><br><span class="line">│   ├── kube-state-metrics-clusterRoleBinding.yaml</span><br><span class="line">│   ├── kube-state-metrics-clusterRole.yaml</span><br><span class="line">│   ├── kube-state-metrics-deployment.yaml</span><br><span class="line">│   ├── kube-state-metrics-serviceAccount.yaml</span><br><span class="line">│   ├── kube-state-metrics-service.yaml</span><br><span class="line">│   ├── node-exporter-clusterRoleBinding.yaml</span><br><span class="line">│   ├── node-exporter-clusterRole.yaml</span><br><span class="line">│   ├── node-exporter-daemonset.yaml</span><br><span class="line">│   ├── node-exporter-serviceAccount.yaml</span><br><span class="line">│   └── node-exporter-service.yaml</span><br><span class="line">├── prometheus</span><br><span class="line">│   ├── prometheus-adapter-apiService.yaml</span><br><span class="line">│   ├── prometheus-adapter-clusterRoleAggregatedMetricsReader.yaml</span><br><span class="line">│   ├── prometheus-adapter-clusterRoleBindingDelegator.yaml</span><br><span class="line">│   ├── prometheus-adapter-clusterRoleBinding.yaml</span><br><span class="line">│   ├── prometheus-adapter-clusterRoleServerResources.yaml</span><br><span class="line">│   ├── prometheus-adapter-clusterRole.yaml</span><br><span class="line">│   ├── prometheus-adapter-configMap.yaml</span><br><span class="line">│   ├── prometheus-adapter-deployment.yaml</span><br><span class="line">│   ├── prometheus-adapter-roleBindingAuthReader.yaml</span><br><span class="line">│   ├── prometheus-adapter-serviceAccount.yaml</span><br><span class="line">│   ├── prometheus-adapter-service.yaml</span><br><span class="line">│   ├── prometheus-clusterRoleBinding.yaml</span><br><span class="line">│   ├── prometheus-clusterRole.yaml</span><br><span class="line">│   ├── prometheus-prometheus.yaml</span><br><span class="line">│   ├── prometheus-roleBindingConfig.yaml</span><br><span class="line">│   ├── prometheus-roleBindingSpecificNamespaces.yaml</span><br><span class="line">│   ├── prometheus-roleConfig.yaml</span><br><span class="line">│   ├── prometheus-roleSpecificNamespaces.yaml</span><br><span class="line">│   ├── prometheus-serviceAccount.yaml</span><br><span class="line">│   └── prometheus-service.yaml</span><br><span class="line">├── rules</span><br><span class="line">│   └── prometheus-rules.yaml</span><br><span class="line">├── serviceMonitor</span><br><span class="line">│   ├── alertmanager-serviceMonitor.yaml</span><br><span class="line">│   ├── grafana-serviceMonitor.yaml</span><br><span class="line">│   ├── kube-state-metrics-serviceMonitor.yaml</span><br><span class="line">│   ├── node-exporter-serviceMonitor.yaml</span><br><span class="line">│   ├── prometheus-adapter-serviceMonitor.yaml</span><br><span class="line">│   ├── prometheus-operator-serviceMonitor.yaml</span><br><span class="line">│   ├── prometheus-serviceMonitorApiserver.yaml</span><br><span class="line">│   ├── prometheus-serviceMonitorCoreDNS.yaml</span><br><span class="line">│   ├── prometheus-serviceMonitorKubeControllerManager.yaml</span><br><span class="line">│   ├── prometheus-serviceMonitorKubelet.yaml</span><br><span class="line">│   ├── prometheus-serviceMonitorKubeScheduler.yaml</span><br><span class="line">│   └── prometheus-serviceMonitor.yaml</span><br><span class="line">└── setup</span><br><span class="line">    ├── 0namespace-namespace.yaml</span><br><span class="line">    ├── prometheus-operator-0alertmanagerConfigCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0alertmanagerCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0podmonitorCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0probeCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0prometheusCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0prometheusruleCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0servicemonitorCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-0thanosrulerCustomResourceDefinition.yaml</span><br><span class="line">    ├── prometheus-operator-clusterRoleBinding.yaml</span><br><span class="line">    ├── prometheus-operator-clusterRole.yaml</span><br><span class="line">    ├── prometheus-operator-deployment.yaml</span><br><span class="line">    ├── prometheus-operator-serviceAccount.yaml</span><br><span class="line">    └── prometheus-operator-service.yaml</span><br><span class="line"></span><br><span class="line">7 directories, 67 files</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#部署operator</span></span><br><span class="line">kubectl apply -f setup/</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  kubectl get pod -n monitoring</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-operator-78d4d97f4d-gmzrc   2/2     Running   0          26s</span><br></pre></td></tr></table></figure>

<h2 id="2-部署K8S指标输出-相关"><a href="#2-部署K8S指标输出-相关" class="headerlink" title="2 部署K8S指标输出 相关"></a>2 部署K8S指标输出 相关</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f metrics/ </span><br><span class="line"></span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  kubectl get pod -n monitoring </span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-state-metrics-6558dbd5b4-ksldp    3/3     Running   0          11s</span><br><span class="line">node-exporter-h7lbd                    2/2     Running   0          9s</span><br><span class="line">node-exporter-jlvpq                    2/2     Running   0          9s</span><br><span class="line">node-exporter-sp2tw                    2/2     Running   0          9s</span><br><span class="line">node-exporter-zpqv7                    2/2     Running   0          9s</span><br><span class="line">prometheus-operator-78d4d97f4d-gmzrc   2/2     Running   0          5m9s</span><br></pre></td></tr></table></figure>

<h2 id="3-部署Prometheus实例"><a href="#3-部署Prometheus实例" class="headerlink" title="3 部署Prometheus实例"></a>3 部署Prometheus实例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim prometheus/prometheus-prometheus.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 添加此条 设定数据最大保存时间</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">7d</span></span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="comment">#这里的告警器名称 要与之后创建的告警器相同才能自动关联</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-main</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.io/prometheus/prometheus:v2.22.1</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">podMonitorNamespaceSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">podMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">probeNamespaceSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">probeSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="comment">#实例数量 默认为2 这里改为1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="comment">#资源限制</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">  <span class="attr">ruleSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">k8s</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">alert-rules</span></span><br><span class="line">  <span class="attr">securityContext:</span></span><br><span class="line">    <span class="attr">fsGroup:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus-k8s</span></span><br><span class="line">  <span class="attr">serviceMonitorNamespaceSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.22.1</span></span><br><span class="line">  <span class="comment">#添加持久存储</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">cephfs</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">40Gi</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#部署</span></span><br><span class="line">kubectl apply -f prometheus</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  kubectl get pod -n monitoring </span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-state-metrics-6558dbd5b4-ksldp    3/3     Running   0          13m</span><br><span class="line">node-exporter-h7lbd                    2/2     Running   0          13m</span><br><span class="line">node-exporter-jlvpq                    2/2     Running   0          13m</span><br><span class="line">node-exporter-sp2tw                    2/2     Running   0          13m</span><br><span class="line">node-exporter-zpqv7                    2/2     Running   0          13m</span><br><span class="line">prometheus-adapter-5dbb4cb95f-qxxvh    1/1     Running   0          2m10s</span><br><span class="line">prometheus-k8s-0                       2/2     Running   1          2m9s</span><br><span class="line">prometheus-operator-78d4d97f4d-gmzrc   2/2     Running   0          18m</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#暴露</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  name: prometheus-k8s-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: mon.sp.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: prometheus-k8s</span><br><span class="line">              servicePort: 9090</span><br><span class="line">            path: /</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201217173327725.png" alt="image-20201217173327725"></p>
<h2 id="4-部署告警器"><a href="#4-部署告警器" class="headerlink" title="4 部署告警器"></a>4 部署告警器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除自带secret 此文件用于生成告警器配置文件</span></span><br><span class="line">rm -rf alertmanager/alertmanager-secret.yaml </span><br><span class="line"><span class="comment">#配置告警器清单 vim alertmanager/alertmanager-alertmanager.yaml</span></span><br><span class="line"></span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: Alertmanager</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    alertmanager: main</span><br><span class="line">  <span class="comment">#告警器名称后缀 全名为 alertmanager-main 名字应该与标签相符</span></span><br><span class="line">  name: main</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  image: quay.io/prometheus/alertmanager:v0.21.0</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: linux</span><br><span class="line">  <span class="comment">#副本数量 默认3  这里改1</span></span><br><span class="line">  replicas: 1</span><br><span class="line">  securityContext:</span><br><span class="line">    fsGroup: 2000</span><br><span class="line">    runAsNonRoot: <span class="literal">true</span></span><br><span class="line">    runAsUser: 1000</span><br><span class="line">  serviceAccountName: alertmanager-main</span><br><span class="line">  version: v0.21.0</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#部署 无配置的告警器</span></span><br><span class="line">kubectl apply -f alertmanager/ </span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  kubectl get pod -n monitoring</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">alertmanager-main-0                    2/2     Running   0          19s</span><br><span class="line">kube-state-metrics-6558dbd5b4-ksldp    3/3     Running   0          30m</span><br><span class="line">node-exporter-h7lbd                    2/2     Running   0          30m</span><br><span class="line">node-exporter-jlvpq                    2/2     Running   0          30m</span><br><span class="line">node-exporter-sp2tw                    2/2     Running   0          30m</span><br><span class="line">node-exporter-zpqv7                    2/2     Running   0          30m</span><br><span class="line">prometheus-adapter-5dbb4cb95f-qxxvh    1/1     Running   0          18m</span><br><span class="line">prometheus-k8s-0                       2/2     Running   1          18m</span><br><span class="line">prometheus-operator-78d4d97f4d-gmzrc   2/2     Running   0          35m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ingress暴露</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  name: alertmanager-main-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: alt.sp.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: alertmanager-main</span><br><span class="line">              servicePort: 9093</span><br><span class="line">            path: /</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201217175025560.png" alt="image-20201217175025560"></p>
<h2 id="5-添加监控项"><a href="#5-添加监控项" class="headerlink" title="5 添加监控项"></a>5 添加监控项</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加自带的监控项</span></span><br><span class="line">kubectl apply -f serviceMonitor/ </span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201217190726721.png" alt="image-20201217190726721"></p>
<h3 id="分析kube-controll-manager-和-kube-scheduler-监控项没有被发现的问题"><a href="#分析kube-controll-manager-和-kube-scheduler-监控项没有被发现的问题" class="headerlink" title="分析kube-controll-manager 和 kube-scheduler  监控项没有被发现的问题"></a>分析kube-controll-manager 和 kube-scheduler  监控项没有被发现的问题</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看原本的ServiceMonitor 文件 发现与预期不符</span></span><br><span class="line">╰─➤  cat prometheus-serviceMonitorKubeScheduler.yaml</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    <span class="comment">#每30秒拉取一次指标</span></span><br><span class="line">    interval: 30s</span><br><span class="line">    port: https-metrics</span><br><span class="line">    scheme: https</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: <span class="literal">true</span></span><br><span class="line">  jobLabel: k8s-app</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - kube-system</span><br><span class="line">  <span class="comment">#通过标签匹配svc资源</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="修复kube-scheduler"><a href="#修复kube-scheduler" class="headerlink" title="修复kube-scheduler"></a>修复kube-scheduler</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http 方式</span></span><br><span class="line"><span class="comment"># 删除自带的 ServiceMonitor</span></span><br><span class="line">kubectl delete -f prometheus-serviceMonitorKubeScheduler.yaml</span><br><span class="line"><span class="comment">#导入自己的清档</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 10251</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 192.168.1.71</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 10251</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 30s</span><br><span class="line">    port: http-metrics</span><br><span class="line">    scheme: http</span><br><span class="line">  jobLabel: k8s-app</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - kube-system</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-scheduler</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201218143542703.png" alt="image-20201218143542703"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#https 方式</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: https-metrics</span><br><span class="line">    port: 10259</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: kube-system</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 192.168.1.71</span><br><span class="line">  ports:</span><br><span class="line">  - name: https-metrics</span><br><span class="line">    port: 10259</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-scheduler</span><br><span class="line">  name: kube-scheduler</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 30s</span><br><span class="line">    port: https-metrics</span><br><span class="line">    scheme: https</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: <span class="literal">true</span></span><br><span class="line">  jobLabel: k8s-app</span><br><span class="line">  namespaceSelector:</span><br><span class="line">    matchNames:</span><br><span class="line">    - kube-system</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-scheduler</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201218193010974.png" alt="image-20201218193010974"></p>
<h3 id="修复kube-controll-manager"><a href="#修复kube-controll-manager" class="headerlink" title="修复kube-controll-manager"></a>修复kube-controll-manager</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-controller-manager</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    component: kube-controller-manager</span><br><span class="line">  <span class="built_in">type</span>: ClusterIP</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: https-metrics</span><br><span class="line">    port: 10250</span><br><span class="line">    targetPort: 10250</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-controller-manager</span><br><span class="line">  name: kube-controller-manager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">subsets:</span><br><span class="line">- addresses:</span><br><span class="line">  - ip: 192.168.1.71</span><br><span class="line">  ports:</span><br><span class="line">  - name: https-metrics</span><br><span class="line">    port: 10250</span><br><span class="line">    protocol: TCP</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#目前有个问题 没办法解决 查便资料未果 就是 kube-system名称空间下的ep资源kube-controller-manager 在kube-controller-manager进程重启或者重新选举的时候会被清空</span></span><br><span class="line"><span class="comment">#尝试过 换其他空间 创建service 和ep  尝试过更换名称 都不起作用</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201218153412650.png" alt="image-20201218153412650"></p>
<h2 id="6-部署grafana"><a href="#6-部署grafana" class="headerlink" title="6 部署grafana"></a>6 部署grafana</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f grafana/ </span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">╰─➤  kubectl get pod -n monitoring </span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">alertmanager-main-0                    2/2     Running   0          118m</span><br><span class="line">grafana-675dbb6748-2qtzv               1/1     Running   0          20m</span><br><span class="line">kube-state-metrics-6558dbd5b4-ksldp    3/3     Running   0          148m</span><br><span class="line">node-exporter-h7lbd                    2/2     Running   0          148m</span><br><span class="line">node-exporter-jlvpq                    2/2     Running   0          148m</span><br><span class="line">node-exporter-sp2tw                    2/2     Running   0          148m</span><br><span class="line">node-exporter-zpqv7                    2/2     Running   0          148m</span><br><span class="line">prometheus-adapter-5dbb4cb95f-qxxvh    1/1     Running   0          137m</span><br><span class="line">prometheus-k8s-0                       2/2     Running   1          137m</span><br><span class="line">prometheus-operator-78d4d97f4d-gmzrc   2/2     Running   0          153m</span><br><span class="line"></span><br><span class="line"><span class="comment">#默认账号密码 admin  admin 第一次进入需要改密码</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/05/13/Kube-prometheus-%E5%88%86%E8%A7%A3%E9%83%A8%E7%BD%B2/image-20201217194732369.png" alt="image-20201217194732369"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ingress 暴露</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  name: grafana-ingress</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: grafana.sp.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: grafana</span><br><span class="line">              servicePort: 3000</span><br><span class="line">            path: /</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/prometheus-operator/" rel="tag">prometheus-operator</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-污点和容忍度"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/08/08/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6/"
    >污点和容忍度</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/08/08/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6/" class="article-date">
  <time datetime="2019-08-08T04:13:11.000Z" itemprop="datePublished">2019-08-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/K8S/">K8S</a> / <a class="article-category-link" href="/categories/K8S/%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D/">污点和容忍</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="污点"><a href="#污点" class="headerlink" title="污点"></a>污点</h1><h2 id="污点类型"><a href="#污点类型" class="headerlink" title="污点类型:"></a>污点类型:</h2><ul>
<li>NoSchedule ：一定不能被调度。</li>
<li>PreferNoSchedule：尽量不要调度。</li>
<li>NoExecute：不仅不会调度，还会驱逐Node上已有的Pod。</li>
</ul>
<h2 id="污点操作"><a href="#污点操作" class="headerlink" title="污点操作"></a>污点操作</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加污点</span></span><br><span class="line">kubectl taint nodes node1 key=value:NoSchedule </span><br><span class="line"><span class="comment">#删除污点 不用指定value 且在后面加上-即可</span></span><br><span class="line">kubectl taint nodes node1 key=:NoSchedule-</span><br><span class="line"><span class="comment">#查看污点</span></span><br><span class="line">kubectl describe nodes &#123;Node名称&#125;</span><br></pre></td></tr></table></figure>

<h1 id="容忍"><a href="#容忍" class="headerlink" title="容忍"></a>容忍</h1><h2 id="方式1"><a href="#方式1" class="headerlink" title="方式1"></a>方式1</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 容忍的 key、value 和对应 effect 也必须和污点 taints 保持一致</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;value&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="方式2"><a href="#方式2" class="headerlink" title="方式2"></a>方式2</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 容忍  key 和要污点 taints 的 key 一致，且设置的 effect 也相同，不需要设置 value</span></span><br><span class="line"><span class="comment">## 当 operator: &quot;Exists&quot;时  effect: 行可以省略 表示只要KEY匹配 就容忍</span></span><br><span class="line"><span class="comment">## 甚至如果你 key 和 effect 都不写 那么就是容忍任何污点</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#容忍任何污点写法</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="容忍时间"><a href="#容忍时间" class="headerlink" title="容忍时间"></a>容忍时间</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 当次pod 被驱逐时候 将延迟的的时间 单位秒</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="attr">tolerations:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">  <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">  <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure>

<h2 id="Deployment示例"><a href="#Deployment示例" class="headerlink" title="Deployment示例"></a>Deployment示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/vl</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">example</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">5</span> </span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">      <span class="string">......</span></span><br><span class="line">      <span class="attr">tolerations:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;key&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;value&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">        <span class="attr">tolerationSeconds:</span> <span class="number">3600</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S/" rel="tag">K8S</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-ingress-traefik"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/06/08/ingress-traefik/"
    >ingress-traefik</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/06/08/ingress-traefik/" class="article-date">
  <time datetime="2019-06-08T03:14:13.000Z" itemprop="datePublished">2019-06-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/K8S/">K8S</a> / <a class="article-category-link" href="/categories/K8S/ingress/">ingress</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="ingress-traefik"><a href="#ingress-traefik" class="headerlink" title="ingress-traefik"></a>ingress-traefik</h1><p><a target="_blank" rel="noopener" href="https://github.com/traefik/traefik/tree/v1.7">https://github.com/traefik/traefik/tree/v1.7</a></p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>部署文件在 <a target="_blank" rel="noopener" href="https://github.com/traefik/traefik/tree/v1.7/examples/k8s">https://github.com/traefik/traefik/tree/v1.7/examples/k8s</a> 但可能需要修改</p>
<p>通常daemonset 并且使用宿主机网络  方式运行ingress 通常会单独几个节点跑ingress pod 操作如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#给需要运行ingress的节点打标签</span></span><br><span class="line">kubectl label nodes k-n2.sp.com ingress=ok</span><br><span class="line"><span class="comment">#选择节点 以及使用宿主机网络</span></span><br><span class="line">...</span><br><span class="line">    spec:</span><br><span class="line">      <span class="comment">#使用宿主机网络</span></span><br><span class="line">      hostNetwork: <span class="literal">true</span></span><br><span class="line">      ...</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">		<span class="comment">#指定刚刚添加的标签</span></span><br><span class="line">        ingress: <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># traefik-ds.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">        <span class="comment">#添加这个标签 内容可以自己定义</span></span><br><span class="line">        <span class="attr">ingress:</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">traefik:v1.7</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="comment">#管理页面端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">hostPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">            <span class="attr">add:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">NET_BIND_SERVICE</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--api</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubernetes</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--logLevel=INFO</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubernetes.endpoint=https://192.168.1.71:6443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--accesslog</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--accesslog.filepath=/var/log/traefik_access.log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--traefiklog</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--traefiklog.filepath=/var/log/traefik.log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--metrics.prometheus</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- --kubernetes.endpoint=https://192.168.1.71:6443  <span class="comment">#暂时不清楚为什么这么做</span></span><br><span class="line">- --accesslog <span class="comment">#开启访问日志</span></span><br><span class="line">- --accesslog.filepath=/var/<span class="built_in">log</span>/traefik_access.log <span class="comment">#访问日志路径</span></span><br><span class="line">- --traefiklog <span class="comment">#开启traefik服务日志</span></span><br><span class="line">- --traefiklog.filepath=/var/<span class="built_in">log</span>/traefik.log <span class="comment">#日志路径</span></span><br><span class="line">- --metrics.prometheus <span class="comment">#开启prometheus 指标输出</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RBAC  traefik-rbac.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ingresses/status</span></span><br><span class="line">    <span class="attr">verbs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-ingress-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#发布到K8S</span></span><br><span class="line">kubectl apply -f traefik-rbac.yaml </span><br><span class="line">kubectl apply -f traefik-ds.yaml</span><br></pre></td></tr></table></figure>

<h1 id="部署ui-顺便验证ingress是否可用"><a href="#部署ui-顺便验证ingress是否可用" class="headerlink" title="部署ui 顺便验证ingress是否可用"></a>部署ui 顺便验证ingress是否可用</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ui.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="comment">#注意这里名称空间应该与后端pod在同一空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="comment">#注意这里名称空间应与被调度的service同一空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment">#这里的域名可修改</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">traefik-ui.sp.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">web</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<ol>
<li><strong>这里实际上定义了一个service 映射到了traefik自身的pod  然后定义了一个ingress规则映射到了此service</strong></li>
<li><strong>注意: ingress的资源 apiVersion: 有两个   networking.k8s.io/v1beta1 和 extensions/v1beta1</strong>  </li>
<li><strong>老版本只能使用extensions/v1beta1   新版本 目前测试1.18 两个都能用</strong></li>
</ol>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>确保刚刚定义的 traefik-ui.sp.com能够解析 流量能指向ingress</p>
<p><img src="/2019/06/08/ingress-traefik/image-20201130194236088.png" alt="image-20201130194236088"></p>
<h3 id="没定义-或没生效的效果"><a href="#没定义-或没生效的效果" class="headerlink" title="没定义  或没生效的效果"></a>没定义  或没生效的效果</h3><p><img src="/2019/06/08/ingress-traefik/image-20201130194333610.png" alt="image-20201130194333610"></p>
<h1 id="ingress-规则示例"><a href="#ingress-规则示例" class="headerlink" title="ingress 规则示例"></a>ingress 规则示例</h1><h2 id="通过资源路径映射不同的service"><a href="#通过资源路径映射不同的service" class="headerlink" title="通过资源路径映射不同的service"></a>通过资源路径映射不同的service</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cheeses</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment"># 对于在前端配置多个路径转发时，必须配置改选项</span></span><br><span class="line">    <span class="attr">traefik.frontend.rule.type:</span> <span class="string">PathPrefixStrip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment">#域名匹配 可以多个</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">cheeses.minikube</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># 访问资源路径匹配</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/stilton</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="comment">#映射对应service名称</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">stilton</span></span><br><span class="line">          <span class="comment">#映射对应的端口</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/cheddar</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">cheddar</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/wensleydale</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">wensleydale</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="使用basic验证"><a href="#使用basic验证" class="headerlink" title="使用basic验证"></a>使用basic验证</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成basic验证文件 yum -y install httpd 安装</span></span><br><span class="line">╰─➤  htpasswd -c ./auth user      </span><br><span class="line">New password: </span><br><span class="line">Re-type new password: </span><br><span class="line">Adding password <span class="keyword">for</span> user user</span><br><span class="line">╰─➤  cat auth </span><br><span class="line">user:<span class="variable">$apr1</span><span class="variable">$pBhP7Hah</span><span class="variable">$FyLin7z6d</span>/SVOqNsJ4s801</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建secret</span></span><br><span class="line">kubectl create secret generic mysecret --from-file auth --namespace=kube-system</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改刚刚的 ingress规则</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="comment">#注意这里名称空间应该与后端pod在同一空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">traefik-ingress-lb</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="comment">#注意这里名称空间应与被调度的service同一空间</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="comment">#使用traefik ingress</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line">    <span class="comment">#此规则启用basic认证</span></span><br><span class="line">    <span class="attr">ingress.kubernetes.io/auth-type:</span> <span class="string">&quot;basic&quot;</span></span><br><span class="line">    <span class="comment">#指定认证使用的secret 就是刚刚创建的那个</span></span><br><span class="line">    <span class="attr">ingress.kubernetes.io/auth-secret:</span> <span class="string">&quot;mysecret&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="comment">#这里的域名可修改</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">traefik-ui.sp.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">web</span></span><br></pre></td></tr></table></figure>

<p><img src="/2019/06/08/ingress-traefik/image-20201130201804260.png" alt="image-20201130201804260"></p>
<h2 id="自定义https证书"><a href="#自定义https证书" class="headerlink" title="自定义https证书"></a>自定义https证书</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建secert</span></span><br><span class="line">kubectl -n kube-system create secret tls traefik-ui-tls-cert --key=tls.key --cert=tls.crt</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#调用secert作为tls</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">traefik-ui.minikube</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">traefik-web-ui</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">traefik-ui-tls-cert</span></span><br></pre></td></tr></table></figure>

<h2 id="负载算法"><a href="#负载算法" class="headerlink" title="负载算法"></a>负载算法</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意这里是在service中配置</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/load-balancer-method:</span> <span class="string">drr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>这里支持多种负载均衡方法：<br>wrr: 加权轮询<br>drr: 动态轮询: 这会为表现比其他服务器好的服务器增加权重。当服务器表现有变化的时，它也会会退到正常权重。</p>
<h2 id="session-粘性"><a href="#session-粘性" class="headerlink" title="session 粘性"></a>session 粘性</h2><p><strong>所有的负载平衡器都支持粘滞会话(sticky sessions)。当粘滞会话被开启时，会有一个名称叫做_TRAEFIK_BACKEND的cookie在请求被初始化时被设置在请求初始化时。在随后的请求中，客户端会被直接转发到这个cookie中存储的后端（当然它要是健康可用的），如果这个后端不可用，将会指定一个新的后端。 开启的方法为添加<code>traefik.ingress.kubernetes.io/affinity: &quot;true&quot;</code> 的annotations</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/affinity:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/load-balancer-method:</span> <span class="string">drr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line"><span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="http-跳转-https"><a href="#http-跳转-https" class="headerlink" title="http 跳转 https"></a>http 跳转 https</h2><h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#目前没尝试过</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx05</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">traffic-type:</span> <span class="string">internal</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/redirect-entry-point:</span> <span class="string">https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ngx05.gxd88.cn</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h3 id="方法2"><a href="#方法2" class="headerlink" title="方法2"></a>方法2</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redirectdomain</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">traffic-type:</span> <span class="string">internal</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/redirect-permanent:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/redirect-regex:</span> <span class="string">^http://(.*)</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/redirect-replacement:</span> <span class="string">https://$1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">redirectdomain.gxd88.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/image</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="请求路径前添加路径"><a href="#请求路径前添加路径" class="headerlink" title="请求路径前添加路径"></a>请求路径前添加路径</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#请求ngx09.gxd88.cn/a 到后端服务为/api/a</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">addpath</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">traffic-type:</span> <span class="string">internal</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/request-modifier:</span> <span class="string">AddPrefix:/api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ngx09.gxd88.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/a</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="请求路径删除前缀"><a href="#请求路径删除前缀" class="headerlink" title="请求路径删除前缀"></a>请求路径删除前缀</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请求del.gxd88.cn/api/v1/1到后端为del.gxd88.cn/1</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deletepath01</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">traffic-type:</span> <span class="string">internal</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/rule-type:</span> <span class="string">PathPrefixStrip</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">del.gxd88.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api/v1</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h2 id="定义白名单"><a href="#定义白名单" class="headerlink" title="定义白名单"></a>定义白名单</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx03</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik-external</span></span><br><span class="line">    <span class="attr">ingress.kubernetes.io/whitelist-x-forwarded-for:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/whitelist-source-range:</span> <span class="string">&quot;10.40.0.227&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">ngx03.gxd88.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span> <span class="string">/api</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<h1 id="Annotate的配置详解"><a href="#Annotate的配置详解" class="headerlink" title="Annotate的配置详解"></a>Annotate的配置详解</h1><h3 id="1-通用配置"><a href="#1-通用配置" class="headerlink" title="1 通用配置"></a>1 通用配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ingress声明，这里声明了ingress后端采用traefik实现，而不是其他controller</span></span><br><span class="line">kubernetes.io/ingress.class: traefik</span><br><span class="line"><span class="comment"># 配置访问白名单，支持ipv4和ipv6</span></span><br><span class="line">ingress.kubernetes.io/whitelist-source-range: <span class="string">&quot;1.2.3.0/24, fe80::/16&quot;</span></span><br><span class="line"><span class="comment"># http认证模式，此处为basic模式</span></span><br><span class="line">ingress.kubernetes.io/auth-type: basic</span><br><span class="line"><span class="comment"># 调用认证用的secret</span></span><br><span class="line">ingress.kubernetes.io/auth-secret: mysecret</span><br></pre></td></tr></table></figure>

<h3 id="2前端配置"><a href="#2前端配置" class="headerlink" title="2前端配置"></a>2前端配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于在前端配置多个路径转发时，必须配置</span></span><br><span class="line">traefik.frontend.rule.type: PathPrefixStrip</span><br><span class="line"><span class="comment"># 配置前端的权重，值越高则优先匹配</span></span><br><span class="line">traefik.frontend.priority: <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="comment"># 关闭传入Hearder</span></span><br><span class="line">traefik.frontend.passHostHeader: <span class="string">&quot;false&quot;</span></span><br><span class="line"><span class="comment"># 使用https协议</span></span><br><span class="line">traefik.protocol=https</span><br><span class="line"><span class="comment"># 同时支持http和https</span></span><br><span class="line">traefik.frontend.entryPoints=http,https</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3后端配置"><a href="#3后端配置" class="headerlink" title="3后端配置"></a>3后端配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 负载均衡策略，目前traefik支持的策略包括：wrr（加权轮训调度算法）和drr（动态加权循环调度算法）</span></span><br><span class="line">traefik.backend.loadbalancer.method=drr</span><br><span class="line"><span class="comment"># 是否开启负载均衡器的session亲和性</span></span><br><span class="line">traefik.backend.loadbalancer.stickiness=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 手动配置后端session亲和性的cookie名称</span></span><br><span class="line">traefik.backend.loadbalancer.stickiness.cookieName=NAME</span><br></pre></td></tr></table></figure>

<h3 id="4健康探测"><a href="#4健康探测" class="headerlink" title="4健康探测"></a>4健康探测</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># traefik的监控检查路径</span></span><br><span class="line">traefik.backend.healthcheck.path=/health</span><br><span class="line"><span class="comment"># 健康检查的时间间隔</span></span><br><span class="line">traefik.backend.healthcheck.interval=5s</span><br><span class="line"><span class="comment"># 监测某台节点上的服务错误率达到50%时，自动下线该节点</span></span><br><span class="line">traefik.backend.circuitbreaker: <span class="string">&quot;NetworkErrorRatio() &gt; 0.5&quot;</span></span><br><span class="line"><span class="comment"># 监测某台节点上服务的延时大于50ms时，自动下线该节点。</span></span><br><span class="line">traefik.backend.circuitbreaker: <span class="string">&quot;LatencyAtQuantileMS(50.0) &gt; 50&quot;</span></span><br><span class="line"><span class="comment"># 监测某台节点上服务返回状态码为[500-600]在[0-600]区间占比超过50%时，自动下线该节点。</span></span><br><span class="line"></span><br><span class="line">traefik.backend.circuitbreaker: <span class="string">&quot;ResponseCodeRatio(500, 600, 0, 600) &gt; 0.5&quot;</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S/" rel="tag">K8S</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ingress/" rel="tag">ingress</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-2-二进制docker 和cni"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/26/2-%E4%BA%8C%E8%BF%9B%E5%88%B6docker%20%E5%92%8Ccni/"
    >2docekr和cni</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/26/2-%E4%BA%8C%E8%BF%9B%E5%88%B6docker%20%E5%92%8Ccni/" class="article-date">
  <time datetime="2019-05-26T04:12:57.000Z" itemprop="datePublished">2019-05-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/K8S%E9%83%A8%E7%BD%B2/">K8S部署</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="二进制docker"><a href="#二进制docker" class="headerlink" title="二进制docker"></a>二进制docker</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a target="_blank" rel="noopener" href="https://download.docker.com/linux/static/stable/x86_64/">https://download.docker.com/linux/static/stable/x86_64/</a></p>
<p>#这里下载 docker-19.03.14.tgz</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.14.tgz </span><br><span class="line"></span><br><span class="line">tar xf docker-19.03.14.tgz &amp;&amp; mv docker/* /usr/bin/ &amp;&amp; rm -rf docker*.tgz</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#unitfile</span></span><br><span class="line">cat &gt;/usr/lib/systemd/system/docker.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;PATH=/opt/kube/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;</span></span><br><span class="line">ExecStartPost=/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置</span></span><br><span class="line">mkdir -p /etc/docker/</span><br><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;data-root&quot;: &quot;/data/docker&quot;,</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [ &quot;native.cgroupdriver=cgroupfs&quot; ],</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [ &quot;https://docker.mirrors.ustc.edu.cn&quot;, &quot;http://hub-mirror.c.163.com&quot; ], </span></span><br><span class="line"><span class="string">  &quot;insecure-registries&quot;: [&quot;127.0.0.1/8&quot;],</span></span><br><span class="line"><span class="string">  &quot;max-concurrent-downloads&quot;: 10,</span></span><br><span class="line"><span class="string">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class="line"><span class="string">  &quot;log-level&quot;: &quot;warn&quot;,</span></span><br><span class="line"><span class="string">  &quot;log-opts&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;max-size&quot;: &quot;15m&quot;,</span></span><br><span class="line"><span class="string">    &quot;max-file&quot;: &quot;3&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">mkdir -p /data/docker/ &amp;&amp; \</span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl <span class="built_in">enable</span> docker &amp;&amp; systemctl start docker</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">docker info</span><br><span class="line"><span class="comment">#获取官方镜像 k8s.gcr.io/pause:3.1</span></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1</span><br></pre></td></tr></table></figure>

<h1 id="cni"><a href="#cni" class="headerlink" title="cni"></a>cni</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases</span><br><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;v0.8.1&#x2F;cni-plugins-linux-amd64-v0.8.1.tgz</span><br><span class="line">mkdir -p &#x2F;opt&#x2F;cni&#x2F;bin &amp;&amp; tar -xf cni-plugins-linux-amd64-v0.8.1.tgz  -C &#x2F;opt&#x2F;cni&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>



 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S%E9%83%A8%E7%BD%B2/" rel="tag">K8S部署</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-亲和性.反亲和性"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/%E4%BA%B2%E5%92%8C%E6%80%A7.%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7/"
    >亲和,反亲和</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/%E4%BA%B2%E5%92%8C%E6%80%A7.%E5%8F%8D%E4%BA%B2%E5%92%8C%E6%80%A7/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/K8S%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95/">K8S资源清单</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="亲和-反亲和"><a href="#亲和-反亲和" class="headerlink" title="亲和,反亲和"></a>亲和,反亲和</h2><p>pod的被调度时,我们可以定义是否允许 或 不允许调度到同一位置,被称为亲和性 和 反亲和性</p>
<p>所谓同一位置 通常是指 指定节点的一个标签的键  有相同键的节点即认为是同一位置,</p>
<p>在我们规划集群时候,通常会精心规划节点标签 来标识位置,如 机房 机柜 甚至 数据中心等</p>
<p>而后就可以通过亲和 反亲和 实现将pod 部署在想要的位置</p>
<h2 id="硬亲和-软亲和"><a href="#硬亲和-软亲和" class="headerlink" title="硬亲和 ,软亲和"></a>硬亲和 ,软亲和</h2><ul>
<li><p>硬亲和</p>
<p> 所谓硬亲和 是指必须满足 亲和性 或 反亲和性的条件才可调度pod</p>
</li>
<li><p>软亲和</p>
<p>所谓软亲和 是指”尽量”符合 亲和性 或 反亲和性的条件,如并没有符合条件的节点,则可以不按照条件调度</p>
</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h4 id="亲和性"><a href="#亲和性" class="headerlink" title="亲和性"></a>亲和性</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#硬亲和</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-with-pod-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#亲和性字段</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment">#指定为亲和性而非反亲和</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="comment">#指定为硬亲和</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="comment">#通过标签的K 区域界定 通常是规划好的 比如同一机房有同样标签视为同一个区域</span></span><br><span class="line">            <span class="comment">#如有两个区域 一个zone=one 一个zone=two 通过此字段界定了此集群有2个区域</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line">            <span class="comment">#以上用过zone划分区域 </span></span><br><span class="line">            <span class="comment">#一下确定需要调度到那个区域</span></span><br><span class="line">            <span class="comment">#通过pod标签确定此pod运行在哪个区域</span></span><br><span class="line">            <span class="comment">#亲和性就是要与此pod运行在同一个区域</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">&quot;db&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<h4 id="反亲和"><a href="#反亲和" class="headerlink" title="反亲和"></a>反亲和</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-with-pod-anti-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment">#反亲和</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="comment">#硬亲和</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="comment"># 这个标签是 K8S自带的标签用于记录主机名</span></span><br><span class="line">            <span class="comment"># 以主机名为区域界定</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="comment">#这里写了当前pod自己的标签</span></span><br><span class="line">                <span class="comment">#而且使用了反亲和的硬亲和就是说 一定不允许此pod副本运行在同一节点</span></span><br><span class="line">                <span class="comment">#如果replicas 超过了亲和性或者反亲和的可调度数量时候 多余的pod 则会pending 因为这里使用了硬亲和</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">&quot;myapp&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br></pre></td></tr></table></figure>

<h3 id="软亲和示例"><a href="#软亲和示例" class="headerlink" title="软亲和示例"></a>软亲和示例</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-with-pod-anti-affinity</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="comment">#软亲和</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="comment">#多条件 条件之间是或关系 按照权重 满足其一即可</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">rack</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;db&quot;</span></span><br><span class="line">              <span class="comment">#权重 也可以理解为条件优先级</span></span><br><span class="line">              <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">zone</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">&quot;db&quot;</span></span><br><span class="line">              <span class="attr">weight:</span> <span class="number">20</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S%E8%B5%84%E6%BA%90%E6%B8%85%E5%8D%95/" rel="tag">K8S资源清单</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-Mongodb副本集群"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/Mongodb%E5%89%AF%E6%9C%AC%E9%9B%86%E7%BE%A4/"
    >MongoDB副本集群</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/Mongodb%E5%89%AF%E6%9C%AC%E9%9B%86%E7%BE%A4/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="副本集的搭建"><a href="#副本集的搭建" class="headerlink" title="副本集的搭建"></a>副本集的搭建</h1><h2 id="节点规划"><a href="#节点规划" class="headerlink" title="节点规划"></a>节点规划</h2><ol>
<li>192.168.1.81 </li>
<li>192.168.1.82</li>
<li>192.168.1.83</li>
</ol>
<h2 id="副本集"><a href="#副本集" class="headerlink" title="副本集"></a>副本集</h2><p>主要功能在于数据的安全  当集群其中任意一台主机down, 将会随机或者根据优先级提升一台为主</p>
<p>集群必须保证大于1节点可用,也就是单节点集群不能正常工作</p>
<p>只有主节点可以写入 其他节点只读</p>
<p>优先级相等的时候 故障节点恢复 不会从新选举主节点 </p>
<p>优先级不同的时候 故障节点恢复 会根据优先级大小重新选举 优先级最大的为主 </p>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>所有主机按照单机部署方式安装统一使用一下配置 然后启动服务</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; /etc/mongodb/mongodb.conf</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /var/<span class="built_in">log</span>/mongodb/mongodb.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /data/mongodb</span><br><span class="line">  <span class="comment">#用于数据故障恢复和持久化数据的,它以日志方式来记录</span></span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#使用fork方式 后台运行</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod.pid</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br><span class="line"><span class="comment">#副本配置 </span></span><br><span class="line">replication:</span><br><span class="line">  <span class="comment">#设置一个副本集群名称所有节点必须一致</span></span><br><span class="line">  replSetName: nero-claster</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="集群调试"><a href="#集群调试" class="headerlink" title="集群调试"></a>集群调试</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mongo 命令行客户端执行 任意节点都可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#把集群信息保存到config这个变量中</span></span><br><span class="line">config = &#123; _id:<span class="string">&quot;nero-claster&quot;</span>, members:[</span><br><span class="line">  &#123;_id:0,host:<span class="string">&quot;192.168.1.81:27017&quot;</span>&#125;,</span><br><span class="line">  &#123;_id:1,host:<span class="string">&quot;192.168.1.82:27017&quot;</span>&#125;,</span><br><span class="line">  &#123;_id:2,host:<span class="string">&quot;192.168.1.83:27017&quot;</span>&#125;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#切换到 admin库</span></span><br><span class="line">use admin</span><br><span class="line"><span class="comment">#副本集初始化，需要一定时间</span></span><br><span class="line">rs.initiate( config )	</span><br><span class="line"><span class="comment">#副本集状态，一个primary，其它SECONDARY。primary是主，只有primary能写入</span></span><br><span class="line">rs.status()</span><br><span class="line"><span class="comment">#查看slave的延时情况</span></span><br><span class="line">rs.printSlaveReplicationInfo()</span><br></pre></td></tr></table></figure>

<h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>primary的选举依赖于各个实例的优先优先级，默认优先级都是1</p>
<p>如果优先级不一致 将会以最高优先级当选为primary</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置优先级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#获取成员对应id编号</span></span><br><span class="line">rs.config().members</span><br><span class="line"><span class="comment">#获取集群配置 保存到conf变量</span></span><br><span class="line">conf = rs.config()</span><br><span class="line"><span class="comment">#修改conf变量中的members字段中对应成员的优先级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#id 0 的优先级10 , id 1 优先级5 , id 2 优先级 2</span></span><br><span class="line">conf.members[0].priority = 10   </span><br><span class="line">conf.members[1].priority = 5</span><br><span class="line">conf.members[2].priority = 2</span><br><span class="line"></span><br><span class="line"><span class="comment">#确认conf变量无误</span></span><br><span class="line">conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用conf变量 重新生效配置</span></span><br><span class="line">rs.reconfig(conf)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="副本集的伸缩"><a href="#副本集的伸缩" class="headerlink" title="副本集的伸缩"></a>副本集的伸缩</h2><h3 id="增加节点"><a href="#增加节点" class="headerlink" title="增加节点"></a>增加节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">rs.add(<span class="string">&#x27;192.168.2.84:27017&#x27;</span>)</span><br><span class="line"><span class="comment">#默认优先级为1 自行修改 </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">rs.remove(<span class="string">&#x27;192.168.2.84:27017&#x27;</span>)</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-Mongodb单机部署"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/Mongodb%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2/"
    >MongoDB单机部署</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/Mongodb%E5%8D%95%E6%9C%BA%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="MongoDB单机部署"><a href="#MongoDB单机部署" class="headerlink" title="MongoDB单机部署"></a>MongoDB单机部署</h1><h2 id="二进制部署"><a href="#二进制部署" class="headerlink" title="二进制部署"></a>二进制部署</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.11.tgz</span><br><span class="line">tar xf mongodb-linux-x86_64-rhel70-4.2.11.tgz</span><br><span class="line">mv mongodb-linux-x86_64-rhel70-4.2.11 /usr/<span class="built_in">local</span>/mongodb</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">useradd -M mongodb -s /sbin/nologin </span><br><span class="line">chown -R mongodb:mongodb /usr/<span class="built_in">local</span>/mongodb</span><br><span class="line"><span class="comment">#准备数据目录</span></span><br><span class="line">mkdir -p /data/mongodb</span><br><span class="line">chown -R mongodb:mongodb /data/mongodb</span><br><span class="line"><span class="comment">#准备配置目录</span></span><br><span class="line">mkdir -p /etc/mongodb/</span><br><span class="line">chown -R mongodb:mongodb /etc/mongodb/</span><br><span class="line"><span class="comment">#准备日志目录</span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/mongodb/</span><br><span class="line">chown -R mongodb:mongodb /var/<span class="built_in">log</span>/mongodb/</span><br><span class="line"></span><br><span class="line"><span class="comment">#环境变量</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; /etc/profile.d/mongodb.sh </span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/mongodb/bin/:<span class="variable">$PATH</span></span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/mongodb.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#内存优化 临时生效</span></span><br><span class="line"><span class="built_in">echo</span> never &gt;/sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line"><span class="built_in">echo</span> never &gt;/sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line"><span class="comment">#内存优化重启后永久生效</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;echo never &gt;/sys/kernel/mm/transparent_hugepage/enabled&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;echo never &gt;/sys/kernel/mm/transparent_hugepage/defrag&#x27;</span> &gt;&gt; /etc/rc.d/rc.local</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备配置文件 单机简单示例</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; /etc/mongodb/mongodb.conf</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: <span class="literal">true</span></span><br><span class="line">  path: /var/<span class="built_in">log</span>/mongodb/mongodb.log</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /data/mongodb</span><br><span class="line">  <span class="comment">#用于数据故障恢复和持久化数据的,它以日志方式来记录</span></span><br><span class="line">  journal:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line"><span class="comment">#使用fork方式 后台运行</span></span><br><span class="line">processManagement:</span><br><span class="line">  fork: <span class="literal">true</span></span><br><span class="line">  pidFilePath: /var/run/mongodb/mongod.pid</span><br><span class="line">  timeZoneInfo: /usr/share/zoneinfo</span><br><span class="line">net:</span><br><span class="line">  port: 27017</span><br><span class="line">  bindIp: 0.0.0.0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#UnitFile</span></span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; /usr/lib/systemd/system/mongod.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=MongoDB Database Server</span><br><span class="line">Documentation=https://docs.mongodb.org/manual</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=mongodb</span><br><span class="line">Group=mongodb</span><br><span class="line">Environment=<span class="string">&quot;OPTIONS=-f /etc/mongodb/mongodb.conf&quot;</span></span><br><span class="line">EnvironmentFile=-/etc/sysconfig/mongod</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/mongodb/bin/mongod <span class="variable">$OPTIONS</span></span><br><span class="line">ExecStartPre=/usr/bin/mkdir -p /var/run/mongodb</span><br><span class="line">ExecStartPre=/usr/bin/chown mongodb:mongodb /var/run/mongodb</span><br><span class="line">ExecStartPre=/usr/bin/chmod 0755 /var/run/mongodb</span><br><span class="line">PermissionsStartOnly=<span class="literal">true</span></span><br><span class="line">PIDFile=/var/run/mongodb/mongod.pid</span><br><span class="line">Type=forking</span><br><span class="line"><span class="comment"># file size</span></span><br><span class="line">LimitFSIZE=infinity</span><br><span class="line"><span class="comment"># cpu time</span></span><br><span class="line">LimitCPU=infinity</span><br><span class="line"><span class="comment"># virtual memory size</span></span><br><span class="line">LimitAS=infinity</span><br><span class="line"><span class="comment"># open files</span></span><br><span class="line">LimitNOFILE=64000</span><br><span class="line"><span class="comment"># processes/threads</span></span><br><span class="line">LimitNPROC=64000</span><br><span class="line"><span class="comment"># locked memory</span></span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line"><span class="comment"># total threads (user+kernel)</span></span><br><span class="line">TasksMax=infinity</span><br><span class="line">TasksAccounting=<span class="literal">false</span></span><br><span class="line"><span class="comment"># Recommended limits for mongod as specified in</span></span><br><span class="line"><span class="comment"># https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</span></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload &amp;&amp;  systemctl start mongod &amp;&amp; systemc <span class="built_in">enable</span> mongod</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  ss -tnl |grep 27017</span><br><span class="line">LISTEN     0      128          *:27017                    *:* </span><br><span class="line">╰─➤  ll /data/mongodb</span><br><span class="line">总用量 272K</span><br><span class="line">-rw------- 1 mongodb mongodb  20K 12月 21 16:21 collection-0--1221164907931845333.wt</span><br><span class="line">-rw------- 1 mongodb mongodb  36K 12月 21 16:22 collection-2--1221164907931845333.wt</span><br><span class="line">-rw------- 1 mongodb mongodb 4.0K 12月 21 16:20 collection-4--1221164907931845333.wt</span><br><span class="line">drwx------ 2 mongodb mongodb  113 12月 21 16:25 diagnostic.data</span><br><span class="line">-rw------- 1 mongodb mongodb  20K 12月 21 16:21 index-1--1221164907931845333.wt</span><br><span class="line">-rw------- 1 mongodb mongodb  36K 12月 21 16:22 index-3--1221164907931845333.wt</span><br><span class="line">-rw------- 1 mongodb mongodb 4.0K 12月 21 16:20 index-5--1221164907931845333.wt</span><br><span class="line">-rw------- 1 mongodb mongodb  12K 12月 21 16:23 index-6--1221164907931845333.wt</span><br><span class="line">drwx------ 2 mongodb mongodb  110 12月 21 16:21 journal</span><br><span class="line">-rw------- 1 mongodb mongodb  20K 12月 21 16:21 _mdb_catalog.wt</span><br><span class="line">-rw------- 1 mongodb mongodb    5 12月 21 16:21 mongod.lock</span><br><span class="line">-rw------- 1 mongodb mongodb  36K 12月 21 16:23 sizeStorer.wt</span><br><span class="line">-rw------- 1 mongodb mongodb  114 12月 21 16:18 storage.bson</span><br><span class="line">-rw------- 1 mongodb mongodb   46 12月 21 16:18 WiredTiger</span><br><span class="line">-rw------- 1 mongodb mongodb 4.0K 12月 21 16:21 WiredTigerLAS.wt</span><br><span class="line">-rw------- 1 mongodb mongodb   21 12月 21 16:18 WiredTiger.lock</span><br><span class="line">-rw------- 1 mongodb mongodb 1.3K 12月 21 16:24 WiredTiger.turtle</span><br><span class="line">-rw------- 1 mongodb mongodb  60K 12月 21 16:24 WiredTiger.wt</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-mongodb索引"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/mongodb%E7%B4%A2%E5%BC%95/"
    >MongoDB索引</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/mongodb%E7%B4%A2%E5%BC%95/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#慢查询状态 默认超过100毫秒 视为慢查询 会写入日志</span></span><br><span class="line">&gt; db.getProfilingStatus()</span><br><span class="line">&#123; <span class="string">&quot;was&quot;</span> : 0, <span class="string">&quot;slowms&quot;</span> : 100, <span class="string">&quot;sampleRate&quot;</span> : 1 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询过程详情 多用于查看此语句是否全表扫描</span></span><br><span class="line">&gt; db.myuser.find( &#123;age:9999&#125; ).explain(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;queryPlanner&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;plannerVersion&quot;</span> : 1,</span><br><span class="line">                <span class="string">&quot;namespace&quot;</span> : <span class="string">&quot;shijiange.myuser&quot;</span>,</span><br><span class="line">                <span class="string">&quot;indexFilterSet&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;parsedQuery&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;winningPlan&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;stage&quot;</span> : <span class="string">&quot;COLLSCAN&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;filter&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                        <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;direction&quot;</span> : <span class="string">&quot;forward&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;rejectedPlans&quot;</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;executionStats&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;executionSuccess&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;nReturned&quot;</span> : 1,</span><br><span class="line">                <span class="comment">#查询时间 毫秒</span></span><br><span class="line">                <span class="string">&quot;executionTimeMillis&quot;</span> : 198,</span><br><span class="line">                <span class="string">&quot;totalKeysExamined&quot;</span> : 0,</span><br><span class="line">                <span class="comment">#总查询条目数条目数过大 可能就是全表查询</span></span><br><span class="line">                <span class="string">&quot;totalDocsExamined&quot;</span> : 500000,</span><br><span class="line">                <span class="string">&quot;executionStages&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;stage&quot;</span> : <span class="string">&quot;COLLSCAN&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;filter&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                        <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;nReturned&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;executionTimeMillisEstimate&quot;</span> : 0,</span><br><span class="line">                        <span class="string">&quot;works&quot;</span> : 500002,</span><br><span class="line">                        <span class="string">&quot;advanced&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;needTime&quot;</span> : 500000,</span><br><span class="line">                        <span class="string">&quot;needYield&quot;</span> : 0,</span><br><span class="line">                        <span class="string">&quot;saveState&quot;</span> : 3906,</span><br><span class="line">                        <span class="string">&quot;restoreState&quot;</span> : 3906,</span><br><span class="line">                        <span class="string">&quot;isEOF&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;direction&quot;</span> : <span class="string">&quot;forward&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;docsExamined&quot;</span> : 500000</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;allPlansExecution&quot;</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;serverInfo&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> : <span class="string">&quot;k-n1.sp.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;port&quot;</span> : 27017,</span><br><span class="line">                <span class="string">&quot;version&quot;</span> : <span class="string">&quot;4.2.11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gitVersion&quot;</span> : <span class="string">&quot;ea38428f0c6742c7c2c7f677e73d79e17a2aab96&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ok&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对某一个字段添加索引</span></span><br><span class="line">db.myuser.ensureIndex( &#123;name:1&#125; )</span><br><span class="line"><span class="comment">#添加唯一索引  &#123;unique:true&#125; 唯一索引仅适用于字段值没有相等条目的情况</span></span><br><span class="line">db.myuser.ensureIndex( &#123;userid:1&#125;,&#123;unique:<span class="literal">true</span>&#125; ) </span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-mongo基础"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/mongo%E5%9F%BA%E7%A1%80/"
    >mongo基础</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/mongo%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><ol>
<li>database  #数据库</li>
<li>collection  #集合  相当于mysql的表</li>
<li>filed          #字段  但不想mysql一样 所有行的字段必须一致  mongo是可以不一致的 但一般不这样使用</li>
<li>document #每行的记录</li>
</ol>
<h1 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h1><h2 id="查询数据库"><a href="#查询数据库" class="headerlink" title="查询数据库"></a>查询数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  mongo</span><br><span class="line"><span class="comment">#查询数据库  下面三个库是默认生成的</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="正确关闭mongodb的方法"><a href="#正确关闭mongodb的方法" class="headerlink" title="正确关闭mongodb的方法"></a>正确关闭mongodb的方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换到 admin 库</span></span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line"><span class="comment">#关闭服务</span></span><br><span class="line">&gt; db.shutdownServer()</span><br><span class="line">2020-12-21T16:51:52.502+0800 I  NETWORK  [js] DBClientConnection failed to receive message from 127.0.0.1:27017 - HostUnreachable: Connection closed by peer</span><br><span class="line">server should be down...</span><br><span class="line">&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="创建库"><a href="#创建库" class="headerlink" title="创建库"></a>创建库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#use 命令当库存在的时候 切换到此库 当不存在时 写入数据时创建此库</span></span><br><span class="line">use database_name</span><br></pre></td></tr></table></figure>

<h2 id="创建集合和字段"><a href="#创建集合和字段" class="headerlink" title="创建集合和字段"></a>创建集合和字段</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#切换到一个不存在的库</span><br><span class="line">&gt; use shijiange </span><br><span class="line">switched to db shijiange</span><br><span class="line">#插入数据 到一个不存在的表(集合) myuser</span><br><span class="line">&gt; db.myuser.insert(&#123; name: &#39;shijiange1&#39;, age: 27 &#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">#发现由于我们插入数据触发写操作 库被自动创建</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">config     0.000GB</span><br><span class="line">local      0.000GB</span><br><span class="line">shijiange  0.000GB</span><br></pre></td></tr></table></figure>

<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; use shijiange </span><br><span class="line">switched to db shijiange</span><br><span class="line">&gt; show tables</span><br><span class="line">myuser</span><br><span class="line"><span class="comment">#全量查询  如果本页面不够现实 他会分页 it 命令翻页</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06585a78ed0ef0786cf2b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b7&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 26 &#125;</span><br><span class="line"><span class="comment">#条件查询</span></span><br><span class="line">&gt; db.myuser.find( &#123; name: <span class="string">&#x27;shijiange1&#x27;</span> &#125; )</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06585a78ed0ef0786cf2b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pretty() 易读方式 查询</span></span><br><span class="line">&gt; db.myuser.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 20</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 28</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 38</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#限制条目</span></span><br><span class="line">&gt; db.myuser.find().<span class="built_in">limit</span>(2)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#跳过条目数</span></span><br><span class="line"><span class="comment">#跳过前两条显示之后的两条</span></span><br><span class="line">&gt; db.myuser.find().skip(2).<span class="built_in">limit</span>(2)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#混合使用</span></span><br><span class="line">&gt; db.myuser.find().<span class="built_in">limit</span>(2).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 20</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 28</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#升序</span></span><br><span class="line">&gt; db.myuser.find().sort(&#123;age: 1&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f40&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan2&quot;</span>, <span class="string">&quot;age&quot;</span> : 68 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#降序</span></span><br><span class="line">&gt; db.myuser.find().sort(&#123;age: -1&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f40&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan2&quot;</span>, <span class="string">&quot;age&quot;</span> : 68 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="比较查询"><a href="#比较查询" class="headerlink" title="比较查询"></a>比较查询</h2><ul>
<li>$gt    #大于</li>
<li>$lt    #小于</li>
<li>$gte    #大于或等于</li>
<li>$lte    #小于或等于</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例</span></span><br><span class="line">&gt; db.myuser.find(&#123; age: &#123;<span class="variable">$lt</span>: 30&#125; &#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<h2 id="与或查询"><a href="#与或查询" class="headerlink" title="与或查询"></a>与或查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#或</span></span><br><span class="line">&gt; db.myuser.find(&#123;<span class="variable">$or</span>:[&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;,&#123;name: <span class="string">&#x27;shijiange2&#x27;</span>&#125;]&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line"><span class="comment">#与</span></span><br><span class="line">db.myuser.find(&#123;<span class="variable">$and</span>:[&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;,&#123;name: <span class="string">&#x27;shijiange2&#x27;</span>&#125;]&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="正则查询"><a href="#正则查询" class="headerlink" title="正则查询"></a>正则查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#类似grep匹配 包含即可匹配</span></span><br><span class="line">&gt; db.myuser.find(&#123; name: &#123;<span class="variable">$regex</span>: <span class="string">&quot;shijiange[2-3]&quot;</span>&#125; &#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br></pre></td></tr></table></figure>



<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; use shijiange</span><br><span class="line">switched to db shijiange</span><br><span class="line">&gt; show tables</span><br><span class="line">myuser</span><br><span class="line"><span class="comment">#条件删除</span></span><br><span class="line">&gt; db.myuser.remove(&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nRemoved&quot;</span> : 1 &#125;)</span><br><span class="line"><span class="comment">#验证 shijiange1 的数据没有了</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b7&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 26 &#125;</span><br><span class="line"><span class="comment">#删除表内所有数据</span></span><br><span class="line">&gt; db.myuser.remove(&#123;&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nRemoved&quot;</span> : 2 &#125;)</span><br><span class="line"><span class="comment">#发现表内什么都没有了</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&gt; </span><br><span class="line"><span class="comment">#删除集合 myuser</span></span><br><span class="line">&gt; db.myuser.drop()</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="comment">#查看集合 发现确实删除了</span></span><br><span class="line">&gt; show tables</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<h2 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06e9b591eadd5db5b3ffb&quot;</span>), <span class="string">&quot;arg&quot;</span> : 1, <span class="string">&quot;int&quot;</span> : 2 &#125;</span><br><span class="line"><span class="comment">#修改 arg: 1 为 arg: 2 </span></span><br><span class="line">&gt; db.myuser.update(&#123; arg: 1 &#125;,&#123; <span class="variable">$set</span>: &#123; arg: 2 &#125; &#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : 1, <span class="string">&quot;nUpserted&quot;</span> : 0, <span class="string">&quot;nModified&quot;</span> : 1 &#125;)</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06e9b591eadd5db5b3ffb&quot;</span>), <span class="string">&quot;arg&quot;</span> : 2, <span class="string">&quot;int&quot;</span> : 2 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="删库"><a href="#删库" class="headerlink" title="删库"></a>删库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换到想要删除的库</span></span><br><span class="line">&gt; use shijiange</span><br><span class="line">switched to db shijiange</span><br><span class="line"><span class="comment">#删除库</span></span><br><span class="line">&gt; db.dropDatabase()</span><br><span class="line">&#123; <span class="string">&quot;dropped&quot;</span> : <span class="string">&quot;shijiange&quot;</span>, <span class="string">&quot;ok&quot;</span> : 1 &#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line"><span class="comment">#自带库千万别动</span></span><br></pre></td></tr></table></figure>

<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mongodb实时监控之mongostat</span><br><span class="line">mongostat可以实时监控mongodb的状态，一直刷新输出</span><br><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongostat --<span class="built_in">help</span></span><br><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongostat  -h 127.0.0.1:27017</span><br><span class="line"></span><br><span class="line">测试脚本</span><br><span class="line">use shijiange</span><br><span class="line"><span class="keyword">for</span>(i=1; i&lt;=300000;i++)&#123;</span><br><span class="line">  db.myuser.insert( &#123;name:<span class="string">&#x27;mytest&#x27;</span>+i, age:i&#125; )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mongodb监控之serverStatus</span><br><span class="line">serverStatus可用来获取mongodb的状态信息</span><br><span class="line">db.serverStatus()			<span class="comment">#查看所有的监控信息</span></span><br><span class="line">db.serverStatus().network	<span class="comment">#单独查看网络流量信息</span></span><br><span class="line">db.serverStatus().opcounters	<span class="comment">#统计增、删、改、查的次数</span></span><br><span class="line">db.serverStatus().connections<span class="comment">#连接</span></span><br><span class="line"></span><br><span class="line">使用非交互式shell进行获取</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;db.serverStatus()&#x27;</span> | /usr/<span class="built_in">local</span>/mongodb/bin/mongo 127.0.0.1:27017</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;db.serverStatus().opcounters&#x27;</span> | /usr/<span class="built_in">local</span>/mongodb/bin/mongo 127.0.0.1:27017</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-备份与恢复"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"
    >备份与恢复</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="mongodump-备份数据"><a href="#mongodump-备份数据" class="headerlink" title="mongodump 备份数据"></a>mongodump 备份数据</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份所有数据到目录</span></span><br><span class="line">mongodump -h 127.0.0.1:27017 -o /data/mongodbbackup/</span><br></pre></td></tr></table></figure>



<h1 id="mongorestore-导入备份好的数据"><a href="#mongorestore-导入备份好的数据" class="headerlink" title="mongorestore 导入备份好的数据"></a>mongorestore 导入备份好的数据</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从备份目录恢复数据</span></span><br><span class="line">mongorestore -h 127.0.0.1:27018 /data/mongodbbackup/</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2020
        <i class="ri-heart-fill heart_icon"></i> Nero
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo.png" alt="Nero 的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>