<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="摇旗呐喊的热情,携光阴渐远去,人世间悲喜烂剧,昼夜轮播不停,纷飞的滥情男女,情仇爱恨别离,一代人终将老去，但总有人正年轻" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Nero 的个人博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/back4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Nero 的个人博客</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
        <img
          src="/images/logo.png"
          class="cover-logo"
          alt="Nero 的个人博客"
        />
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['摇旗呐喊的热情,携光阴渐远去,', '人世间悲喜烂剧,昼夜轮播不停,', '纷飞的滥情男女, 情仇爱恨别离,一代人终将老去，但总有人正年轻'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <article class="articles">
    
    
    
    
    <article
  id="post-prometheus-operator/code-of-conduct"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/code-of-conduct/" class="article-date">
  <time datetime="2020-12-12T13:30:46.117Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="CoreOS-Community-Code-of-Conduct"><a href="#CoreOS-Community-Code-of-Conduct" class="headerlink" title="CoreOS Community Code of Conduct"></a>CoreOS Community Code of Conduct</h2><h3 id="Contributor-Code-of-Conduct"><a href="#Contributor-Code-of-Conduct" class="headerlink" title="Contributor Code of Conduct"></a>Contributor Code of Conduct</h3><p>As contributors and maintainers of this project, and in the interest of<br>fostering an open and welcoming community, we pledge to respect all people who<br>contribute through reporting issues, posting feature requests, updating<br>documentation, submitting pull requests or patches, and other activities.</p>
<p>We are committed to making participation in this project a harassment-free<br>experience for everyone, regardless of level of experience, gender, gender<br>identity and expression, sexual orientation, disability, personal appearance,<br>body size, race, ethnicity, age, religion, or nationality.</p>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li>The use of sexualized language or imagery</li>
<li>Personal attacks</li>
<li>Trolling or insulting/derogatory comments</li>
<li>Public or private harassment</li>
<li>Publishing others’ private information, such as physical or electronic addresses, without explicit permission</li>
<li>Other unethical or unprofessional conduct.</li>
</ul>
<p>Project maintainers have the right and responsibility to remove, edit, or<br>reject comments, commits, code, wiki edits, issues, and other contributions<br>that are not aligned to this Code of Conduct. By adopting this Code of Conduct,<br>project maintainers commit themselves to fairly and consistently applying these<br>principles to every aspect of managing this project. Project maintainers who do<br>not follow or enforce the Code of Conduct may be permanently removed from the<br>project team.</p>
<p>This code of conduct applies both within project spaces and in public spaces<br>when an individual is representing the project or its community.</p>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be<br>reported by contacting a project maintainer, Brandon Philips<br><a href="mailto:&#98;&#114;&#97;&#x6e;&#x64;&#111;&#x6e;&#46;&#112;&#x68;&#x69;&#108;&#105;&#112;&#115;&#x40;&#99;&#111;&#114;&#101;&#x6f;&#x73;&#46;&#x63;&#x6f;&#109;">&#98;&#114;&#97;&#x6e;&#x64;&#111;&#x6e;&#46;&#112;&#x68;&#x69;&#108;&#105;&#112;&#115;&#x40;&#99;&#111;&#114;&#101;&#x6f;&#x73;&#46;&#x63;&#x6f;&#109;</a>, and/or Rithu John <a href="mailto:&#114;&#x69;&#116;&#104;&#117;&#46;&#106;&#111;&#104;&#110;&#64;&#99;&#111;&#114;&#101;&#x6f;&#x73;&#46;&#99;&#x6f;&#x6d;">&#114;&#x69;&#116;&#104;&#117;&#46;&#106;&#111;&#104;&#110;&#64;&#99;&#111;&#114;&#101;&#x6f;&#x73;&#46;&#99;&#x6f;&#x6d;</a>.</p>
<p>This Code of Conduct is adapted from the Contributor Covenant<br>(<a target="_blank" rel="noopener" href="http://contributor-covenant.org/">http://contributor-covenant.org</a>), version 1.2.0, available at<br><a target="_blank" rel="noopener" href="http://contributor-covenant.org/version/1/2/0/">http://contributor-covenant.org/version/1/2/0/</a></p>
<h3 id="CoreOS-Events-Code-of-Conduct"><a href="#CoreOS-Events-Code-of-Conduct" class="headerlink" title="CoreOS Events Code of Conduct"></a>CoreOS Events Code of Conduct</h3><p>CoreOS events are working conferences intended for professional networking and<br>collaboration in the CoreOS community. Attendees are expected to behave<br>according to professional standards and in accordance with their employer’s<br>policies on appropriate workplace behavior.</p>
<p>While at CoreOS events or related social networking opportunities, attendees<br>should not engage in discriminatory or offensive speech or actions including<br>but not limited to gender, sexuality, race, age, disability, or religion.<br>Speakers should be especially aware of these concerns.</p>
<p>CoreOS does not condone any statements by speakers contrary to these standards.<br>CoreOS reserves the right to deny entrance and/or eject from an event (without<br>refund) any individual found to be engaging in discriminatory or offensive<br>speech or actions.</p>
<p>Please bring any concerns to the immediate attention of designated on-site<br>staff, Brandon Philips <a href="mailto:&#98;&#114;&#x61;&#110;&#100;&#x6f;&#110;&#46;&#x70;&#104;&#x69;&#x6c;&#105;&#112;&#x73;&#64;&#99;&#x6f;&#x72;&#x65;&#111;&#115;&#46;&#x63;&#x6f;&#109;">&#98;&#114;&#x61;&#110;&#100;&#x6f;&#110;&#46;&#x70;&#104;&#x69;&#x6c;&#105;&#112;&#x73;&#64;&#99;&#x6f;&#x72;&#x65;&#111;&#115;&#46;&#x63;&#x6f;&#109;</a>, and/or Rithu John <a href="mailto:&#x72;&#105;&#x74;&#x68;&#117;&#46;&#x6a;&#x6f;&#x68;&#x6e;&#x40;&#x63;&#x6f;&#x72;&#x65;&#x6f;&#115;&#x2e;&#x63;&#111;&#x6d;">&#x72;&#105;&#x74;&#x68;&#117;&#46;&#x6a;&#x6f;&#x68;&#x6e;&#x40;&#x63;&#x6f;&#x72;&#x65;&#x6f;&#115;&#x2e;&#x63;&#111;&#x6d;</a>.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-prometheus-operator/CHANGELOG"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
     
    <div class="article-meta">
      <a href="/2020/12/12/prometheus-operator/CHANGELOG/" class="article-date">
  <time datetime="2020-12-12T13:30:46.110Z" itemprop="datePublished">2020-12-12</time>
</a>  
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="Next-release"><a href="#Next-release" class="headerlink" title="Next release"></a>Next release</h2><h2 id="0-39-0-2020-05-06"><a href="#0-39-0-2020-05-06" class="headerlink" title="0.39.0 / 2020-05-06"></a>0.39.0 / 2020-05-06</h2><ul>
<li>[CHANGE] Introduce release schedule (#3135)</li>
<li>[CHANGE] Remove options configuring CRD management (manage-crds, crd-kinds, with-validation) (#3155)</li>
<li>[CHANGE] Add CRD definitions to bundle.yaml (#3171)</li>
<li>[CHANGE] Switch to apiextensions.k8s.io/v1 CRD and require kubernetes v1.16 or newer (#3175, #3187)</li>
<li>[FEATURE] Add support prometheus query log file (#3116)</li>
<li>[FEATURE] Add support for watching specified rules directory by config-relader (#3128)</li>
<li>[FEATURE] Add TLS support for operator web server (#3134, #3157)</li>
<li>[FEATURE] Allow to set address for operator http endpoint (#3098)</li>
<li>[FEATURE] Allow setting the alertmanagers cluster.advertiseAddress (#3160)</li>
<li>[FEATURE] Build operator images for ARM and ARM64 platforms (#3177)</li>
<li>[ENHANCEMENT] Allow setting log level and format for thanos sidecar (#3112)</li>
<li>[ENHANCEMENT] Support naming of remote write queues (#3144)</li>
<li>[ENHANCEMENT] Allow disabling mount subPath for volumes (#3143)</li>
<li>[ENHANCEMENT] Update k8s libraries to v1.18 (#3154)</li>
<li>[ENHANCEMENT] Create separate namespace informers when needed (#3182)</li>
<li>[BUGFIX] Tolerate version strings which aren’t following semver (#3101)</li>
<li>[BUGFIX] Retain metadata for embedded PVC objects (#3115)</li>
<li>[BUGFIX] Fix definition of thanos-ruler-operated service (#3126)</li>
<li>[BUGFIX] Allow setting the cluster domain (#3138)</li>
<li>[BUGFIX] Allow matching only PodMonitors (#3173)</li>
<li>[BUGFIX] Fix typo in statefulset informer (#3179)</li>
</ul>
<h2 id="0-38-1-2020-04-16"><a href="#0-38-1-2020-04-16" class="headerlink" title="0.38.1 / 2020-04-16"></a>0.38.1 / 2020-04-16</h2><ul>
<li>[BUGFIX] Fix definition of web service port for Alertmanager (#3125)</li>
<li>[BUGFIX] Support external alert query URL for THanos Ruler (#3129)</li>
<li>[BUGFIX] Do not modify the PrometheusRule cache object (#3105)</li>
</ul>
<h2 id="0-38-0-2020-03-20"><a href="#0-38-0-2020-03-20" class="headerlink" title="0.38.0 / 2020-03-20"></a>0.38.0 / 2020-03-20</h2><ul>
<li>[CHANGE] Changed ThanosRuler custom resource field alertmanagersURL type from string to []string (#3067)</li>
<li>[CHANGE] Deprecate PodMonitor targetPort field (#3071, #3078)</li>
<li>[FEATURE] Add queryConfig field to ThanosRuler spec (#3068)</li>
<li>[FEATURE] GRPC TLS config for Thanos Ruler and Sidecar (#3059)</li>
<li>[FEATURE] MergePatch Alertmanager containers (#3080)</li>
<li>[FEATURE] Add VolumeMounts to Prometheus custom resources (#2871)</li>
<li>[ENHANCEMENT] Update Thanos to v0.11.0 (#3066)</li>
<li>[ENHANCEMENT] Clarify that Endpoint.targetPort is pod port (#3064)</li>
<li>[BUGFIX] ThanosRuler restarts instead of reloading with new PrometheusRules (#3056)</li>
<li>[BUGFIX] Omit QueryEndpoints if empty (#3091)</li>
</ul>
<h2 id="0-37-0-2020-03-02"><a href="#0-37-0-2020-03-02" class="headerlink" title="0.37.0 / 2020-03-02"></a>0.37.0 / 2020-03-02</h2><ul>
<li>[FEATURE] Add routePrefix to ThanosRuler spec (#3023)</li>
<li>[FEATURE] Add externalPrefix to ThanosRuler spec (#3058)</li>
<li>[FEATURE] Add pod template fields to ThanosRuler custom resource (#3034)</li>
<li>[ENHANCEMENT] Make ports on kubelet service and endpoints match (#3039)</li>
<li>[ENHANCEMENT] Update kubernetes API dependencies to v0.17.3/1.17.3 (#3042)</li>
<li>[ENHANCEMENT] Simplify multi-arch building (#3035)</li>
<li>[ENHANCEMENT] Default to Prometheus v2.16.0 (#3050, #3051)</li>
<li>[BUGFIX] Fix stateful set being pruned by kubectl (#3029, #3030)</li>
<li>[BUGFIX] Fix prometheus rule validator admitting rules with invalid label types (#2727,#2962)</li>
<li>[BUGFIX] Fix flaky test in Thanos ruler (#3038)</li>
<li>[BUGFIX] Fix ThanosRuler status reporting (#3045)</li>
<li>[BUGFIX] Preserve pod labels and annotations in custom resources (#3041, #3043)</li>
<li>[BUGFIX] Prevent stateful set update loop for alertmanager and thonos types (#3048, #3049)</li>
</ul>
<h2 id="0-36-0-2020-02-10"><a href="#0-36-0-2020-02-10" class="headerlink" title="0.36.0 / 2020-02-10"></a>0.36.0 / 2020-02-10</h2><ul>
<li>[CHANGE] Rename binary <code>lint</code> to <code>po-lint</code> (#2964)</li>
<li>[CHANGE] Restrict api extension RBAC rules (#2974)</li>
<li>[FEATURE] Add operator for Thanos Ruler resources (#2943)</li>
<li>[FEATURE] Thanos Ruler Improvements (#2986, #2991, #2993, #2994, #3018, #3019)</li>
<li>[FEATURE] Add additional printer columns for custom resources (#2922)</li>
<li>[ENHANCEMENT] Set config-reloader containers resources (#2958)</li>
<li>[ENHANCEMENT] Fix broken links and remove spec.version in examples (#2961)</li>
<li>[ENHANCEMENT] Reduce deprecation warning verbosity (#2978)</li>
<li>[ENHANCEMENT] Build tooling improvements (#2979, #2982, #2983)</li>
<li>[ENHANCEMENT] Update Prometheus compatible version list (#2998)</li>
<li>[ENHANCEMENT] Fix broken links in documentation (#3005)</li>
<li>[ENHANCEMENT] Update default container image versions (#3007)</li>
<li>[BUGFIX] Fix statefulset crash loop in Kube 1.17 (#2987)</li>
</ul>
<h2 id="0-35-0-2020-01-13"><a href="#0-35-0-2020-01-13" class="headerlink" title="0.35.0 / 2020-01-13"></a>0.35.0 / 2020-01-13</h2><ul>
<li>[CHANGE] Deprecate baseImage, tag, and sha fields in custom resources (#2914)</li>
<li>[FEATURE] Add APIVersion field to Prometheus.Spec.Alerting (#2884)</li>
<li>[FEATURE] Add an option to disable compaction (#2886)</li>
<li>[FEATURE] Allow configuring PVC access mode (#978)</li>
<li>[ENHANCEMENT] Do not disable compaction on sidecar without object storage configuration (#2845)</li>
<li>[ENHANCEMENT] Fix StatefulSet being needlessly re-created (#2857)</li>
<li>[ENHANCEMENT] Add metric for statefulset re-create (#2859)</li>
<li>[ENHANCEMENT] Rename <code>mesh</code> ports to be prefixed with protocol (#2863)</li>
<li>[ENHANCEMENT] Use kubebuilder controller-gen for creating CRDs (#2855)</li>
<li>[ENHANCEMENT] Add metrics about node endpoints synchronization (#2887)</li>
<li>[ENHANCEMENT] Turn off preserveUnknownFields to enable kubectl explain (#2903)</li>
<li>[ENHANCEMENT] Instrument operator’s list and watch operations (#2893)</li>
<li>[BUGFIX] Modified prometheus wget probe when listenLocal=true (#2929)</li>
<li>[BUGFIX] Fix generated statefulset being pruned by kubectl (#2944)</li>
</ul>
<h2 id="0-34-0-2019-10-31"><a href="#0-34-0-2019-10-31" class="headerlink" title="0.34.0 / 2019-10-31"></a>0.34.0 / 2019-10-31</h2><ul>
<li>[CHANGE] Make arbitraryFSAccessThroughSMs optional (#2797)</li>
<li>[FEATURE] Add [prometheus,alertmanager]-instance-namespaces cmdline parameter (#2783)</li>
<li>[FEATURE] Add configSecret element to the AlertmanagerSpec (#2827)</li>
<li>[FEATURE] Add enforcedNamespaceLabel to Prometheus CRD (#2820)</li>
<li>[FEATURE] Add exec probes against localhost:9090 to Prometheus if listenLocal is set to true (#2763)</li>
<li>[FEATURE] Add honorTimestamps field to Prometheus, Podmonitor, and ServiceMonitor CRD (#2800)</li>
<li>[FEATURE] Add ignoreNamespaceSelectors field to Prometheus CRD (#2816)</li>
<li>[FEATURE] Add local configuration options in jsonnet/prometheus-operator (#2794)</li>
<li>[FEATURE] Add overrideHonorLabels to Prometheus CRD (#2806)</li>
<li>[FEATURE] Reference secrets instead of local files (#2716)</li>
<li>[ENHANCEMENT] Add missing json struct tag for ArbitraryFSAccessThroughSMsConfig (#2808)</li>
<li>[ENHANCEMENT] Ensure containers have “FallbackToLogsOnError” termination policy (#2819)</li>
<li>[ENHANCEMENT] Improve detection of StatefulSet changes (#2801)</li>
<li>[ENHANCEMENT] Only append relabelings if EnforcedNamespaceLabel value is set (#2830)</li>
<li>[ENHANCEMENT] Remove unneeded Ownership change in prometheus-config-reloader (#2761)</li>
<li>[ENHANCEMENT] Update k8s client to 1.16 (#2778)</li>
<li>[BUGFIX] Update prometheus dependency to v2.12.0 to fix validation failure for .externalLabels admission webhook (#2779)</li>
</ul>
<h2 id="0-33-0-2019-09-12"><a href="#0-33-0-2019-09-12" class="headerlink" title="0.33.0 / 2019-09-12"></a>0.33.0 / 2019-09-12</h2><ul>
<li>[FEATURE] Add Thanos service port to governing service (#2754)</li>
<li>[FEATURE] Add VolumeMounts to Alertmanager (#2755)</li>
<li>[ENHANCEMENT] Bump default thanos image and version (#2746)</li>
</ul>
<h2 id="0-32-0-2019-08-30"><a href="#0-32-0-2019-08-30" class="headerlink" title="0.32.0 / 2019-08-30"></a>0.32.0 / 2019-08-30</h2><ul>
<li>[CHANGE] Change PodManagement policy to parallel in Alertmanager (#2676)</li>
<li>[FEATURE] Adding label selector for Alertmanager objects discovery filtering (#2662)</li>
<li>[FEATURE] Provide option to turn on WAL compression (#2683)</li>
<li>[FEATURE] Support namespace denylist for listwatcher (#2710)</li>
<li>[FEATURE] Add support for Volumes to Prometheus Custom Resource (#2734)</li>
<li>[FEATURE] Add support for Volumes to Alertmanager Custom Resource (#2737)</li>
<li>[FEATURE] Add support for InitContainers to Prometheus Custom Resource (#2522)</li>
</ul>
<h2 id="0-31-1-2019-06-25"><a href="#0-31-1-2019-06-25" class="headerlink" title="0.31.1 / 2019-06-25"></a>0.31.1 / 2019-06-25</h2><ul>
<li>[BUGFIX] Increase terminationGracePeriod for alertmanager statefulSet as it cannot be 0. (#2657)</li>
</ul>
<h2 id="0-31-0-2019-06-20"><a href="#0-31-0-2019-06-20" class="headerlink" title="0.31.0 / 2019-06-20"></a>0.31.0 / 2019-06-20</h2><ul>
<li>[CHANGE] Remove gossip configuration from Thanos sidecar. This means only non-gossip configurations can be used going forward. (#2623, #2629)</li>
<li>[FEATURE] Add PodMonitor, allowing monitoring pods directly without the necessity to go through a Endpoints of a Service, this is an experimental feature, it may break at any time without notice. (#2566)</li>
<li>[FEATURE] Add admission webhook to validate <code>PrometheusRule</code> objects with Prometheus’ promtool linting. (#2551)</li>
<li>[FEATURE] Add ability to select subset of Prometheus objects to reconcile against, configurable with <code>--prometheus-instance-selector</code> flag. (#2615)</li>
<li>[FEATURE] Add ability to configure size based retention on Prometheus. (#2608)</li>
<li>[FEATURE] Add ability to use StatefulSet ordinal in external labels. (#2591)</li>
<li>[ENHANCEMENT] Use /-/healthy and /-/ready for probes in Alertmanager. (#2600)</li>
</ul>
<h2 id="0-30-0-2019-05-10"><a href="#0-30-0-2019-05-10" class="headerlink" title="0.30.0 / 2019-05-10"></a>0.30.0 / 2019-05-10</h2><p>Note: Both kube-prometheus (#2554) and the Helm Chart (#2416) have been removed from this repository.<br>kube-prometheus is not hosted as github.com/coroes/kube-prometheus and the helm chart is available at <a target="_blank" rel="noopener" href="https://github.com/helm/charts/tree/master/stable/prometheus-operator">https://github.com/helm/charts/tree/master/stable/prometheus-operator</a></p>
<ul>
<li>[CHANGE] Drop support for Alertmanager &lt; v0.15.0 (#2568)</li>
<li>[FEATURE] Add Prometheus Config Reloader CPU and Memory flags (#2466)</li>
<li>[FEATURE] Support <code>--max-samples</code> flag in QuerySpec (#2505)</li>
<li>[FEATURE] Adding kustomization files for remote bases (#2497)</li>
<li>[FEATURE] Allow disabling limits on sidecars (#2560)</li>
<li>[FEATURE] Modify arbitrary parts of the operator generated containers (#2445)</li>
<li>[ENHANCEMENT] Add proper Operator labels as recommended by SIG-Apps (#2427)</li>
<li>[ENHANCEMENT] Watch ConfigMaps having the prometheus-name selector (#2454)</li>
<li>[ENHANCEMENT] Add prometheusExternalLabelName field to Prometheus object (#2430)</li>
<li>[ENHANCEMENT] Optional secret in scrapeconfig (#2511)</li>
<li>[ENHANCEMENT] Update PodSecurityContext docs (#2569)</li>
<li>[ENHANCEMENT] Update Kubernetes client libraries to 1.14.0 (#2570)</li>
<li>[ENHANCEMENT] Use Go modules with Kubernetes 1.14 (#2571)</li>
<li>[ENHANCEMENT] Update to Alertmanager v0.17.0 (#2587)</li>
<li>[ENHANCEMENT] Add support for setting Log Format for Alertmanager (#2577)</li>
<li>[ENHANCEMENT] Switch Deployments and StatefulSets from apps/v1beta to apps/v1 (#2593)</li>
<li>[ENHANCEMENT] Add Service and Servicemonitor to bundle.yaml (#2595)</li>
<li>[BUGFIX] Fix startup nodeSyncEndpoints (#2475)</li>
<li>[BUGIFX] Update Thanos vendoring to include config reloader fixes (#2504)</li>
</ul>
<h2 id="0-29-0-2019-02-19"><a href="#0-29-0-2019-02-19" class="headerlink" title="0.29.0 / 2019-02-19"></a>0.29.0 / 2019-02-19</h2><ul>
<li>[FEATURE] Thanos sidecar supports external Thanos clusters (#2412)</li>
<li>[FEATURE] Make replicas external label name configurable (#2411)</li>
<li>[FEATURE] Flags for config reloader memory and cpu limits (#2403)</li>
<li>[ENHANCEMENT] Update to Prometheus v2.7.1 as default (#2374)</li>
<li>[ENHANCEMENT] Update to Alertmanager v0.16.1 as default (#2362)</li>
</ul>
<h2 id="0-28-0-2019-01-24"><a href="#0-28-0-2019-01-24" class="headerlink" title="0.28.0 / 2019-01-24"></a>0.28.0 / 2019-01-24</h2><ul>
<li>[FEATURE] CLI tool to lint YAML against CRD definitions (#2269)</li>
<li>[FEATURE] Support Thanos v0.2 arbitrary object storage configuration (#2264)</li>
<li>[ENHANCEMENT] Update Alertmanager to v0.16.0 (#2145)</li>
<li>[ENHANCEMENT] Added AlertResendDelay to Prometheus resource (#2265)</li>
<li>[ENHANCEMENT] Support min_shards configuration of the queueConfig (#2284)</li>
<li>[ENHANCEMENT] Write compressed Prometheus config into Kubernetes Secret (#2243)</li>
<li>[ENHANCEMENT] Add flag to enable Prometheus web admin API (#2300)</li>
<li>[ENHANCEMENT] Add logFormat support for Prometheus (#2307)</li>
<li>[ENHANCEMENT] Configure Thanos sidecar with route prefix (#2345)</li>
<li>[BUGFIX] Fix omitting source_labels where they are unnecessary (#2292)</li>
<li>[BUGFIX] Guard against nil targetPort (#2318)</li>
</ul>
<h2 id="0-27-0-2019-01-08"><a href="#0-27-0-2019-01-08" class="headerlink" title="0.27.0 / 2019-01-08"></a>0.27.0 / 2019-01-08</h2><ul>
<li>[FEATURE] Add <code>image</code> field to specify full Prometheus, Alertmanager and Thanos images.</li>
<li>[FEATURE] Add prometheus query options (lookback-delta, max-concurrency, timeout).</li>
</ul>
<h2 id="0-26-0-2018-11-30"><a href="#0-26-0-2018-11-30" class="headerlink" title="0.26.0 / 2018-11-30"></a>0.26.0 / 2018-11-30</h2><ul>
<li>[CHANGE] Remove attempting to set “secure” security context (#2109).</li>
<li>[CHANGE] Remove deprecated StorageSpec fields (#2132).</li>
<li>[ENHANCEMENT] Better handling for pod/node labels from ServiceMonitors (#2089).</li>
<li>[ENHANCEMENT] Update to Prometheus v2.5.0 as default (#2101).</li>
<li>[ENHANCEMENT] Update to Alertmanager v0.15.3 as default (#2128).</li>
<li>[ENHANCEMENT] Increase CPU limits for small containers to not being throttled as much (#2144).</li>
<li>[BUGFIX] Sanitize thanos secret volume mount name (#2159).</li>
<li>[BUGFIX] Fix racy Kubernetes multi watch (#2177).</li>
</ul>
<h2 id="0-25-0-2018-10-24"><a href="#0-25-0-2018-10-24" class="headerlink" title="0.25.0 / 2018-10-24"></a>0.25.0 / 2018-10-24</h2><ul>
<li>[FEATURE] Allow passing additional alert relabel configs in Prometheus custom resource (#2022)</li>
<li>[FEATURE] Add ability to mount custom ConfigMaps into Alertmanager and Prometheus (#2028)</li>
</ul>
<h2 id="0-24-0-2018-10-11"><a href="#0-24-0-2018-10-11" class="headerlink" title="0.24.0 / 2018-10-11"></a>0.24.0 / 2018-10-11</h2><p>This release has a breaking changes for <code>prometheus_operator_.*</code> metrics.</p>
<p><code>prometheus_operator_alertmanager_reconcile_errors_total</code> and <code>prometheus_operator_prometheus_reconcile_errors_total</code><br>are now combined and called <code>prometheus_operator_reconcile_errors_total</code>.<br>Instead the metric has a “controller” label which indicates the errors from the Prometheus or Alertmanager controller.</p>
<p>The same happened with <code>prometheus_operator_alertmanager_spec_replicas</code> and <code>prometheus_operator_prometheus_spec_replicas</code><br>which is now called <code>prometheus_operator_spec_replicas</code> and also has the “controller” label.</p>
<p>The <code>prometheus_operator_triggered_total</code> metric now has a “controller” label as well and finally instruments the<br>Alertmanager controller.</p>
<p>For a full description see: <a target="_blank" rel="noopener" href="https://github.com/coreos/prometheus-operator/pull/1984#issue-221139702">https://github.com/coreos/prometheus-operator/pull/1984#issue-221139702</a></p>
<p>In order to support multiple namespaces, the <code>--namespace</code> flag changed to <code>--namespaces</code><br>and accepts and comma-separated list of namespaces as a string.</p>
<ul>
<li>[CHANGE] Default to Node Exporter v0.16.0 (#1812)</li>
<li>[CHANGE] Update to Go 1.11 (#1855)</li>
<li>[CHANGE] Default to Prometheus v2.4.3 (#1929) (#1983)</li>
<li>[CHANGE] Default to Thanos v0.1.0 (#1954)</li>
<li>[CHANGE] Overhaul metrics while adding triggerBy metric for Alertmanager (#1984)</li>
<li>[CHANGE] Add multi namespace support (#1813)</li>
<li>[FEATURE] Add SHA field to Prometheus, Alertmanager and Thanos for images (#1847) (#1854)</li>
<li>[FEATURE] Add configuration for priority class to be assigned to Pods (#1875)</li>
<li>[FEATURE] Configure sampleLimit per ServiceMonitor (#1895)</li>
<li>[FEATURE] Add additionalPeers to Alertmanager (#1878)</li>
<li>[FEATURE] Add podTargetLabels to ServiceMonitors (#1880)</li>
<li>[FEATURE] Relabel target name for Pods (#1896)</li>
<li>[FEATURE] Allow configuration of relabel_configs per ServiceMonitor (#1879)</li>
<li>[FEATURE] Add illegal update reconciliation by deleting StatefulSet (#1931)</li>
<li>[ENHANCEMENT] Set Thanos cluster and grpc ip from pod.ip (#1836)</li>
<li>[BUGFIX] Add square brackets around pod IPs for IPv6 support (#1881)</li>
<li>[BUGFIX] Allow periods in secret name (#1907)</li>
<li>[BUGFIX] Add BearerToken in generateRemoteReadConfig (#1956)</li>
</ul>
<h2 id="0-23-2-2018-08-23"><a href="#0-23-2-2018-08-23" class="headerlink" title="0.23.2 / 2018-08-23"></a>0.23.2 / 2018-08-23</h2><ul>
<li>[BUGFIX] Do not abort kubelet endpoints update due to nodes without IP addresses defined (#1816)</li>
</ul>
<h2 id="0-23-1-2018-08-13"><a href="#0-23-1-2018-08-13" class="headerlink" title="0.23.1 / 2018-08-13"></a>0.23.1 / 2018-08-13</h2><ul>
<li>[BUGFIX] Fix high CPU usage of Prometheus Operator when annotating Prometheus resource (#1785)</li>
</ul>
<h2 id="0-23-0-2018-08-06"><a href="#0-23-0-2018-08-06" class="headerlink" title="0.23.0 / 2018-08-06"></a>0.23.0 / 2018-08-06</h2><ul>
<li>[CHANGE] Deprecate specification of Prometheus rules via ConfigMaps in favor of <code>PrometheusRule</code> CRDs</li>
<li>[FEATURE] Introduce new flag to control logging format (#1475)</li>
<li>[FEATURE] Ensure Prometheus Operator container runs as <code>nobody</code> user by default (#1393)</li>
<li>[BUGFIX] Fix reconciliation of Prometheus StatefulSets due to ServiceMonitors and PrometheusRules changes when a single namespace is being watched (#1749)</li>
</ul>
<h2 id="0-22-2-2018-07-24"><a href="#0-22-2-2018-07-24" class="headerlink" title="0.22.2 / 2018-07-24"></a>0.22.2 / 2018-07-24</h2><p>[BUGFIX] Do not migrate rule config map for Prometheus statefulset on rule config map to PrometheusRule migration (#1679)</p>
<h2 id="0-22-1-2018-07-19"><a href="#0-22-1-2018-07-19" class="headerlink" title="0.22.1 / 2018-07-19"></a>0.22.1 / 2018-07-19</h2><ul>
<li>[ENHANCEMENT] Enable operation when CRDs are created externally (#1640)</li>
<li>[BUGFIX] Do not watch for new namespaces if a specific namespace has been selected (#1640)</li>
</ul>
<h2 id="0-22-0-2018-07-09"><a href="#0-22-0-2018-07-09" class="headerlink" title="0.22.0 / 2018-07-09"></a>0.22.0 / 2018-07-09</h2><ul>
<li>[FEATURE] Allow setting volume name via volumetemplateclaimtemplate in prom and alertmanager (#1538)</li>
<li>[FEATURE] Allow setting custom tags of container images (#1584) </li>
<li>[ENHANCEMENT] Update default Thanos to v0.1.0-rc.2 (#1585)</li>
<li>[ENHANCEMENT] Split rule config map mounted into Prometheus if it exceeds Kubernetes config map limit (#1562)</li>
<li>[BUGFIX] Mount Prometheus data volume into Thanos sidecar &amp; pass correct path to Thanos sidecar (#1583)</li>
</ul>
<h2 id="0-21-0-2018-06-28"><a href="#0-21-0-2018-06-28" class="headerlink" title="0.21.0 / 2018-06-28"></a>0.21.0 / 2018-06-28</h2><ul>
<li>[CHANGE] Default to Prometheus v2.3.1.</li>
<li>[CHANGE] Default to Alertmanager v0.15.0.</li>
<li>[FEATURE] Make remote write queue configurations configurable.</li>
<li>[FEATURE] Add Thanos integration (experimental).</li>
<li>[BUGFIX] Fix usage of console templates and libraries.</li>
</ul>
<h2 id="0-20-0-2018-06-05"><a href="#0-20-0-2018-06-05" class="headerlink" title="0.20.0 / 2018-06-05"></a>0.20.0 / 2018-06-05</h2><p>With this release we introduce a new Custom Resource Definition - the<br><code>PrometheusRule</code> CRD. It addresses the need for rule syntax validation and rule<br>selection across namespaces. <code>PrometheusRule</code> replaces the configuration of<br>Prometheus rules via K8s ConfigMaps. There are two migration paths:</p>
<ol>
<li><p>Automated live migration: If the Prometheus Operator finds Kubernetes<br>ConfigMaps that match the <code>RuleSelector</code> in a <code>Prometheus</code> specification, it<br>will convert them to matching <code>PrometheusRule</code> resources.</p>
</li>
<li><p>Manual migration: We provide a basic CLI tool to convert Kubernetes<br>ConfigMaps to <code>PrometheusRule</code> resources.</p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/coreos/prometheus-operator/cmd/po-rule-migration</span><br><span class="line">po-rule-migration \</span><br><span class="line">--rule-config-map=&lt;path-to-config-map&gt; \</span><br><span class="line">--rule-crds-destination=&lt;path-to-rule-crd-destination&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>[FEATURE] Add leveled logging to Prometheus Operator (#1277)</li>
<li>[FEATURE] Allow additional Alertmanager configuration in Prometheus CRD (#1338)</li>
<li>[FEATURE] Introduce <code>PrometheusRule</code> Custom Resource Definition (#1333)</li>
<li>[ENHANCEMENT] Allow Prometheus to consider all namespaces to find ServiceMonitors (#1278)</li>
<li>[BUGFIX] Do not attempt to set default memory request for Prometheus 2.0 (#1275)</li>
</ul>
<h2 id="0-19-0-2018-04-25"><a href="#0-19-0-2018-04-25" class="headerlink" title="0.19.0 / 2018-04-25"></a>0.19.0 / 2018-04-25</h2><ul>
<li>[FEATURE] Allow specifying additional Prometheus scrape configs via secret (#1246)</li>
<li>[FEATURE] Enable Thanos sidecar (#1219)</li>
<li>[FEATURE] Make AM log level configurable (#1192)</li>
<li>[ENHANCEMENT] Enable Prometheus to select Service Monitors outside own namespace (#1227)</li>
<li>[ENHANCEMENT] Enrich Prometheus operator CRD registration error handling (#1208)</li>
<li>[BUGFIX] Allow up to 10m for Prometheus pod on startup for data recovery (#1232)</li>
</ul>
<h2 id="0-18-1-2018-04-09"><a href="#0-18-1-2018-04-09" class="headerlink" title="0.18.1 / 2018-04-09"></a>0.18.1 / 2018-04-09</h2><ul>
<li>[BUGFIX] Fix alertmanager &gt;=0.15.0 cluster gossip communication (#1193)</li>
</ul>
<h2 id="0-18-0-2018-03-04"><a href="#0-18-0-2018-03-04" class="headerlink" title="0.18.0 / 2018-03-04"></a>0.18.0 / 2018-03-04</h2><p>From this release onwards only Kubernetes versions v1.8 and higher are supported. If you have an older version of Kubernetes and the Prometheus Operator running, we recommend upgrading Kubernetes first and then the Prometheus Operator.</p>
<p>While multiple validation issues have been fixed, it will remain a beta feature in this release. If you want to update validations, you need to either apply the CustomResourceDefinitions located in <code>example/prometheus-operator-crd</code> or delete all CRDs and restart the Prometheus Operator.</p>
<p>Some changes cause Prometheus and Alertmanager clusters to be redeployed. If you do not have persistent storage backing your data, this means you will loose the amount of data equal to your retention time.</p>
<ul>
<li>[CHANGE] Use canonical <code>/prometheus</code> and <code>/alertmanager</code> as data dirs in containers.</li>
<li>[FEATURE] Allow configuring Prometheus and Alertmanager servers to listen on loopback interface, allowing proxies to be the ingress point of those Pods.</li>
<li>[FEATURE] Allow configuring additional containers in Prometheus and Alertmanager Pods.</li>
<li>[FEATURE] Add ability to whitelist Kubernetes labels to become Prometheus labels.</li>
<li>[FEATURE] Allow specifying additional secrets for Alertmanager Pods to mount.</li>
<li>[FEATURE] Allow specifying <code>bearer_token_file</code> for Alertmanger configurations of Prometheus objects in order to authenticate with Alertmanager.</li>
<li>[FEATURE] Allow specifying TLS configuration for Alertmanger configurations of Prometheus objects.</li>
<li>[FEATURE] Add metrics for reconciliation errors: <code>prometheus_operator_alertmanager_reconcile_errors_total</code> and <code>prometheus_operator_prometheus_reconcile_errors_total</code>.</li>
<li>[FEATURE] Support <code>read_recent</code> and <code>required_matchers</code> fields for remote read configurations.</li>
<li>[FEATURE] Allow disabling any defaults of <code>SecurityContext</code> fields of Pods.</li>
<li>[BUGFIX] Handle Alertmanager &gt;=v0.15.0 breaking changes correctly.</li>
<li>[BUGFIX] Fix invalid validations for metric relabeling fields.</li>
<li>[BUGFIX] Fix validations for <code>AlertingSpec</code>.</li>
<li>[BUGFIX] Fix validations for deprecated storage fields.</li>
<li>[BUGFIX] Fix remote read and write basic auth support.</li>
<li>[BUGFIX] Fix properly propagate errors of Prometheus config reloader.</li>
</ul>
<h2 id="0-17-0-2018-02-15"><a href="#0-17-0-2018-02-15" class="headerlink" title="0.17.0 / 2018-02-15"></a>0.17.0 / 2018-02-15</h2><p>This release adds validations as a beta feature. It will only be installed on new clusters, existing CRD definitions will not be updated, this will be done in a future release. Please try out this feature and give us feedback!</p>
<ul>
<li>[CHANGE] Default Prometheus version v2.2.0-rc.0.</li>
<li>[CHANGE] Default Alertmanager version v0.14.0.</li>
<li>[FEATURE] Generate and add CRD validations.</li>
<li>[FEATURE] Add ability to set <code>serviceAccountName</code> for Alertmanager Pods.</li>
<li>[FEATURE] Add ability to specify custom <code>securityContext</code> for Alertmanager Pods.</li>
<li>[ENHANCEMENT] Default to non-root security context for Alertmanager Pods.</li>
</ul>
<h2 id="0-16-1-2018-01-16"><a href="#0-16-1-2018-01-16" class="headerlink" title="0.16.1 / 2018-01-16"></a>0.16.1 / 2018-01-16</h2><ul>
<li>[CHANGE] Default to Alertmanager v0.13.0.</li>
<li>[BUGFIX] Alertmanager flags must be double dashed starting v0.13.0.</li>
</ul>
<h2 id="0-16-0-2018-01-11"><a href="#0-16-0-2018-01-11" class="headerlink" title="0.16.0 / 2018-01-11"></a>0.16.0 / 2018-01-11</h2><ul>
<li>[FEATURE] Add support for specifying remote storage configurations.</li>
<li>[FEATURE] Add ability to specify log level.</li>
<li>[FEATURE] Add support for dropping metrics at scrape time.</li>
<li>[ENHANCEMENT] Ensure that resource limit can’t make Pods unschedulable.</li>
<li>[ENHANCEMENT] Allow configuring emptyDir volumes</li>
<li>[BUGFIX] Use <code>--storage.tsdb.no-lockfile</code> for Prometheus 2.0.</li>
<li>[BUGFIX] Fix Alertmanager default storage.path.</li>
</ul>
<h2 id="0-15-0-2017-11-22"><a href="#0-15-0-2017-11-22" class="headerlink" title="0.15.0 / 2017-11-22"></a>0.15.0 / 2017-11-22</h2><ul>
<li>[CHANGE] Default Prometheus version v2.0.0</li>
<li>[BUGFIX] Generate ExternalLabels deterministically</li>
<li>[BUGFIX] Fix incorrect mount path of Alertmanager data volume</li>
<li>[EXPERIMENTAL] Add ability to specify CRD Kind name</li>
</ul>
<h2 id="0-14-1-2017-11-01"><a href="#0-14-1-2017-11-01" class="headerlink" title="0.14.1 / 2017-11-01"></a>0.14.1 / 2017-11-01</h2><ul>
<li>[BUGFIX] Ignore illegal change of PodManagementPolicy to StatefulSet.</li>
</ul>
<h2 id="0-14-0-2017-10-19"><a href="#0-14-0-2017-10-19" class="headerlink" title="0.14.0 / 2017-10-19"></a>0.14.0 / 2017-10-19</h2><ul>
<li>[CHANGE] Default Prometheus version v2.0.0-rc.1.</li>
<li>[CHANGE] Default Alertmanager version v0.9.1.</li>
<li>[BUGFIX] Set StatefulSet replicas to 0 if 0 is specified in Alertmanager/Prometheus object.</li>
<li>[BUGFIX] Glob for all files in a ConfigMap as rule files.</li>
<li>[FEATURE] Add ability to run Prometheus Operator for a single namespace.</li>
<li>[FEATURE] Add ability to specify CRD api group.</li>
<li>[FEATURE] Use readiness and health endpoints of Prometheus 1.8+.</li>
<li>[ENHANCEMENT] Add OwnerReferences to managed objects.</li>
<li>[ENHANCEMENT] Use parallel pod creation strategy for Prometheus StatefulSets.</li>
</ul>
<h2 id="0-13-0-2017-09-21"><a href="#0-13-0-2017-09-21" class="headerlink" title="0.13.0 / 2017-09-21"></a>0.13.0 / 2017-09-21</h2><p>After a long period of not having broken any functionality in the Prometheus Operator, we have decided to promote the status of this project to beta.</p>
<p>Compatibility guarantees and migration strategies continue to be the same as for the <code>v0.12.0</code> release.</p>
<ul>
<li>[CHANGE] Remove analytics collection.</li>
<li>[BUGFIX] Fix memory leak in kubelet endpoints sync.</li>
<li>[FEATURE] Allow setting global default <code>scrape_interval</code>.</li>
<li>[FEATURE] Allow setting Pod objectmeta to Prometheus and Alertmanger objects.</li>
<li>[FEATURE] Allow setting tolerations and affinity for Prometheus and Alertmanager objects.</li>
</ul>
<h2 id="0-12-0-2017-08-24"><a href="#0-12-0-2017-08-24" class="headerlink" title="0.12.0 / 2017-08-24"></a>0.12.0 / 2017-08-24</h2><p>Starting with this release only Kubernetes <code>v1.7.x</code> and up is supported as CustomResourceDefinitions are a requirement for the Prometheus Operator and are only available from those versions and up.</p>
<p>Additionally all objects have been promoted from <code>v1alpha1</code> to <code>v1</code>. On start up of this version of the Prometheus Operator the previously used <code>ThirdPartyResource</code>s and the associated <code>v1alpha1</code> objects will be automatically migrated to their <code>v1</code> equivalent <code>CustomResourceDefinition</code>.</p>
<ul>
<li>[CHANGE] All manifests created and used by the Prometheus Operator have been promoted from <code>v1alpha1</code> to <code>v1</code>.</li>
<li>[CHANGE] Use Kubernetes <code>CustomResourceDefinition</code>s instead of <code>ThirdPartyResource</code>s.</li>
<li>[FEATURE] Add ability to set scrape timeout to <code>ServiceMonitor</code>.</li>
<li>[ENHANCEMENT] Use <code>StatefulSet</code> rolling deployments.</li>
<li>[ENHANCEMENT] Properly set <code>SecurityContext</code> for Prometheus 2.0 deployments.</li>
<li>[ENHANCEMENT] Enable web lifecycle APIs for Prometheus 2.0 deployments.</li>
</ul>
<h2 id="0-11-2-2017-09-21"><a href="#0-11-2-2017-09-21" class="headerlink" title="0.11.2 / 2017-09-21"></a>0.11.2 / 2017-09-21</h2><ul>
<li>[BUGFIX] Fix memory leak in kubelet endpoints sync.</li>
</ul>
<h2 id="0-11-1-2017-07-28"><a href="#0-11-1-2017-07-28" class="headerlink" title="0.11.1 / 2017-07-28"></a>0.11.1 / 2017-07-28</h2><ul>
<li>[ENHANCEMENT] Add profiling endpoints.</li>
<li>[BUGFIX] Adapt Alertmanager storage usage to not use deprecated storage definition.</li>
</ul>
<h2 id="0-11-0-2017-07-20"><a href="#0-11-0-2017-07-20" class="headerlink" title="0.11.0 / 2017-07-20"></a>0.11.0 / 2017-07-20</h2><p>Warning: This release deprecates the previously used storage definition in favor of upstream PersistentVolumeClaim templates. While this should not have an immediate effect on a running cluster, Prometheus object definitions that have storage configured need to be adapted. The previously existing fields are still there, but have no effect anymore.</p>
<ul>
<li>[FEATURE] Add Prometheus 2.0 alpha3 support.</li>
<li>[FEATURE] Use PVC templates instead of custom storage definition.</li>
<li>[FEATURE] Add cAdvisor port to kubelet sync.</li>
<li>[FEATURE] Allow default base images to be configurable.</li>
<li>[FEATURE] Configure Prometheus to only use necessary namespaces.</li>
<li>[ENHANCEMENT] Improve rollout detection for Alertmanager clusters.</li>
<li>[BUGFIX] Fix targetPort relabeling.</li>
</ul>
<h2 id="0-10-2-2017-06-21"><a href="#0-10-2-2017-06-21" class="headerlink" title="0.10.2 / 2017-06-21"></a>0.10.2 / 2017-06-21</h2><ul>
<li>[BUGFIX] Use computed route prefix instead of directly from manifest.</li>
</ul>
<h2 id="0-10-1-2017-06-13"><a href="#0-10-1-2017-06-13" class="headerlink" title="0.10.1 / 2017-06-13"></a>0.10.1 / 2017-06-13</h2><p>Attention: if the basic auth feature was previously used, the <code>key</code> and <code>name</code><br>fields need to be switched. This was not intentional, and the bug is not fixed,<br>but causes this change.</p>
<ul>
<li>[CHANGE] Prometheus default version v1.7.1.</li>
<li>[CHANGE] Alertmanager default version v0.7.1.</li>
<li>[BUGFIX] Fix basic auth secret key selector <code>key</code> and <code>name</code> switched.</li>
<li>[BUGFIX] Fix route prefix flag not always being set for Prometheus.</li>
<li>[BUGFIX] Fix nil panic on replica metrics.</li>
<li>[FEATURE] Add ability to specify Alertmanager path prefix for Prometheus.</li>
</ul>
<h2 id="0-10-0-2017-06-09"><a href="#0-10-0-2017-06-09" class="headerlink" title="0.10.0 / 2017-06-09"></a>0.10.0 / 2017-06-09</h2><ul>
<li>[CHANGE] Prometheus route prefix defaults to root.</li>
<li>[CHANGE] Default to Prometheus v1.7.0.</li>
<li>[CHANGE] Default to Alertmanager v0.7.0.</li>
<li>[FEATURE] Add route prefix support to Alertmanager resource.</li>
<li>[FEATURE] Add metrics on expected replicas.</li>
<li>[FEATURE] Support for runing Alertmanager v0.7.0.</li>
<li>[BUGFIX] Fix sensitive rollout triggering.</li>
</ul>
<h2 id="0-9-1-2017-05-18"><a href="#0-9-1-2017-05-18" class="headerlink" title="0.9.1 / 2017-05-18"></a>0.9.1 / 2017-05-18</h2><ul>
<li>[FEATURE] Add experimental Prometheus 2.0 support.</li>
<li>[FEATURE] Add support for setting Prometheus external labels.</li>
<li>[BUGFIX] Fix non-deterministic config generation.</li>
</ul>
<h2 id="0-9-0-2017-05-09"><a href="#0-9-0-2017-05-09" class="headerlink" title="0.9.0 / 2017-05-09"></a>0.9.0 / 2017-05-09</h2><ul>
<li>[CHANGE] The <code>kubelet-object</code> flag has been renamed to <code>kubelet-service</code>.</li>
<li>[CHANGE] Remove automatic relabelling of Pod and Service labels onto targets.</li>
<li>[CHANGE] Remove “non-namespaced” alpha annotation in favor of <code>honor_labels</code>.</li>
<li>[FEATURE] Add ability make use of the Prometheus <code>honor_labels</code> configuration option.</li>
<li>[FEATURE] Add ability to specify image pull secrets for Prometheus and Alertmanager pods.</li>
<li>[FEATURE] Add basic auth configuration option through ServiceMonitor.</li>
<li>[ENHANCEMENT] Add liveness and readiness probes to Prometheus and Alertmanger pods.</li>
<li>[ENHANCEMENT] Add default resource requests for Alertmanager pods.</li>
<li>[ENHANCEMENT] Fallback to ExternalIPs when InternalIPs are not available in kubelet sync.</li>
<li>[ENHANCEMENT] Improved change detection to trigger Prometheus rollout.</li>
<li>[ENHANCEMENT] Do not delete unmanaged Prometheus configuration Secret.</li>
</ul>
<h2 id="0-8-2-2017-04-20"><a href="#0-8-2-2017-04-20" class="headerlink" title="0.8.2 / 2017-04-20"></a>0.8.2 / 2017-04-20</h2><ul>
<li>[ENHANCEMENT] Use new Prometheus 1.6 storage flags and make it default.</li>
</ul>
<h2 id="0-8-1-2017-04-13"><a href="#0-8-1-2017-04-13" class="headerlink" title="0.8.1 / 2017-04-13"></a>0.8.1 / 2017-04-13</h2><ul>
<li>[ENHANCEMENT] Include kubelet insecure port in kubelet Enpdoints object.</li>
</ul>
<h2 id="0-8-0-2017-04-07"><a href="#0-8-0-2017-04-07" class="headerlink" title="0.8.0 / 2017-04-07"></a>0.8.0 / 2017-04-07</h2><ul>
<li>[FEATURE] Add ability to mount custom secrets into Prometheus Pods. Note that<br>secrets cannot be modified after creation, if the list if modified after<br>creation it will not effect the Prometheus Pods.</li>
<li>[FEATURE] Attach pod and service name as labels to Pod targets.</li>
</ul>
<h2 id="0-7-0-2017-03-17"><a href="#0-7-0-2017-03-17" class="headerlink" title="0.7.0 / 2017-03-17"></a>0.7.0 / 2017-03-17</h2><p>This release introduces breaking changes to the generated StatefulSet’s<br>PodTemplate, which cannot be modified for StatefulSets. The Prometheus and<br>Alertmanager objects have to be deleted and recreated for the StatefulSets to<br>be created properly.</p>
<ul>
<li>[CHANGE] Use Secrets instead of ConfigMaps for configurations.</li>
<li>[FEATURE] Allow ConfigMaps containing rules to be selected via label selector.</li>
<li>[FEATURE] <code>nodeSelector</code> added to the Alertmanager kind.</li>
<li>[ENHANCEMENT] Use Prometheus v2 chunk encoding by default.</li>
<li>[BUGFIX] Fix Alertmanager cluster mesh initialization.</li>
</ul>
<h2 id="0-6-0-2017-02-28"><a href="#0-6-0-2017-02-28" class="headerlink" title="0.6.0 / 2017-02-28"></a>0.6.0 / 2017-02-28</h2><ul>
<li>[FEATURE] Allow not tagging targets with the <code>namespace</code> label.</li>
<li>[FEATURE] Allow specifying <code>ServiceAccountName</code> to be used by Prometheus pods.</li>
<li>[ENHANCEMENT] Label governing services to uniquely identify them.</li>
<li>[ENHANCEMENT] Reconcile Service and Endpoints objects.</li>
<li>[ENHANCEMENT] General stability improvements.</li>
<li>[BUGFIX] Hostname cannot be fqdn when syncing kubelets into Endpoints object.</li>
</ul>
<h2 id="0-5-1-2017-02-17"><a href="#0-5-1-2017-02-17" class="headerlink" title="0.5.1 / 2017-02-17"></a>0.5.1 / 2017-02-17</h2><ul>
<li>[BUGFIX] Use correct governing <code>Service</code> for Prometheus <code>StatefulSet</code>.</li>
</ul>
<h2 id="0-5-0-2017-02-15"><a href="#0-5-0-2017-02-15" class="headerlink" title="0.5.0 / 2017-02-15"></a>0.5.0 / 2017-02-15</h2><ul>
<li>[FEATURE] Allow synchronizing kubelets into an <code>Endpoints</code> object.</li>
<li>[FEATURE] Allow specifying custom configmap-reload image</li>
</ul>
<h2 id="0-4-0-2017-02-02"><a href="#0-4-0-2017-02-02" class="headerlink" title="0.4.0 / 2017-02-02"></a>0.4.0 / 2017-02-02</h2><ul>
<li>[CHANGE] Split endpoint and job in separate labels instead of a single<br>concatenated one.</li>
<li>[BUGFIX] Properly exit on errors communicating with the apiserver.</li>
</ul>
<h2 id="0-3-0-2017-01-31"><a href="#0-3-0-2017-01-31" class="headerlink" title="0.3.0 / 2017-01-31"></a>0.3.0 / 2017-01-31</h2><p>This release introduces breaking changes to the underlying naming schemes. It<br>is recommended to destroy existing Prometheus and Alertmanager objects and<br>recreate them with new namings.</p>
<p>With this release support for <code>v1.4.x</code> clusters is dropped. Changes will not be<br>backported to the <code>0.1.x</code> release series anymore.</p>
<ul>
<li>[CHANGE] Prefixed StatefulSet namings based on managing resource</li>
<li>[FEATURE] Pass labels and annotations through to StatefulSets</li>
<li>[FEATURE] Add tls config to use for Prometheus target scraping</li>
<li>[FEATURE] Add configurable <code>routePrefix</code> for Prometheus</li>
<li>[FEATURE] Add node selector to Prometheus TPR</li>
<li>[ENHANCEMENT] Stability improvements</li>
</ul>
<h2 id="0-2-3-2017-01-05"><a href="#0-2-3-2017-01-05" class="headerlink" title="0.2.3 / 2017-01-05"></a>0.2.3 / 2017-01-05</h2><ul>
<li>[BUGFIX] Fix config reloading when using external url.</li>
</ul>
<h2 id="0-1-3-2017-01-05"><a href="#0-1-3-2017-01-05" class="headerlink" title="0.1.3 / 2017-01-05"></a>0.1.3 / 2017-01-05</h2><p>The <code>0.1.x</code> releases are backport releases with Kubernetes <code>v1.4.x</code> compatibility.</p>
<ul>
<li>[BUGFIX] Fix config reloading when using external url.</li>
</ul>
<h2 id="0-2-2-2017-01-03"><a href="#0-2-2-2017-01-03" class="headerlink" title="0.2.2 / 2017-01-03"></a>0.2.2 / 2017-01-03</h2><ul>
<li>[FEATURE] Add ability to set the external url the Prometheus/Alertmanager instances will be available under.</li>
</ul>
<h2 id="0-1-2-2017-01-03"><a href="#0-1-2-2017-01-03" class="headerlink" title="0.1.2 / 2017-01-03"></a>0.1.2 / 2017-01-03</h2><p>The <code>0.1.x</code> releases are backport releases with Kubernetes <code>v1.4.x</code> compatibility.</p>
<ul>
<li>[FEATURE] Add ability to set the external url the Prometheus/Alertmanager instances will be available under.</li>
</ul>
<h2 id="0-2-1-2016-12-23"><a href="#0-2-1-2016-12-23" class="headerlink" title="0.2.1 / 2016-12-23"></a>0.2.1 / 2016-12-23</h2><ul>
<li>[BUGFIX] Fix <code>subPath</code> behavior when not using storage provisioning</li>
</ul>
<h2 id="0-2-0-2016-12-20"><a href="#0-2-0-2016-12-20" class="headerlink" title="0.2.0 / 2016-12-20"></a>0.2.0 / 2016-12-20</h2><p>This release requires a Kubernetes cluster &gt;=1.5.0. See the readme for<br>instructions on how to upgrade if you are currently running on a lower version<br>with the operator.</p>
<ul>
<li>[CHANGE] Use StatefulSet instead of PetSet</li>
<li>[BUGFIX] Fix Prometheus config generation for labels containing “-“</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-FileBeat收集nginx日志"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/"
    >FileBeat收集nginx日志</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/" class="article-date">
  <time datetime="2020-11-20T06:24:23.000Z" itemprop="datePublished">2020-11-20</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a> / <a class="article-category-link" href="/categories/ELK7/FileBeat7/">FileBeat7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="NGINX改为json格式日志"><a href="#NGINX改为json格式日志" class="headerlink" title="NGINX改为json格式日志"></a>NGINX改为json格式日志</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">log_format</span> json <span class="string">&#x27;&#123;&quot;<span class="variable">@timestamp</span>&quot;:&quot;<span class="variable">$time_iso8601</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;host&quot;:&quot;<span class="variable">$server_addr</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;clientip&quot;:&quot;<span class="variable">$remote_addr</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;size&quot;:<span class="variable">$body_bytes_sent</span>,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;responsetime&quot;:<span class="variable">$request_time</span>,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;upstreamtime&quot;:&quot;<span class="variable">$upstream_response_time</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;upstreamhost&quot;:&quot;<span class="variable">$upstream_addr</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;http_host&quot;:&quot;<span class="variable">$host</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;url&quot;:&quot;<span class="variable">$uri</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;domain&quot;:&quot;<span class="variable">$host</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;xff&quot;:&quot;<span class="variable">$http_x_forwarded_for</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;referer&quot;:&quot;<span class="variable">$http_referer</span>&quot;,&#x27;</span></span><br><span class="line">        <span class="string">&#x27;&quot;status&quot;:&quot;<span class="variable">$status</span>&quot;&#125;&#x27;</span>;</span><br><span class="line"><span class="comment">#引用json格式日志</span></span><br><span class="line"><span class="attribute">access_log</span> /var/log/nginx/access.log json;</span><br><span class="line"><span class="comment">#配置错误日志</span></span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log;</span><br></pre></td></tr></table></figure>

<p>FileBeat配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br><span class="line">  <span class="attr">index:</span> <span class="string">&quot;nginx-access-<span class="template-variable">%&#123;[agent.version]&#125;</span>-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;nginx-*&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="kibana简单使用视图统计"><a href="#kibana简单使用视图统计" class="headerlink" title="kibana简单使用视图统计"></a>kibana简单使用视图统计</h1><p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120015655939.png" alt="image-20201120015655939"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120015745522.png" alt="image-20201120015745522"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120020155816.png" alt="image-20201120020155816"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120020408130.png" alt="image-20201120020408130"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120020503524.png" alt="image-20201120020503524"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120020521241.png" alt="image-20201120020521241"></p>
<p><img src="/2020/11/20/FileBeat%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97/image-20201120021559268.png" alt="image-20201120021559268"></p>
<h1 id="添加错误日志收集-并-分别存放在两个不同索引"><a href="#添加错误日志收集-并-分别存放在两个不同索引" class="headerlink" title="添加错误日志收集 并 分别存放在两个不同索引"></a>添加错误日志收集 并 分别存放在两个不同索引</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/var/log/nginx/access.log</span></span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;access&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/var/log/nginx/error.log</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;error&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;nginx-access-<span class="template-variable">%&#123;[agent.version]&#125;</span>-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when.contains:</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">&quot;access&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;nginx-error-<span class="template-variable">%&#123;[agent.version]&#125;</span>-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when.contains:</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">&quot;error&quot;</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;nginx-*&quot;</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FileBeat7/" rel="tag">FileBeat7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-FileBeat"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/FileBeat/"
    >FileBeat部署以及配置</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/FileBeat/" class="article-date">
  <time datetime="2020-11-19T06:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a> / <a class="article-category-link" href="/categories/ELK7/FileBeat7/">FileBeat7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>是一个轻量级的数据采集器</li>
<li>通过监视你指定的文件路径收集并转发到 es, logstash,redis和kafka等</li>
</ul>
<h1 id="主要组件"><a href="#主要组件" class="headerlink" title="主要组件"></a>主要组件</h1><ul>
<li>input(输入)     负责管理收割机在哪个路径找到文件</li>
<li>harvester(收割机)     负责从单文件中逐行读取内容 并将内容发送到输出</li>
</ul>
<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.4.1-x86_64.rpm</span><br><span class="line">yum install -y filebeat-7.4.1-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h1 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="comment">#输入组件</span></span><br><span class="line">filebeat.inputs: </span><br><span class="line"><span class="comment">#定义输入类型 也就是从哪里得到数据 支持 log redis kafka 等</span></span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  <span class="comment"># 是否启用此inputs 默认true</span></span><br><span class="line">  enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 从哪里读取日志 支持通配符</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line">  <span class="comment">#默认是false，将会日志存储在messages字段 如果日志是json格式请改为true</span></span><br><span class="line">  json.keys_under_root: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#覆盖默认的key 使用自定义json格式的key</span></span><br><span class="line">  json.overwrite_keys: <span class="literal">true</span></span><br><span class="line">  <span class="comment">#标签 通常用于判断标签值 从而写到不同的索引</span></span><br><span class="line">  tags：<span class="string">&quot;123&quot;</span></span><br><span class="line">  <span class="comment">#使用正则匹配日志行 被匹配到的行降被过滤不再上传</span></span><br><span class="line">  exclude_lines: [<span class="string">&#x27;^DBG&#x27;</span>]</span><br><span class="line">  <span class="comment">#使用正则匹配日志行 只保留被匹配到的行</span></span><br><span class="line">  include_lines: [<span class="string">&#x27;^ERR&#x27;</span>, <span class="string">&#x27;^WARN&#x27;</span>, <span class="string">&#x27;sshd&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">#正则匹配排除文件</span></span><br><span class="line">  exclude_files: [<span class="string">&#x27;.gz$&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">### Multiline options</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Multiline can be used for log messages spanning multiple lines. This is common</span></span><br><span class="line">  <span class="comment"># for Java Stack Traces or C-Line Continuation</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The regexp Pattern that has to be matched. The example pattern matches all lines starting with [</span></span><br><span class="line">  <span class="comment">#多行匹配正则表达式</span></span><br><span class="line">  multiline.pattern: ^\[</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Defines if the pattern set under pattern should be negated or not. Default is false.</span></span><br><span class="line">  <span class="comment">#符合正则并匹配的行是否合并  ture 是合并  false 是不合并</span></span><br><span class="line">  multiline.negate: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Match can be set to &quot;after&quot; or &quot;before&quot;. It is used to define if lines should be append to a pattern</span></span><br><span class="line">  <span class="comment"># that was (not) matched before or after or as long as a pattern is not matched based on negate.</span></span><br><span class="line">  <span class="comment"># Note: After is the equivalent to previous and before is the equivalent to to next in Logstash+</span></span><br><span class="line">  <span class="comment"># 合并到上一行的末尾(after)还是开头(before)</span></span><br><span class="line">  multiline.match: after</span><br><span class="line">  <span class="comment">#最大合并行数量 默认500</span></span><br><span class="line">  multiline.max_line: 10000</span><br><span class="line"></span><br><span class="line"><span class="comment">#============================= Filebeat modules ===============================</span></span><br><span class="line"></span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  <span class="comment"># Glob pattern for configuration loading</span></span><br><span class="line">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Set to true to enable config reloading</span></span><br><span class="line">  reload.enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Period on which files under path should be checked for changes</span></span><br><span class="line">  <span class="comment">#reload.period: 10s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ General =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The name of the shipper that publishes the network data. It can be used to group</span></span><br><span class="line"><span class="comment"># all the transactions sent by a single shipper in the web interface.</span></span><br><span class="line"><span class="comment">#name:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The tags of the shipper are included in their own field with each</span></span><br><span class="line"><span class="comment"># transaction published.</span></span><br><span class="line"><span class="comment">#tags: [&quot;service-X&quot;, &quot;web-tier&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional fields that you can specify to add additional information to the</span></span><br><span class="line"><span class="comment"># output.</span></span><br><span class="line"><span class="comment">#fields:</span></span><br><span class="line"><span class="comment">#  env: staging</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== Dashboards =====================================</span></span><br><span class="line"><span class="comment"># These settings control loading the sample dashboards to the Kibana index. Loading</span></span><br><span class="line"><span class="comment"># the dashboards is disabled by default and can be enabled either by setting the</span></span><br><span class="line"><span class="comment"># options here or by using the `setup` command.</span></span><br><span class="line"><span class="comment">#setup.dashboards.enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The URL from where to download the dashboards archive. By default this URL</span></span><br><span class="line"><span class="comment"># has a value which is computed based on the Beat name and version. For released</span></span><br><span class="line"><span class="comment"># versions, this URL points to the dashboard archive on the artifacts.elastic.co</span></span><br><span class="line"><span class="comment"># website.</span></span><br><span class="line"><span class="comment">#setup.dashboards.url:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== Kibana =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.</span></span><br><span class="line"><span class="comment"># This requires a Kibana endpoint configuration.</span></span><br><span class="line">setup.kibana:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Kibana Host</span></span><br><span class="line">  <span class="comment"># Scheme and port can be left out and will be set to the default (http and 5601)</span></span><br><span class="line">  <span class="comment"># In case you specify and additional path, the scheme is required: http://localhost:5601/path</span></span><br><span class="line">  <span class="comment"># IPv6 addresses should always be defined as: https://[2001:db8::1]:5601</span></span><br><span class="line">  <span class="comment">#host: &quot;localhost:5601&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Kibana Space ID</span></span><br><span class="line">  <span class="comment"># ID of the Kibana Space into which the dashboards should be loaded. By default,</span></span><br><span class="line">  <span class="comment"># the Default Space will be used.</span></span><br><span class="line">  <span class="comment">#space.id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================= Elastic Cloud ==================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These settings simplify using Filebeat with the Elastic Cloud (https://cloud.elastic.co/).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The cloud.id setting overwrites the `output.elasticsearch.hosts` and</span></span><br><span class="line"><span class="comment"># `setup.kibana.host` options.</span></span><br><span class="line"><span class="comment"># You can find the `cloud.id` in the Elastic Cloud web UI.</span></span><br><span class="line"><span class="comment">#cloud.id:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The cloud.auth setting overwrites the `output.elasticsearch.username` and</span></span><br><span class="line"><span class="comment"># `output.elasticsearch.password` settings. The format is `&lt;user&gt;:&lt;pass&gt;`.</span></span><br><span class="line"><span class="comment">#cloud.auth:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure what output to use when sending the data collected by the beat.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------- Elasticsearch output ------------------------------</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  <span class="comment"># es列表</span></span><br><span class="line">  hosts: [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br><span class="line">  <span class="comment">#定义索引名称 </span></span><br><span class="line">  index: <span class="string">&quot;system-%&#123;[agent.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">  <span class="comment">#协议</span></span><br><span class="line">  <span class="comment">#protocol: &quot;https&quot;</span></span><br><span class="line">  <span class="comment">#用户密码</span></span><br><span class="line">  <span class="comment">#username: &quot;elastic&quot;</span></span><br><span class="line">  <span class="comment">#password: &quot;changeme&quot;</span></span><br><span class="line"><span class="comment">#----------------------------- Redis output --------------------------------</span></span><br><span class="line"><span class="comment">#通常不建议使用redis做消息队列 因为他是基于内存的 对内存资源消耗成本比较大</span></span><br><span class="line">output.redis:</span><br><span class="line">  <span class="comment"># Redis集群地址列表</span></span><br><span class="line">  hosts: [<span class="string">&quot;192.168.80.107:7001&quot;</span>,<span class="string">&quot;192.168.80.107:7002&quot;</span>]</span><br><span class="line">  <span class="comment"># Redis集群key</span></span><br><span class="line">  key: messages_secure</span><br><span class="line">  password: foobar2000</span><br><span class="line">  <span class="comment"># 集群模式下只能用第0数据库，填写其他的可能会报错</span></span><br><span class="line">  db: 0</span><br><span class="line"><span class="comment">#----------------------------- kafka output --------------------------------</span></span><br><span class="line">output.kafka:</span><br><span class="line">  <span class="comment"># kafka 列表</span></span><br><span class="line">  hosts: [<span class="string">&quot;kafka1:9092&quot;</span>, <span class="string">&quot;kafka2:9092&quot;</span>, <span class="string">&quot;kafka3:9092&quot;</span>]</span><br><span class="line">  <span class="comment"># topic 名字</span></span><br><span class="line">  topic: <span class="string">&#x27;%&#123;[fields.log_topic]&#125;&#x27;</span></span><br><span class="line">  <span class="comment"># topic 判断</span></span><br><span class="line">  topics:</span><br><span class="line">    - topic: <span class="string">&quot;critical-%&#123;[agent.version]&#125;&quot;</span></span><br><span class="line">      when.contains:</span><br><span class="line">        message: <span class="string">&quot;CRITICAL&quot;</span></span><br><span class="line">    - topic: <span class="string">&quot;error-%&#123;[agent.version]&#125;&quot;</span></span><br><span class="line">      when.contains:</span><br><span class="line">        message: <span class="string">&quot;ERR&quot;</span></span><br><span class="line">        </span><br><span class="line">  partition.round_robin:			<span class="comment">#topic分区策略，默认为hash</span></span><br><span class="line">    reachable_only: <span class="literal">false</span>			<span class="comment">#默认情况下，所有分区程序都会尝试将事件发布到所有分区。设置为true，则事件将仅发布到可用分区。</span></span><br><span class="line"></span><br><span class="line">  required_acks: 1				   <span class="comment">#ack确认消息</span></span><br><span class="line">  broker_timeout: 10s               <span class="comment">#等待ack确认超时 </span></span><br><span class="line">  bulk_max_size: 2048               <span class="comment">#单个Kafka请求中批量处理的最大事件数</span></span><br><span class="line">  compression: gzip                 <span class="comment">#压缩格式</span></span><br><span class="line">  compression_level: 4              <span class="comment">#压缩等级1-9 默认4</span></span><br><span class="line">  max_message_bytes: 1000000        <span class="comment">#JSON编码消息的最大允许大小。更大的消息将被删除</span></span><br><span class="line">  keep_alive: 60                    <span class="comment">#网络活动保持连接 默认0</span></span><br><span class="line"><span class="comment">#==================== Elasticsearch template setting ==========================</span></span><br><span class="line"><span class="comment">#索引生命周期ilm功能 默认开启 开启后索引名称将不能自定义</span></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span> </span><br><span class="line"><span class="comment">#定义模板名称</span></span><br><span class="line">setup.template.name: <span class="string">&quot;system&quot;</span></span><br><span class="line"><span class="comment">#使用统配匹配索引名称 如果匹配将使用此模板</span></span><br><span class="line">setup.template.pattern: <span class="string">&quot;system*&quot;</span></span><br><span class="line"><span class="comment">#模板相关设置   这里不推荐在这里修改shard数量以及副本数量 后面会说另一种方法</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  <span class="comment">#shard数量</span></span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  <span class="comment">#副本数量</span></span><br><span class="line">  index.number_of_replicas: 1</span><br><span class="line">  <span class="comment">#index.codec: best_compression</span></span><br><span class="line">  <span class="comment">#_source.enabled: false</span></span><br><span class="line"><span class="comment">#----------------------------- Logstash output --------------------------------</span></span><br><span class="line"><span class="comment">#output.logstash:</span></span><br><span class="line">  <span class="comment"># The Logstash hosts</span></span><br><span class="line">  <span class="comment">#hosts: [&quot;localhost:5044&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Optional SSL. By default is off.</span></span><br><span class="line">  <span class="comment"># List of root certificates for HTTPS server verifications</span></span><br><span class="line">  <span class="comment">#ssl.certificate_authorities: [&quot;/etc/pki/root/ca.pem&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Certificate for SSL client authentication</span></span><br><span class="line">  <span class="comment">#ssl.certificate: &quot;/etc/pki/client/cert.pem&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Client Certificate Key</span></span><br><span class="line">  <span class="comment">#ssl.key: &quot;/etc/pki/client/cert.key&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Processors =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure processors to enhance or manipulate events generated by the beat.</span></span><br><span class="line"></span><br><span class="line">processors:</span><br><span class="line">  - add_host_metadata: ~</span><br><span class="line">  - add_cloud_metadata: ~</span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Logging =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets log level. The default log level is info.</span></span><br><span class="line"><span class="comment"># Available log levels are: error, warning, info, debug</span></span><br><span class="line"><span class="comment">#logging.level: debug</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># At debug level, you can selectively enable logging only for some components.</span></span><br><span class="line"><span class="comment"># To enable all selectors use [&quot;*&quot;]. Examples of other selectors are &quot;beat&quot;,</span></span><br><span class="line"><span class="comment"># &quot;publish&quot;, &quot;service&quot;.</span></span><br><span class="line"><span class="comment">#logging.selectors: [&quot;*&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================== X-Pack Monitoring ===============================</span></span><br><span class="line"><span class="comment"># filebeat can export internal metrics to a central Elasticsearch monitoring</span></span><br><span class="line"><span class="comment"># cluster.  This requires xpack monitoring to be enabled in Elasticsearch.  The</span></span><br><span class="line"><span class="comment"># reporting is disabled by default.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set to true to enable the monitoring reporter.</span></span><br><span class="line"><span class="comment">#monitoring.enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Sets the UUID of the Elasticsearch cluster under which monitoring data for this</span></span><br><span class="line"><span class="comment"># Filebeat instance will appear in the Stack Monitoring UI. If output.elasticsearch</span></span><br><span class="line"><span class="comment"># is enabled, the UUID is derived from the Elasticsearch cluster referenced by output.elasticsearch.</span></span><br><span class="line"><span class="comment">#monitoring.cluster_uuid:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment to send the metrics to Elasticsearch. Most settings from the</span></span><br><span class="line"><span class="comment"># Elasticsearch output are accepted here as well.</span></span><br><span class="line"><span class="comment"># Note that the settings should point to your Elasticsearch *monitoring* cluster.</span></span><br><span class="line"><span class="comment"># Any setting that is not set is automatically inherited from the Elasticsearch</span></span><br><span class="line"><span class="comment"># output configuration, so if you have the Elasticsearch output configured such</span></span><br><span class="line"><span class="comment"># that it is pointing to your Elasticsearch monitoring cluster, you can simply</span></span><br><span class="line"><span class="comment"># uncomment the following line.</span></span><br><span class="line"><span class="comment">#monitoring.elasticsearch:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="收集系统日志并修改分片数量"><a href="#收集系统日志并修改分片数量" class="headerlink" title="收集系统日志并修改分片数量"></a>收集系统日志并修改分片数量</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs: </span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">  - /var/<span class="built_in">log</span>/messages</span><br><span class="line">  </span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br><span class="line">  index: <span class="string">&quot;system-%&#123;[agent.version]&#125;-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">  </span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line">setup.template.name: <span class="string">&quot;system&quot;</span></span><br><span class="line">setup.template.pattern: <span class="string">&quot;system-*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行启动 测试</span></span><br><span class="line">filebeat -e -c /etc/filebeat/filebeat.yml</span><br><span class="line"><span class="comment">#生成日志 </span></span><br><span class="line"><span class="built_in">echo</span> 123 &gt;&gt; /var/<span class="built_in">log</span>/messages</span><br></pre></td></tr></table></figure>

<h2 id="查看监控页面"><a href="#查看监控页面" class="headerlink" title="查看监控页面"></a>查看监控页面</h2><p><img src="/2020/11/19/FileBeat/image-20201120004007030.png" alt="image-20201120004007030"></p>
<p>以上可以看到只有一个主分片 和一个副本分片</p>
<h2 id="修改分片以及副本数量"><a href="#修改分片以及副本数量" class="headerlink" title="修改分片以及副本数量"></a>修改分片以及副本数量</h2><p><img src="/2020/11/19/FileBeat/image-20201120004221130.png" alt="image-20201120004221130"></p>
<p><img src="/2020/11/19/FileBeat/image-20201120004331923.png" alt="image-20201120004331923"></p>
<p><img src="/2020/11/19/FileBeat/image-20201120004625149.png" alt="image-20201120004625149"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;number_of_shards&quot;: &quot;3&quot;,</span><br><span class="line">&quot;number_of_replicas&quot;: &quot;1&quot;,</span><br></pre></td></tr></table></figure>

<p><img src="/2020/11/19/FileBeat/image-20201120004858732.png" alt="image-20201120004858732"></p>
<p><img src="/2020/11/19/FileBeat/image-20201120005031802.png" alt="image-20201120005031802"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FileBeat7/" rel="tag">FileBeat7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-1ES7部署"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/1ES7%E9%83%A8%E7%BD%B2/"
    >1ES7部署</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/1ES7%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#es节点 版本7.4.1</span></span><br><span class="line">ip           hostname       es_nodename</span><br><span class="line">192.168.1.61 es1.sp.com     es1</span><br><span class="line">192.168.1.62 es2.sp.com     es2</span><br><span class="line">192.168.1.63 es3.sp.com     es3</span><br></pre></td></tr></table></figure>

<h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有es节点</span></span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.4.1-x86_64.rpm</span><br><span class="line">yum install -y elasticsearch-7.4.1-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置文件/etc/elasticsearch/elasticsearch.yml  </span></span><br><span class="line">cluster.name: ES <span class="comment">#定义集群名称 所有节点必须一致</span></span><br><span class="line">node.name: es1  <span class="comment">#定义节点名称 需要保证集群内的唯一性 与主机名称一致方便管理</span></span><br><span class="line">path.data: /data/es_data <span class="comment">#数据存储路径</span></span><br><span class="line">path.logs: /data/es_data/<span class="built_in">log</span> <span class="comment">#日志存储路径</span></span><br><span class="line">bootstrap.memory_lock: <span class="literal">true</span> <span class="comment">#只是用内存 从不使用swap 生成中建议开启 否则性能可能会变差</span></span><br><span class="line">network.host: 0.0.0.0 <span class="comment">#监听地址</span></span><br><span class="line">http.port: 9200 <span class="comment">#外部访问端口</span></span><br><span class="line">discovery.seed_hosts: [<span class="string">&quot;es1&quot;</span>, <span class="string">&quot;es2&quot;</span>, <span class="string">&quot;es3&quot;</span>] <span class="comment">#定义集群发现 也就是 集群成员 主要这里是主机名并且可以正确解析,不是nodename 也可以是ip</span></span><br><span class="line">cluster.initial_master_nodes: [<span class="string">&quot;es1&quot;</span>, <span class="string">&quot;es2&quot;</span>, <span class="string">&quot;es3&quot;</span>] <span class="comment">#选举 也就是定义 谁可以作为master 是主机名或ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改好配置文件分发到各个节点 修改 node.name: 为各节点自己的名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#额外补充几个配置 不常用 但需要知道</span></span><br><span class="line">node.master: <span class="literal">true</span> <span class="comment">#是否可以参与选举为master 默认true </span></span><br><span class="line">node.data: <span class="literal">true</span> <span class="comment">#是否成为data节点 也就是此节点是否存储数据 默认为true</span></span><br><span class="line">				<span class="comment">#能够存储数据的节点称为data节点</span></span><br><span class="line">				<span class="comment">#问题  如果 node.master: false  node.data: false  那要这个节点有什么作用呢?</span></span><br><span class="line">				<span class="comment">#答: 集群不只有 master  data 两种角色 还有一种角色是 coordinating来负责接受请求 </span></span><br><span class="line">				<span class="comment">#实际上就是转发路由到master节点来处理   而且coordinating角色不能取消 </span></span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line"><span class="comment">#所有节点创建并授权 数据目录 和日志目录</span></span><br><span class="line">mkdir /data/es_data/<span class="built_in">log</span> -p</span><br><span class="line">chown -R elasticsearch.elasticsearch /data/es_data</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置内存相关 /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">-Xms1g 改为 -Xms4g  <span class="comment">#配置最小内存  </span></span><br><span class="line">-Xmx1g 改为 -Xmx4g  <span class="comment">#配置最大内存   不能超过32g   根据情况自己定义 通常是全部内存的一半或者三分之2</span></span><br></pre></td></tr></table></figure>

<h1 id="启动和验证"><a href="#启动和验证" class="headerlink" title="启动和验证"></a>启动和验证</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有节点验证端口监听情况 </span></span><br><span class="line">╰─➤  ss -tnl |grep -E <span class="string">&#x27;9200|9300&#x27;</span></span><br><span class="line">LISTEN     0      128       [::]:9200                  [::]:* </span><br><span class="line">LISTEN     0      128       [::]:9300                  [::]:* </span><br><span class="line"><span class="comment">#使用curl验证节点是否在同一集群</span></span><br><span class="line">╰─➤  curl es1:9200 </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span> : <span class="string">&quot;es1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;ES&quot;</span>,</span><br><span class="line">  <span class="string">&quot;cluster_uuid&quot;</span> : <span class="string">&quot;cPswZ2euR8uP849QbVoVEQ&quot;</span>, <span class="comment">#查看所有节点的集群id是否一致</span></span><br><span class="line">  <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;number&quot;</span> : <span class="string">&quot;7.4.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_flavor&quot;</span> : <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_type&quot;</span> : <span class="string">&quot;rpm&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_hash&quot;</span> : <span class="string">&quot;fc0eeb6e2c25915d63d871d344e3d0b45ea0ea1e&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_date&quot;</span> : <span class="string">&quot;2019-10-22T17:16:35.176724Z&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build_snapshot&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;lucene_version&quot;</span> : <span class="string">&quot;8.2.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_wire_compatibility_version&quot;</span> : <span class="string">&quot;6.8.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;minimum_index_compatibility_version&quot;</span> : <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;tagline&quot;</span> : <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#curl命令查看所有节点健康度</span></span><br><span class="line">╰─➤  curl <span class="string">&#x27;es1:9200/_cluster/health?pretty&#x27;</span>       </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;cluster_name&quot;</span> : <span class="string">&quot;ES&quot;</span>, <span class="comment">#集群名称</span></span><br><span class="line">  <span class="string">&quot;status&quot;</span> : <span class="string">&quot;green&quot;</span>,  <span class="comment">#green 代表健康 </span></span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span> : <span class="literal">false</span>, <span class="comment">#是否超时</span></span><br><span class="line">  <span class="string">&quot;number_of_nodes&quot;</span> : 3, <span class="comment">#节点数量</span></span><br><span class="line">  <span class="string">&quot;number_of_data_nodes&quot;</span> : 3,</span><br><span class="line">  <span class="string">&quot;active_primary_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;active_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;relocating_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;initializing_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;unassigned_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;delayed_unassigned_shards&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;number_of_pending_tasks&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;number_of_in_flight_fetch&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,</span><br><span class="line">  <span class="string">&quot;active_shards_percent_as_number&quot;</span> : 100.0</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#kibana console 命令查看集群健康情况</span></span><br><span class="line">GET /_cluster_health</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="cerebor-监控ES"><a href="#cerebor-监控ES" class="headerlink" title="cerebor  监控ES"></a>cerebor  监控ES</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#是一款ES集群的监控软件</span></span><br><span class="line"><span class="comment">#下载 任意节点安装</span></span><br><span class="line">wget https://github.com/lmenezes/cerebro/releases/download/v0.8.5/cerebro-0.8.5-1.noarch.rpm</span><br><span class="line">yum install -y cerebro-0.8.5-1.noarch.rpm</span><br><span class="line">yum install -y java-1.8.0-openjdk</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改配置 /etc/cerebro/application.conf </span></span><br><span class="line">data.path = <span class="string">&quot;/data/cerebro/cerebro.db&quot;</span> <span class="comment">#数据路径 </span></span><br><span class="line"><span class="comment">#创建数据路径并授权</span></span><br><span class="line">mkdir -p /data/cerebro</span><br><span class="line">chown -R cerebro.cerebro /data/cerebro</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">systemctl start cerebro.service &amp;&amp; systemctl <span class="built_in">enable</span> cerebro</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证端口 </span></span><br><span class="line">╰─➤  ss -tnl |grep 9000</span><br><span class="line">LISTEN     0      100       [::]:9000                  [::]:*</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="cerebor-初识"><a href="#cerebor-初识" class="headerlink" title="cerebor 初识"></a>cerebor 初识</h1><p>浏览器访问<a target="_blank" rel="noopener" href="http://es1.sp.com:9000/">http://es1.sp.com:9000/</a></p>
<p><img src="/2020/11/19/1ES7%E9%83%A8%E7%BD%B2/image-20201119170314763.png" alt="image-20201119170314763"></p>
<p><img src="/2020/11/19/1ES7%E9%83%A8%E7%BD%B2/image-20201119171008449.png" alt="image-20201119171008449"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-kibana安装"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/kibana%E5%AE%89%E8%A3%85/"
    >kibana安装</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/kibana%E5%AE%89%E8%A3%85/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a> / <a class="article-category-link" href="/categories/ELK7/kibana7/">kibana7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="kibana安装"><a href="#kibana安装" class="headerlink" title="kibana安装"></a>kibana安装</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-7.4.1-x86_64.rpm</span><br><span class="line">yum install -y kibana-7.4.1-x86_64.rpm</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server.port: 5601 <span class="comment">#端口</span></span><br><span class="line">server.host: <span class="string">&quot;0.0.0.0&quot;</span>  <span class="comment">#监听地址</span></span><br><span class="line">server.name: <span class="string">&quot;nidelaofuqin&quot;</span> <span class="comment">#自定义名称</span></span><br><span class="line">elasticsearch.hosts: [<span class="string">&quot;http://localhost:9200&quot;</span>] <span class="comment">#es列表</span></span><br><span class="line">kibana.index: <span class="string">&quot;.kibana&quot;</span> <span class="comment">#kibana自动生成的索引名称  .开头视为隐藏</span></span><br><span class="line">elasticsearch.shardTimeout: 30000 <span class="comment">#去es获取数据的超时时间单位毫秒 生产者规模比较大是时候 建议60000-90000</span></span><br><span class="line">kibana.defaultAppId: <span class="string">&quot;home&quot;</span> <span class="comment">#默认应用程序</span></span><br><span class="line">i18n.locale: <span class="string">&quot;zh-CN&quot;</span> <span class="comment">#设置中文</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kibana.service &amp;&amp;systemctl start kibana.service </span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kibana7/" rel="tag">kibana7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-filebeat-module"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/filebeat-module/"
    >filebeat-module</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/filebeat-module/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="filebeat-module"><a href="#filebeat-module" class="headerlink" title="filebeat module"></a>filebeat module</h1><p>这个功能 类似 logstash的pattern  主要是把非结构化的日志 转换成结构化的日志</p>
<p>官方文档: <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-modules.html</a></p>
<h1 id="nginx-示例"><a href="#nginx-示例" class="headerlink" title="nginx 示例"></a>nginx 示例</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filebeat 配置文件 </span></span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  <span class="comment">#指定module文件</span></span><br><span class="line">  path: <span class="variable">$&#123;path.config&#125;</span>/modules.d/*.yml</span><br><span class="line">  reload.enabled: <span class="literal">false</span></span><br><span class="line">setup.kibana:</span><br><span class="line">  <span class="comment">#指定kibana地址和端口</span></span><br><span class="line">  host: <span class="string">&quot;192.168.1.62:5601&quot;</span></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看module 状态列表</span></span><br><span class="line">filebeat modules list</span><br><span class="line"><span class="comment"># 开启module 实际上就是在 module目录中的配置文件重命名</span></span><br><span class="line">filebeat modules <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置模块配置文件/etc/filebeat/modules.d/nginx.yml</span></span><br><span class="line">- module: nginx</span><br><span class="line">  <span class="comment"># Access logs</span></span><br><span class="line">  access:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    var.paths: [<span class="string">&quot;/usr/local/nginx/logs/access.log&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Error logs</span></span><br><span class="line">  error:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    var.paths: [<span class="string">&quot;/usr/local/nginx/logs/error.log&quot;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#初始化 会导入kibana一些图形 和 仪表盘</span></span><br><span class="line">filebeat setup -e</span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">systemctl start filebeat  </span><br><span class="line"><span class="comment">#此时es应该有 filebeat 开头的索引 </span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FileBeat7/" rel="tag">FileBeat7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-kafka-zookeeper"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/kafka-zookeeper/"
    >kafka-zookeeper</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/kafka-zookeeper/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="kafka简介"><a href="#kafka简介" class="headerlink" title="kafka简介"></a>kafka简介</h1><p>Kafka是一个开源的分布式消息引擎/消息中间件，同时Kafka也是一个流处理平台。</p>
<p>Kafka最核心的最成熟的还是他的消息引擎，所以Kafka大部分应用场景还是用来作为消息队列削峰平谷。</p>
<h1 id="kafka的名词概念"><a href="#kafka的名词概念" class="headerlink" title="kafka的名词概念"></a>kafka的名词概念</h1><table>
<thead>
<tr>
<th>概念/对象</th>
<th>简单说明</th>
</tr>
</thead>
<tbody><tr>
<td>Broker</td>
<td>Kafka的节点</td>
</tr>
<tr>
<td>Topic</td>
<td>主题，用来承载消息</td>
</tr>
<tr>
<td>Partition</td>
<td>分区，用于主题分片存储</td>
</tr>
<tr>
<td>Producer</td>
<td>生产者，向主题发布消息的应用</td>
</tr>
<tr>
<td>Consumer</td>
<td>消费者，从主题订阅消息的应用</td>
</tr>
<tr>
<td>Consumer Group</td>
<td>消费者组，由多个消费者组成</td>
</tr>
</tbody></table>
<h1 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h1><p>主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。</p>
<p>这里主要用于 管理 kafka</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装:"></a>安装:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y java-1.8.0-openjdk </span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache/zookeeper/stable/apache-zookeeper-3.5.8-bin.tar.gz</span><br><span class="line">tar xf apache-zookeeper-3.5.8-bin.tar.gz -C /usr/<span class="built_in">local</span>/src</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/src/apache-zookeeper-3.5.8-bin  /usr/<span class="built_in">local</span>/zookeeper</span><br><span class="line">useradd zookeeper -M -s /sbin/nologin</span><br><span class="line">chown -R zookeeper.zookeeper /usr/<span class="built_in">local</span>/src/apache-zookeeper-3.5.8-bin </span><br><span class="line">mkdir -p /var/lib/zookeeper</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#unitfile</span></span><br><span class="line">cat &gt;/usr/lib/systemd/system/zookeeper.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=ZooKeeper Service</span><br><span class="line">Documentation=http://zookeeper.apache.org</span><br><span class="line">Requires=network.target</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/app/idk/bin&quot;</span></span><br><span class="line">Type=forking</span><br><span class="line">User=zookeeper</span><br><span class="line">Group=zookeeper</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh start /usr/<span class="built_in">local</span>/zookeeper/conf/zoo.cfg</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh stop /usr/<span class="built_in">local</span>/zookeeper/conf/zoo.cfg</span><br><span class="line">ExecReload=/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh restart /usr/<span class="built_in">local</span>/zookeeper/conf/zoo.cfg</span><br><span class="line">WorkingDirectory=/var/lib/zookeeper</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="配置zookeeper集群"><a href="#配置zookeeper集群" class="headerlink" title="配置zookeeper集群"></a>配置zookeeper集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/zookeeper/conf  </span><br><span class="line">cp zoo_sample.cfg  zoo.cfg </span><br><span class="line">vim zookeeper.cfg </span><br><span class="line"><span class="comment">#服务器之间 或者c/s之间心跳间隔</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment">#集群中的Follower  与leader 之间初始连接的心跳数量</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="comment">#集群中的Follower  与leader 之间请求和应答之间能容忍的最多心跳数</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment">#数据目录</span></span><br><span class="line">dataDir=/data/zookeeper</span><br><span class="line"><span class="comment">#日志目录</span></span><br><span class="line">dataLogDir=/data/zookeeperlog</span><br><span class="line"><span class="comment">#监听端口</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment">#客户端最大连接数</span></span><br><span class="line">maxClientCnxns=60</span><br><span class="line"></span><br><span class="line"><span class="comment">#autopurge.snapRetainCount=3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#autopurge.purgeInterval=1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#三节点示例配置</span></span><br><span class="line"><span class="comment">#格式: server.[ID编号]=[主机名或ip]:[L与F的通信端口]:[选举端口]</span></span><br><span class="line">server.1=192.168.1.64:2888:3888</span><br><span class="line">server.2=192.168.1.65:2888:3888</span><br><span class="line">server.3=192.168.1.66:2888:3888</span><br><span class="line"><span class="comment">#注意 这里的id 需要自己在对应主机数据目录标识 方法如下</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[id]&quot;</span> &gt;[数据目录]/myid</span><br></pre></td></tr></table></figure>

<h2 id="kafka集群安装"><a href="#kafka集群安装" class="headerlink" title="kafka集群安装"></a>kafka集群安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/kafka/2.3.0/kafka_2.12-2.3.0.tgz</span><br><span class="line">tar xf kafka_2.12-2.3.0.tgz -C /usr/<span class="built_in">local</span>/src/</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/src/kafka_2.12-2.3.0 /usr/<span class="built_in">local</span>/kafka</span><br><span class="line">useradd kafka -M -s /sbin/nologin</span><br><span class="line">chown -R kafka.kafka /usr/<span class="built_in">local</span>/src/kafka_2.12-2.3.0</span><br><span class="line"><span class="comment">#准备数据存放目录</span></span><br><span class="line">mkdir -p /data/kafka-logs</span><br><span class="line">chown -R kafka.kafka /data/kafka-logs </span><br><span class="line"><span class="comment">#配置 /usr/local/kafka/config/server.properties</span></span><br><span class="line"><span class="comment">#集群id 集群中唯一不能重复 且必须是整数</span></span><br><span class="line">broker.id=0 </span><br><span class="line"><span class="comment">#监听端口 格式 PLAINTEXT://[ip]:[prot] 建议填写ip否则在kafka注册到zk的时候 使用主机名注册 如果不能解析会导致连接失败</span></span><br><span class="line">listeners=PLAINTEXT://192.168.1.64:9092  </span><br><span class="line"><span class="comment">#处理网络请求的线程数量默认3</span></span><br><span class="line">num.network.threads=3 </span><br><span class="line"><span class="comment">#处理磁盘io的线程数量 默认8</span></span><br><span class="line">num.io.threads=8 </span><br><span class="line"><span class="comment">#socket发送数据的缓冲区buffer 默认100kb</span></span><br><span class="line">socket.send.buffer.bytes=102400 </span><br><span class="line"><span class="comment">#socket接受请求的缓冲区buffer 默认100kb</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"><span class="comment">#套接字服务器将接受的请求的最大大小(针对OOM的保护)默认100MB</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"><span class="comment">#数据持久存储位置 并非字面中的日志路径 kafka 的log 就是数据</span></span><br><span class="line">log.dirs=/data/kafka-logs </span><br><span class="line"><span class="comment">#每个主题的默认分区数量 默认1</span></span><br><span class="line">num.partitions=3 </span><br><span class="line"><span class="comment">#启动恢复时的线程数量</span></span><br><span class="line">num.recovery.threads.per.data.dir=1 </span><br><span class="line"><span class="comment"># The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"><span class="comment"># The maximum amount of time a message can sit in a log before we force a flush</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line"><span class="comment">#日志保存时间 单位小时 这里的日志指的是数据 所以如果数据流够特别大的话 可以设置3-9小时</span></span><br><span class="line">log.retention.hours=168 </span><br><span class="line"><span class="comment">#日志最大保留大小 默认1G</span></span><br><span class="line">log.retention.bytes=1073741824 </span><br><span class="line"><span class="comment">#日志分配策略 单个日志文件大小 超出后创建新的日志 默认1G</span></span><br><span class="line">log.segment.bytes=1073741824 </span><br><span class="line"><span class="comment">#检查日志是否超出限制的间隔时间 默认300秒</span></span><br><span class="line">log.retention.check.interval.ms=300000  </span><br><span class="line"><span class="comment">#zookeeper的地址和端口 多个使用逗号分隔</span></span><br><span class="line">zookeeper.connect=192.168.1.64:2181,192.168.1.65:2181,192.168.1.66:2181</span><br><span class="line"><span class="comment">#zookeeper 连接超时时间 默认6秒</span></span><br><span class="line">zookeeper.connection.timeout.ms=6000 </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#UnitFile</span></span><br><span class="line">cat &gt;/usr/lib/systemd/system/kafka.service &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Apache Kafka server (broker)</span><br><span class="line">Documentation=http://kafka.apache.org/documentation.html</span><br><span class="line">Requires=network.target</span><br><span class="line">After=network.target</span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=kafka</span><br><span class="line">Group=kafka</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/kafka/bin/kafka-server-start.sh /usr/<span class="built_in">local</span>/kafka/config/server.properties</span><br><span class="line">ExecStop=/usr/<span class="built_in">local</span>/kafka/bin/kafka-server-stop.sh</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#启动kafka</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl start kafka &amp;&amp; systemctl <span class="built_in">enable</span> kafka </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="验证集群"><a href="#验证集群" class="headerlink" title="验证集群"></a>验证集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/kafka/bin</span><br><span class="line"><span class="comment">#创建一个topic replication-factor 副本数量 partitions分区数量</span></span><br><span class="line">./kafka-topics.sh \</span><br><span class="line">--create \</span><br><span class="line">--zookeeper 192.168.1.64:2181,192.168.1.65:2181,192.168.1.66:2181 \</span><br><span class="line">--replication-factor 1 \</span><br><span class="line">--partitions 3 \</span><br><span class="line">--topic demo_topics</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出所有topic</span></span><br><span class="line">./kafka-topics.sh \</span><br><span class="line">--list \</span><br><span class="line">--zookeeper 192.168.1.64:2181,192.168.1.65:2181,192.168.1.66:2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看topic详细情况</span></span><br><span class="line">./kafka-topics.sh \</span><br><span class="line">--describe \</span><br><span class="line">--zookeeper 192.168.1.64:2181,192.168.1.65:2181,192.168.1.66:2181 \</span><br><span class="line">--topic demo_topics</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="生产消费测试"><a href="#生产消费测试" class="headerlink" title="生产消费测试"></a>生产消费测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入生产者的console  输入一个消息</span></span><br><span class="line"><span class="comment">#注意这里连接的事kafka 不是zookeeper 并且要指定使用哪个topic</span></span><br><span class="line">./kafka-console-producer.sh \</span><br><span class="line">--broker-list 192.168.1.64:9092,192.168.1.65:9092,192.168.1.66:9092 \</span><br><span class="line">--topic demo_topics</span><br><span class="line">&gt;Hello Kafka!  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#另一节点 开启 消费者 console</span></span><br><span class="line">./kafka-console-consumer.sh \</span><br><span class="line">--bootstrap-server=192.168.1.64:9092,192.168.1.65:9092,192.168.1.66:9092 \</span><br><span class="line">--topic demo_topics \</span><br><span class="line">--from-beginning</span><br><span class="line"><span class="comment">#如果 生产者窗口输入什么  消费者窗口就显示什么 就表示正确</span></span><br></pre></td></tr></table></figure>

<h3 id="删除topic"><a href="#删除topic" class="headerlink" title="删除topic"></a>删除topic</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh \</span><br><span class="line">--delete \</span><br><span class="line">--zookeeper 192.168.1.64:2181,192.168.1.65:2181,192.168.1.66:2181 \</span><br><span class="line">--topic demo_topics</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-logstash"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/logstash/"
    >logstash7</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/logstash/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.4.1.rpm</span><br><span class="line">yum install -y logstash-7.4.1.rpm</span><br><span class="line"><span class="comment">#测试配置文件语法</span></span><br><span class="line">/usr/share/logstash/bin/logstash -t -f [conf_file]</span><br><span class="line"><span class="comment">#简单启动 用于测试配置文件</span></span><br><span class="line">/usr/share/logstash/bin/logstash -f  [conf_file] -r</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h3 id="配置目录"><a href="#配置目录" class="headerlink" title="配置目录"></a>配置目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/etc/logstash/</span></span><br><span class="line">conf.d          		<span class="comment">#默认自动加载此目录的配置</span></span><br><span class="line">jvm.options				<span class="comment">#JDK相关参数 如内存</span></span><br><span class="line">log4j2.properties		<span class="comment">#日志相关 通常不用哦配置</span></span><br><span class="line">logstash-sample.conf	<span class="comment">#示例配置文件</span></span><br><span class="line">logstash.yml			<span class="comment">#logstash 自身配置文件</span></span><br><span class="line">pipelines.yml			<span class="comment">#流水线配置文件</span></span><br><span class="line">startup.options 		<span class="comment">#启动相关选项</span></span><br></pre></td></tr></table></figure>

<h3 id="input-插件"><a href="#input-插件" class="headerlink" title="input 插件"></a>input 插件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#标准输入</span></span><br><span class="line">input &#123;</span><br><span class="line">	stdin &#123;</span><br><span class="line">		<span class="built_in">type</span> =&gt; stdin</span><br><span class="line">		tags =&gt; <span class="string">&quot;tags_name&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#从文件读取 </span></span><br><span class="line">input &#123;</span><br><span class="line">	file &#123;</span><br><span class="line">		path =&gt; <span class="string">&quot;/var/log/123.log&quot;</span></span><br><span class="line">		<span class="built_in">type</span> =&gt; syslog</span><br><span class="line">		<span class="comment">#基于统配 排除匹配的文件</span></span><br><span class="line">		exclude =&gt; <span class="string">&quot;*.gz&quot;</span></span><br><span class="line">		<span class="comment">#第一次是从头(beginning)读取文件还是从末尾(end)</span></span><br><span class="line">		start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">		<span class="comment">#检查文件的间隔时间 单位秒 默认1秒</span></span><br><span class="line">		stat_interval =&gt; <span class="string">&quot;3&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#http</span></span><br><span class="line">input &#123;</span><br><span class="line">	http &#123;</span><br><span class="line">		port =&gt; 7474</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#beats</span></span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#kafka</span></span><br><span class="line"><span class="comment"># bootstrap_servers 用于建立群集初始连接的Kafka实例的URL列表。</span></span><br><span class="line"><span class="comment"># topics  要订阅的主题列表，kafka topics</span></span><br><span class="line"><span class="comment"># group_id 消费者所属组的标识符，默认为logstash。kafka中一个主题的消息将通过相同的方式分发到Logstash的group_id</span></span><br><span class="line"><span class="comment"># codec 通用选项，用于输入数据的编解码器。</span></span><br><span class="line">input &#123;</span><br><span class="line">    kafka&#123;</span><br><span class="line">        <span class="comment">#kafka列表</span></span><br><span class="line">        bootstrap_servers =&gt; <span class="string">&quot;kafka01:9092,kafka02:9092,kafka03:9092&quot;</span>.</span><br><span class="line">        <span class="comment">#订阅的主题</span></span><br><span class="line">        topics =&gt; [<span class="string">&quot;access_log&quot;</span>]</span><br><span class="line">        <span class="comment">#组id 多logstash的情况下 相同的组id 视为一个消费组 组成员将不会重复消费同一条目</span></span><br><span class="line">        group_id =&gt; <span class="string">&quot;logstash-file&quot;</span></span><br><span class="line">        <span class="comment">#理想情况下 应该与此主题相同的分区数 以实现完美的平衡 如果线程多余分区数 多余的线程将处于空闲状态</span></span><br><span class="line">        consumer_threads =&gt; 2</span><br><span class="line">        codec =&gt; <span class="string">&quot;json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="filter插件"><a href="#filter插件" class="headerlink" title="filter插件"></a>filter插件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#grok 用于将日志转化为json格式 内置了很多正则的集合名为pattern 就意味着很多情况下不需要自己写正则了</span></span><br><span class="line"><span class="comment"># https://grokdebug.herokuapp.com/patterns  可以找到很多的pattern 并且可以测试 甚至可以吧你的日志贴上去 他会帮你找到最合适的 pattern</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#geoip 可以根据ip得到ip所在位置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#示例 </span></span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		<span class="comment">#grok 语法：%&#123;SYNTAX:SEMANTIC&#125;   即 %&#123;正则或内置pattern:自定义字段名&#125;</span></span><br><span class="line">		<span class="comment">#官方pattern列表:https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns</span></span><br><span class="line">		<span class="comment"># https://grokdebug.herokuapp.com/patterns 可以进行匹配测试 和简单的生成pattern</span></span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			<span class="comment">#&quot;[想要转换的字段message]&quot; =&gt; &quot;[想要使用的pattern]&quot; 得到整个字段的json格式</span></span><br><span class="line">			<span class="comment">#还可以在次使用grok组件 继续把分割好的json某个字段继续分割为新的字段</span></span><br><span class="line">			<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">	geoip &#123;</span><br><span class="line">			<span class="comment">#会生成一个geoip字段 内容包括 时区 国家 地区 省 市 经纬度 等</span></span><br><span class="line">			<span class="comment">#&quot;geoip&quot; =&gt; &#123;</span></span><br><span class="line">			<span class="comment">#        &quot;continent_code&quot; =&gt; &quot;AS&quot;,  </span></span><br><span class="line">			<span class="comment">#            &quot;longitude&quot; =&gt; 113.25,</span></span><br><span class="line">			<span class="comment">#            &quot;city_name&quot; =&gt; &quot;Guangzhou&quot;,</span></span><br><span class="line">			<span class="comment">#             &quot;timezone&quot; =&gt; &quot;Asia/Shanghai&quot;,</span></span><br><span class="line">			<span class="comment">#                   &quot;ip&quot; =&gt; &quot;183.60.92.253&quot;,</span></span><br><span class="line">			<span class="comment">#         &quot;country_name&quot; =&gt; &quot;China&quot;,</span></span><br><span class="line">			<span class="comment">#        &quot;country_code3&quot; =&gt; &quot;CN&quot;,</span></span><br><span class="line">			<span class="comment">#          &quot;region_name&quot; =&gt; &quot;Guangdong&quot;,</span></span><br><span class="line">			<span class="comment">#             &quot;location&quot; =&gt; &#123;</span></span><br><span class="line">			<span class="comment">#           &quot;lon&quot; =&gt; 113.25,</span></span><br><span class="line">			<span class="comment">#           &quot;lat&quot; =&gt; 23.1167</span></span><br><span class="line">			<span class="comment">#       &#125;,</span></span><br><span class="line">			<span class="comment">#通过那个字段得到ip地址 可以是grok 后的字段</span></span><br><span class="line">			<span class="built_in">source</span> =&gt; <span class="string">&quot;clientip&quot;</span></span><br><span class="line">			<span class="comment">#指定需要的geoip中的字段 其余的将不在生成</span></span><br><span class="line">			fields =&gt; [<span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;continent_code&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;latitude&quot;</span>, <span class="string">&quot;longitude&quot;</span>]</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="comment">#date 模块 很多时候 日志采集时间与日志生成时间不一致 此时可以使用此模块 把日志采集时间覆盖为日志生成时间</span></span><br><span class="line">	<span class="comment"># https://www.elastic.co/guide/en/logstash/current/plugins-filters-date.html 找时间匹配的写法</span></span><br><span class="line">	<span class="comment">#常用格式有 </span></span><br><span class="line">	<span class="comment">#ISO8601	2011-04-19T03:44:01.103Z</span></span><br><span class="line">	<span class="comment">#UNIX	1326149001.132或1326149001</span></span><br><span class="line">	<span class="comment">#TAI64N	64位时间戳</span></span><br><span class="line">	<span class="comment">#时间格式假设 为 30/Dec/2020:11:50:55 +0800</span></span><br><span class="line">	date &#123;</span><br><span class="line">			<span class="comment"># timestamp 是来源字段名称 </span></span><br><span class="line">			<span class="comment"># &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; 是匹配当前格式</span></span><br><span class="line">			<span class="comment"># &quot;UNIX&quot; 期望时间格式 </span></span><br><span class="line">			match =&gt; [<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>, <span class="string">&quot;UNIX&quot;</span>]</span><br><span class="line">			<span class="comment">#需要覆盖的或新的字段名称 通常是 @timestamp 因为kibana默认通过此字段读取时间</span></span><br><span class="line">			target =&gt; <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">			<span class="comment">#指定一个时区</span></span><br><span class="line">			timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment"># 浏览器信息转换成json格式 覆盖原有字段 也可以新建字段 保留原有字段</span></span><br><span class="line">	useragent &#123;</span><br><span class="line">			<span class="comment">#源字段</span></span><br><span class="line">			match =&gt; <span class="string">&quot;agent&quot;</span></span><br><span class="line">			<span class="comment">#目标字段 可以是一个新字段</span></span><br><span class="line">			target =&gt; <span class="string">&quot;agent&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	mutate &#123;</span><br><span class="line">			<span class="comment">#对某字段的值进行查找替换  这里是message字段 的换行符 变为空格</span></span><br><span class="line">			gsub =&gt; [<span class="string">&quot;message&quot;</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>]</span><br><span class="line">			</span><br><span class="line">			<span class="comment">#定义字段分隔符 形成数组</span></span><br><span class="line">			split =&gt; [<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;|&quot;</span>]</span><br><span class="line">			<span class="comment">#引用数组的值添加为新的字段 或覆盖老的字段</span></span><br><span class="line">			add_field =&gt; &#123;</span><br><span class="line">				<span class="string">&quot;userid&quot;</span> =&gt; <span class="string">&quot;%&#123;[message][0]&quot;</span></span><br><span class="line">				<span class="string">&quot;action&quot;</span> =&gt; <span class="string">&quot;%&#123;[message][1]&quot;</span></span><br><span class="line">				<span class="string">&quot;date&quot;</span> =&gt; <span class="string">&quot;%&#123;[message][2]&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">#类型转换 有利于kibana统计展示等</span></span><br><span class="line">			convert =&gt; &#123;</span><br><span class="line">				<span class="string">&quot;userid&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">				<span class="string">&quot;action&quot;</span> =&gt; <span class="string">&quot;string&quot;</span></span><br><span class="line">				<span class="string">&quot;date&quot;</span> =&gt; <span class="string">&quot;date&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">#删除不需要的字段</span></span><br><span class="line">			remove_field =&gt; [<span class="string">&quot;message&quot;</span>, <span class="string">&quot;headers&quot;</span>]</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">	   &#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&quot;access&quot;</span> <span class="keyword">in</span>  [tags][0]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="output插件"><a href="#output插件" class="headerlink" title="output插件"></a>output插件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line"><span class="meta">	#</span><span class="bash">标准输出</span></span><br><span class="line">	stdout &#123;</span><br><span class="line">		codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash">输出到es</span></span><br><span class="line">	elasticsearch &#123;</span><br><span class="line"><span class="meta">		#</span><span class="bash">es主机列表</span></span><br><span class="line">		hosts =&gt; [&quot;192.168.1.61:9200&quot;, &quot;192.168.1.62:9200&quot;, &quot;192.168.1.63:9200&quot;]</span><br><span class="line"><span class="meta">		#</span><span class="bash">索引名称</span></span><br><span class="line">		index =&gt; &quot;app-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"><span class="meta">		#</span><span class="bash">覆盖索引模板</span></span><br><span class="line">		template_overwrite =&gt; true</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h1><h2 id="比较操作"><a href="#比较操作" class="headerlink" title="比较操作"></a>比较操作</h2><ul>
<li>相等: <code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code></li>
<li>正则: <code>=~</code>(匹配正则), <code>!~</code>(不匹配正则)</li>
<li>包含: <code>in</code>(包含), <code>not in</code>(不包含)</li>
</ul>
<h2 id="布尔操作"><a href="#布尔操作" class="headerlink" title="布尔操作"></a>布尔操作</h2><p>　　- <code>and</code>(与), <code>or</code>(或), <code>nand</code>(非与), <code>xor</code>(非或)</p>
<h2 id="一元运算符"><a href="#一元运算符" class="headerlink" title="一元运算符"></a>一元运算符</h2><p>表达式可能很长且很复杂。表达式可以包含其他表达式，您可以使用！来取消表达式，并且可以使用括号（…）对它们进行分组。</p>
<ul>
<li>- <code>!</code>(取反)</li>
<li>- <code>()</code>(复合表达式)</li>
<li><code>!()</code>(对复合表达式结果取反)</li>
</ul>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>如若action是login则mutate filter删除secret字段：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [action] == &quot;login&quot; &#123;</span><br><span class="line">    mutate &#123; remove_field =&gt; &quot;secret&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若是正则匹配，成功后添加自定义字段：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    if [message] =~ /\w+\s+\/\w+(\/learner\/course\/)/ &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123; &quot;learner_type&quot; =&gt; &quot;course&quot; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在一个条件里指定多个表达式：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  # Send production errors to pagerduty</span><br><span class="line">  if [loglevel] == &quot;ERROR&quot; and [deployment] == &quot;production&quot; &#123;</span><br><span class="line">    pagerduty &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在in条件，可以比较字段值：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [foo] in [foobar] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in &quot;foo&quot; &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in string&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if &quot;hello&quot; in [greeting] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;string in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in [&quot;hello&quot;, &quot;world&quot;, &quot;foo&quot;] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in list&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [missing] in [alsomissing] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldnotexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if !(&quot;foo&quot; in [&quot;hello&quot;, &quot;world&quot;]) &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>not in示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  if &quot;_grokparsefailure&quot; not in [tags] &#123;</span><br><span class="line">    elasticsearch &#123; ... &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>完整示例:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    kafka&#123;</span><br><span class="line">        bootstrap_servers =&gt; &quot;192.168.1.64:9092,192.168.1.65:9092,192.168.1.66:9092&quot;</span><br><span class="line">        topics =&gt; [&quot;kafka-test&quot;]</span><br><span class="line">        consumer_threads =&gt; 3</span><br><span class="line">        codec =&gt; &quot;json&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  if &quot;access&quot; in [tags]&#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">		&quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125; \&quot;%&#123;IP:XFF&#125;\&quot;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	geoip &#123;</span><br><span class="line">		source =&gt; &quot;XFF&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	mutate &#123;</span><br><span class="line">		remove_field =&gt; [&quot;message&quot;, &quot;ecs&quot;, &quot;httpversion&quot;]</span><br><span class="line">		convert =&gt; &#123;</span><br><span class="line">			&quot;bytes&quot; =&gt; &quot;integer&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	stdout &#123;</span><br><span class="line">		codec =&gt; &quot;rubydebug&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/logstash7/" rel="tag">logstash7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-mysql慢日志收集"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/mysql%E6%85%A2%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"
    >Mysql慢日志收集</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2020/11/19/mysql%E6%85%A2%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" class="article-date">
  <time datetime="2020-11-19T02:24:23.000Z" itemprop="datePublished">2020-11-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ELK7/">ELK7</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="慢日志收集"><a href="#慢日志收集" class="headerlink" title="慢日志收集"></a>慢日志收集</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#慢日志内容格式示例</span></span><br><span class="line">------------------------------------------------------------------------------------</span><br><span class="line"><span class="comment"># Time: 201123 17:10:36</span></span><br><span class="line"><span class="comment"># User@Host: java[java] @  [192.168.1.112]</span></span><br><span class="line"><span class="comment"># Thread_id: 38760  Schema: lt_8001  QC_hit: No</span></span><br><span class="line"><span class="comment"># Query_time: 1.113875  Lock_time: 0.000028  Rows_sent: 1  Rows_examined: 2396000</span></span><br><span class="line"><span class="comment"># Rows_affected: 0  Bytes_sent: 59</span></span><br><span class="line">use lt_8001;</span><br><span class="line">SET timestamp=1606122636;</span><br><span class="line">SELECT COUNT( 1 ) FROM lt_bet </span><br><span class="line"> </span><br><span class="line"> WHERE (lot_id = 102 AND action_no = 20201123070);</span><br><span class="line"><span class="comment"># Time: 201123 17:11:40</span></span><br><span class="line"><span class="comment"># User@Host: java[java] @  [192.168.1.112]</span></span><br><span class="line"><span class="comment"># Thread_id: 38392  Schema: lt_8001  QC_hit: No</span></span><br><span class="line"><span class="comment"># Query_time: 1.686488  Lock_time: 0.000060  Rows_sent: 1  Rows_examined: 2396097</span></span><br><span class="line"><span class="comment"># Rows_affected: 0  Bytes_sent: 59</span></span><br><span class="line">SET timestamp=1606122700;</span><br><span class="line">SELECT COUNT( 1 ) FROM lt_bet </span><br><span class="line"> </span><br><span class="line"> WHERE (lot_id = 103 AND action_no = 20201123052);</span><br><span class="line"><span class="comment"># Time: 201123 17:11:45</span></span><br><span class="line"><span class="comment"># User@Host: java[java] @  [192.168.1.112]</span></span><br><span class="line"><span class="comment"># Thread_id: 38392  Schema: lt_8001  QC_hit: No</span></span><br><span class="line"><span class="comment"># Query_time: 5.035932  Lock_time: 0.000071  Rows_sent: 1  Rows_examined: 2396097</span></span><br><span class="line"><span class="comment"># Rows_affected: 0  Bytes_sent: 59</span></span><br><span class="line">SET timestamp=1606122705;</span><br><span class="line">SELECT COUNT( 1 ) FROM lt_bet </span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#filebeat 采集慢日志 发送至 logstash </span></span><br><span class="line">filebeat.inputs: </span><br><span class="line">- <span class="built_in">type</span>: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /data/mysql/slow_query.log</span><br><span class="line">  tags: [<span class="string">&quot;mysql-slowlog&quot;</span>]</span><br><span class="line">  <span class="comment">#去掉无用的行</span></span><br><span class="line">  exclude_lines: [<span class="string">&#x27;^\# Time&#x27;</span>]</span><br><span class="line">  multiline.pattern: <span class="string">&#x27;^\# User&#x27;</span></span><br><span class="line">  multiline.negate: <span class="literal">false</span></span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.max_line: 10000</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">&quot;192.168.1.99:5044&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#logstash 配置</span></span><br><span class="line">input &#123;</span><br><span class="line">	<span class="comment">#监听端口 提供给filebeat</span></span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">	<span class="comment">#换行符转换为 空格</span></span><br><span class="line">	mutate &#123;</span><br><span class="line">		gsub =&gt; [<span class="string">&quot;message&quot;</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#转换为json 这个pattern 我写了整整一下午 码垛</span></span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			<span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;(?m)^# User@Host: %&#123;USER:user&#125;\[%&#123;USER-2:User&#125;\] @ (?:(?&lt;Clienthost&gt;\S*) )?\[(?:%&#123;IP:clientip&#125;)?\] # Thread_id: %&#123;NUMBER:Thread_id:integer&#125;\s+ Schema: (?:(?&lt;DBname&gt;\S*) )\s+QC_hit: (?:(?&lt;QC_hit&gt;\S*) )# Query_time: %&#123;NUMBER:Query_time&#125;\s+ Lock_time: %&#123;NUMBER:Lock_time&#125;\s+ Rows_sent: %&#123;NUMBER:Rows_sent:integer&#125;\s+Rows_examined: %&#123;NUMBER:Rows_examined:integer&#125;\s+# Rows_affected: %&#123;NUMBER:Rows_affected:integer&#125;\s+Bytes_sent: %&#123;NUMBER:Bytes_sent:integer&#125;\s+SET timestamp=%&#123;NUMBER:timestamp&#125;; \s*(?&lt;Query&gt;(?&lt;Action&gt;\w+)\s+.*)&quot;</span> </span><br><span class="line">			&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	date&#123;</span><br><span class="line">		<span class="comment">#timestamp 字段的时间为UNIX格式 转换为 YYYY-MM-dd HH:mm:ss 这种自定义格式</span></span><br><span class="line">		match =&gt; [<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;UNIX&quot;</span> , <span class="string">&quot;YYYY-MM-dd HH:mm:ss&quot;</span>]</span><br><span class="line">		<span class="comment">#然后覆盖到@timestamp字段</span></span><br><span class="line">		target =&gt; <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line">		<span class="comment">#时区设置为上海时间</span></span><br><span class="line">		timezone =&gt; <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	mutate &#123;</span><br><span class="line">		<span class="comment">#删除无用字段</span></span><br><span class="line">		remove_field =&gt; [<span class="string">&quot;message&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;input&quot;</span>, <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ecs&quot;</span>, <span class="string">&quot;log&quot;</span>]</span><br><span class="line">		<span class="comment">#Lock_time  Query_time 字段的值转换为浮点数</span></span><br><span class="line">		convert =&gt; [<span class="string">&quot;Lock_time&quot;</span>, <span class="string">&quot;float&quot;</span>]</span><br><span class="line">		convert =&gt; [<span class="string">&quot;Query_time&quot;</span>, <span class="string">&quot;float&quot;</span>]</span><br><span class="line">		<span class="comment">#添加字段用于保存索引名称</span></span><br><span class="line">		add_field =&gt; &#123;</span><br><span class="line">			<span class="string">&quot;target_index&quot;</span> =&gt; <span class="string">&quot;mysql-slow-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		<span class="comment">#es列表</span></span><br><span class="line">		hosts =&gt; [<span class="string">&quot;192.168.1.61:9200&quot;</span>, <span class="string">&quot;192.168.1.62:9200&quot;</span>, <span class="string">&quot;192.168.1.63:9200&quot;</span>]</span><br><span class="line">		<span class="comment">#引用target_index字段的值作为索引名称</span></span><br><span class="line">		index =&gt; <span class="string">&quot;%&#123;[target_index]&#125;&quot;</span></span><br><span class="line">		template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#测试的时候使用这个查看结果是否符合需求 测试完成后 改为使用以上 es输出</span></span><br><span class="line">	stdout &#123;</span><br><span class="line">		codec =&gt; <span class="string">&quot;rubydebug&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK7/" rel="tag">ELK7</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2020
        <i class="ri-heart-fill heart_icon"></i> Nero
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo.png" alt="Nero 的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>