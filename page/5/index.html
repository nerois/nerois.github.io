<!DOCTYPE html>


<html lang="zh-CN">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="摇旗呐喊的热情,携光阴渐远去,人世间悲喜烂剧,昼夜轮播不停,纷飞的滥情男女,情仇爱恨别离,一代人终将老去，但总有人正年轻" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Nero 的个人博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/dist/main.css">

  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">

  
<link rel="stylesheet" href="/css/custom.css">

  
  
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

  
  

  

</head>

</html>

<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/back4.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Nero 的个人博客</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
        <img
          src="/images/logo.png"
          class="cover-logo"
          alt="Nero 的个人博客"
        />
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['摇旗呐喊的热情,携光阴渐远去,', '人世间悲喜烂剧,昼夜轮播不停,', '纷飞的滥情男女, 情仇爱恨别离,一代人终将老去，但总有人正年轻'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  <article class="articles">
    
    
    
    
    <article
  id="post-mongodb索引"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/mongodb%E7%B4%A2%E5%BC%95/"
    >MongoDB索引</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/mongodb%E7%B4%A2%E5%BC%95/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#慢查询状态 默认超过100毫秒 视为慢查询 会写入日志</span></span><br><span class="line">&gt; db.getProfilingStatus()</span><br><span class="line">&#123; <span class="string">&quot;was&quot;</span> : 0, <span class="string">&quot;slowms&quot;</span> : 100, <span class="string">&quot;sampleRate&quot;</span> : 1 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询过程详情 多用于查看此语句是否全表扫描</span></span><br><span class="line">&gt; db.myuser.find( &#123;age:9999&#125; ).explain(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;queryPlanner&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;plannerVersion&quot;</span> : 1,</span><br><span class="line">                <span class="string">&quot;namespace&quot;</span> : <span class="string">&quot;shijiange.myuser&quot;</span>,</span><br><span class="line">                <span class="string">&quot;indexFilterSet&quot;</span> : <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&quot;parsedQuery&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;winningPlan&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;stage&quot;</span> : <span class="string">&quot;COLLSCAN&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;filter&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                        <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;direction&quot;</span> : <span class="string">&quot;forward&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;rejectedPlans&quot;</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;executionStats&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;executionSuccess&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;nReturned&quot;</span> : 1,</span><br><span class="line">                <span class="comment">#查询时间 毫秒</span></span><br><span class="line">                <span class="string">&quot;executionTimeMillis&quot;</span> : 198,</span><br><span class="line">                <span class="string">&quot;totalKeysExamined&quot;</span> : 0,</span><br><span class="line">                <span class="comment">#总查询条目数条目数过大 可能就是全表查询</span></span><br><span class="line">                <span class="string">&quot;totalDocsExamined&quot;</span> : 500000,</span><br><span class="line">                <span class="string">&quot;executionStages&quot;</span> : &#123;</span><br><span class="line">                        <span class="string">&quot;stage&quot;</span> : <span class="string">&quot;COLLSCAN&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;filter&quot;</span> : &#123;</span><br><span class="line">                                <span class="string">&quot;age&quot;</span> : &#123;</span><br><span class="line">                                        <span class="string">&quot;<span class="variable">$eq</span>&quot;</span> : 9999</span><br><span class="line">                                &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">&quot;nReturned&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;executionTimeMillisEstimate&quot;</span> : 0,</span><br><span class="line">                        <span class="string">&quot;works&quot;</span> : 500002,</span><br><span class="line">                        <span class="string">&quot;advanced&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;needTime&quot;</span> : 500000,</span><br><span class="line">                        <span class="string">&quot;needYield&quot;</span> : 0,</span><br><span class="line">                        <span class="string">&quot;saveState&quot;</span> : 3906,</span><br><span class="line">                        <span class="string">&quot;restoreState&quot;</span> : 3906,</span><br><span class="line">                        <span class="string">&quot;isEOF&quot;</span> : 1,</span><br><span class="line">                        <span class="string">&quot;direction&quot;</span> : <span class="string">&quot;forward&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;docsExamined&quot;</span> : 500000</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;allPlansExecution&quot;</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;serverInfo&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> : <span class="string">&quot;k-n1.sp.com&quot;</span>,</span><br><span class="line">                <span class="string">&quot;port&quot;</span> : 27017,</span><br><span class="line">                <span class="string">&quot;version&quot;</span> : <span class="string">&quot;4.2.11&quot;</span>,</span><br><span class="line">                <span class="string">&quot;gitVersion&quot;</span> : <span class="string">&quot;ea38428f0c6742c7c2c7f677e73d79e17a2aab96&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ok&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对某一个字段添加索引</span></span><br><span class="line">db.myuser.ensureIndex( &#123;name:1&#125; )</span><br><span class="line"><span class="comment">#添加唯一索引  &#123;unique:true&#125; 唯一索引仅适用于字段值没有相等条目的情况</span></span><br><span class="line">db.myuser.ensureIndex( &#123;userid:1&#125;,&#123;unique:<span class="literal">true</span>&#125; ) </span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-mongo基础"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/mongo%E5%9F%BA%E7%A1%80/"
    >mongo基础</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/mongo%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><ol>
<li>database  #数据库</li>
<li>collection  #集合  相当于mysql的表</li>
<li>filed          #字段  但不想mysql一样 所有行的字段必须一致  mongo是可以不一致的 但一般不这样使用</li>
<li>document #每行的记录</li>
</ol>
<h1 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h1><h2 id="查询数据库"><a href="#查询数据库" class="headerlink" title="查询数据库"></a>查询数据库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  mongo</span><br><span class="line"><span class="comment">#查询数据库  下面三个库是默认生成的</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="正确关闭mongodb的方法"><a href="#正确关闭mongodb的方法" class="headerlink" title="正确关闭mongodb的方法"></a>正确关闭mongodb的方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换到 admin 库</span></span><br><span class="line">&gt; use admin</span><br><span class="line">switched to db admin</span><br><span class="line"><span class="comment">#关闭服务</span></span><br><span class="line">&gt; db.shutdownServer()</span><br><span class="line">2020-12-21T16:51:52.502+0800 I  NETWORK  [js] DBClientConnection failed to receive message from 127.0.0.1:27017 - HostUnreachable: Connection closed by peer</span><br><span class="line">server should be down...</span><br><span class="line">&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h2 id="创建库"><a href="#创建库" class="headerlink" title="创建库"></a>创建库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#use 命令当库存在的时候 切换到此库 当不存在时 写入数据时创建此库</span></span><br><span class="line">use database_name</span><br></pre></td></tr></table></figure>

<h2 id="创建集合和字段"><a href="#创建集合和字段" class="headerlink" title="创建集合和字段"></a>创建集合和字段</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#切换到一个不存在的库</span><br><span class="line">&gt; use shijiange </span><br><span class="line">switched to db shijiange</span><br><span class="line">#插入数据 到一个不存在的表(集合) myuser</span><br><span class="line">&gt; db.myuser.insert(&#123; name: &#39;shijiange1&#39;, age: 27 &#125;)</span><br><span class="line">WriteResult(&#123; &quot;nInserted&quot; : 1 &#125;)</span><br><span class="line">#发现由于我们插入数据触发写操作 库被自动创建</span><br><span class="line">&gt; show dbs</span><br><span class="line">admin      0.000GB</span><br><span class="line">config     0.000GB</span><br><span class="line">local      0.000GB</span><br><span class="line">shijiange  0.000GB</span><br></pre></td></tr></table></figure>

<h2 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; use shijiange </span><br><span class="line">switched to db shijiange</span><br><span class="line">&gt; show tables</span><br><span class="line">myuser</span><br><span class="line"><span class="comment">#全量查询  如果本页面不够现实 他会分页 it 命令翻页</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06585a78ed0ef0786cf2b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b7&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 26 &#125;</span><br><span class="line"><span class="comment">#条件查询</span></span><br><span class="line">&gt; db.myuser.find( &#123; name: <span class="string">&#x27;shijiange1&#x27;</span> &#125; )</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06585a78ed0ef0786cf2b&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pretty() 易读方式 查询</span></span><br><span class="line">&gt; db.myuser.find().pretty()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 20</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 28</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 38</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#限制条目</span></span><br><span class="line">&gt; db.myuser.find().<span class="built_in">limit</span>(2)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#跳过条目数</span></span><br><span class="line"><span class="comment">#跳过前两条显示之后的两条</span></span><br><span class="line">&gt; db.myuser.find().skip(2).<span class="built_in">limit</span>(2)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#混合使用</span></span><br><span class="line">&gt; db.myuser.find().<span class="built_in">limit</span>(2).pretty()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 20</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>),</span><br><span class="line">        <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;age&quot;</span> : 28</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#升序</span></span><br><span class="line">&gt; db.myuser.find().sort(&#123;age: 1&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f40&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan2&quot;</span>, <span class="string">&quot;age&quot;</span> : 68 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#降序</span></span><br><span class="line">&gt; db.myuser.find().sort(&#123;age: -1&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f40&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan2&quot;</span>, <span class="string">&quot;age&quot;</span> : 68 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3f&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan1&quot;</span>, <span class="string">&quot;age&quot;</span> : 58 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="比较查询"><a href="#比较查询" class="headerlink" title="比较查询"></a>比较查询</h2><ul>
<li>$gt    #大于</li>
<li>$lt    #小于</li>
<li>$gte    #大于或等于</li>
<li>$lte    #小于或等于</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例</span></span><br><span class="line">&gt; db.myuser.find(&#123; age: &#123;<span class="variable">$lt</span>: 30&#125; &#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811d62ad68dbbee69f41&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;zhangsan3&quot;</span>, <span class="string">&quot;age&quot;</span> : 25 &#125;</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<h2 id="与或查询"><a href="#与或查询" class="headerlink" title="与或查询"></a>与或查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#或</span></span><br><span class="line">&gt; db.myuser.find(&#123;<span class="variable">$or</span>:[&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;,&#123;name: <span class="string">&#x27;shijiange2&#x27;</span>&#125;]&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3c&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange1&quot;</span>, <span class="string">&quot;age&quot;</span> : 20 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line"><span class="comment">#与</span></span><br><span class="line">db.myuser.find(&#123;<span class="variable">$and</span>:[&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;,&#123;name: <span class="string">&#x27;shijiange2&#x27;</span>&#125;]&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="正则查询"><a href="#正则查询" class="headerlink" title="正则查询"></a>正则查询</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#类似grep匹配 包含即可匹配</span></span><br><span class="line">&gt; db.myuser.find(&#123; name: &#123;<span class="variable">$regex</span>: <span class="string">&quot;shijiange[2-3]&quot;</span>&#125; &#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3d&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 28 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0811c62ad68dbbee69f3e&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 38 &#125;</span><br></pre></td></tr></table></figure>



<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; use shijiange</span><br><span class="line">switched to db shijiange</span><br><span class="line">&gt; show tables</span><br><span class="line">myuser</span><br><span class="line"><span class="comment">#条件删除</span></span><br><span class="line">&gt; db.myuser.remove(&#123;name: <span class="string">&#x27;shijiange1&#x27;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nRemoved&quot;</span> : 1 &#125;)</span><br><span class="line"><span class="comment">#验证 shijiange1 的数据没有了</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b6&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange2&quot;</span>, <span class="string">&quot;age&quot;</span> : 27 &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe0670b5decea8cd3f7c4b7&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;shijiange3&quot;</span>, <span class="string">&quot;age&quot;</span> : 26 &#125;</span><br><span class="line"><span class="comment">#删除表内所有数据</span></span><br><span class="line">&gt; db.myuser.remove(&#123;&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nRemoved&quot;</span> : 2 &#125;)</span><br><span class="line"><span class="comment">#发现表内什么都没有了</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&gt; </span><br><span class="line"><span class="comment">#删除集合 myuser</span></span><br><span class="line">&gt; db.myuser.drop()</span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="comment">#查看集合 发现确实删除了</span></span><br><span class="line">&gt; show tables</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>

<h2 id="修改数据"><a href="#修改数据" class="headerlink" title="修改数据"></a>修改数据</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06e9b591eadd5db5b3ffb&quot;</span>), <span class="string">&quot;arg&quot;</span> : 1, <span class="string">&quot;int&quot;</span> : 2 &#125;</span><br><span class="line"><span class="comment">#修改 arg: 1 为 arg: 2 </span></span><br><span class="line">&gt; db.myuser.update(&#123; arg: 1 &#125;,&#123; <span class="variable">$set</span>: &#123; arg: 2 &#125; &#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : 1, <span class="string">&quot;nUpserted&quot;</span> : 0, <span class="string">&quot;nModified&quot;</span> : 1 &#125;)</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">&gt; db.myuser.find()</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;5fe06e9b591eadd5db5b3ffb&quot;</span>), <span class="string">&quot;arg&quot;</span> : 2, <span class="string">&quot;int&quot;</span> : 2 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="删库"><a href="#删库" class="headerlink" title="删库"></a>删库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#切换到想要删除的库</span></span><br><span class="line">&gt; use shijiange</span><br><span class="line">switched to db shijiange</span><br><span class="line"><span class="comment">#删除库</span></span><br><span class="line">&gt; db.dropDatabase()</span><br><span class="line">&#123; <span class="string">&quot;dropped&quot;</span> : <span class="string">&quot;shijiange&quot;</span>, <span class="string">&quot;ok&quot;</span> : 1 &#125;</span><br><span class="line"><span class="comment">#验证</span></span><br><span class="line">&gt; show dbs</span><br><span class="line">admin   0.000GB</span><br><span class="line">config  0.000GB</span><br><span class="line"><span class="built_in">local</span>   0.000GB</span><br><span class="line"><span class="comment">#自带库千万别动</span></span><br></pre></td></tr></table></figure>

<h2 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mongodb实时监控之mongostat</span><br><span class="line">mongostat可以实时监控mongodb的状态，一直刷新输出</span><br><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongostat --<span class="built_in">help</span></span><br><span class="line">/usr/<span class="built_in">local</span>/mongodb/bin/mongostat  -h 127.0.0.1:27017</span><br><span class="line"></span><br><span class="line">测试脚本</span><br><span class="line">use shijiange</span><br><span class="line"><span class="keyword">for</span>(i=1; i&lt;=300000;i++)&#123;</span><br><span class="line">  db.myuser.insert( &#123;name:<span class="string">&#x27;mytest&#x27;</span>+i, age:i&#125; )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mongodb监控之serverStatus</span><br><span class="line">serverStatus可用来获取mongodb的状态信息</span><br><span class="line">db.serverStatus()			<span class="comment">#查看所有的监控信息</span></span><br><span class="line">db.serverStatus().network	<span class="comment">#单独查看网络流量信息</span></span><br><span class="line">db.serverStatus().opcounters	<span class="comment">#统计增、删、改、查的次数</span></span><br><span class="line">db.serverStatus().connections<span class="comment">#连接</span></span><br><span class="line"></span><br><span class="line">使用非交互式shell进行获取</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;db.serverStatus()&#x27;</span> | /usr/<span class="built_in">local</span>/mongodb/bin/mongo 127.0.0.1:27017</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;db.serverStatus().opcounters&#x27;</span> | /usr/<span class="built_in">local</span>/mongodb/bin/mongo 127.0.0.1:27017</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-备份与恢复"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/"
    >备份与恢复</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="mongodump-备份数据"><a href="#mongodump-备份数据" class="headerlink" title="mongodump 备份数据"></a>mongodump 备份数据</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#备份所有数据到目录</span></span><br><span class="line">mongodump -h 127.0.0.1:27017 -o /data/mongodbbackup/</span><br></pre></td></tr></table></figure>



<h1 id="mongorestore-导入备份好的数据"><a href="#mongorestore-导入备份好的数据" class="headerlink" title="mongorestore 导入备份好的数据"></a>mongorestore 导入备份好的数据</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从备份目录恢复数据</span></span><br><span class="line">mongorestore -h 127.0.0.1:27018 /data/mongodbbackup/</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-认证"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/18/%E8%AE%A4%E8%AF%81/"
    >用户认证</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/18/%E8%AE%A4%E8%AF%81/" class="article-date">
  <time datetime="2019-05-18T02:24:23.000Z" itemprop="datePublished">2019-05-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/MongoDB/">MongoDB</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h1><h2 id="数据库用户角色（Database-User-Roles"><a href="#数据库用户角色（Database-User-Roles" class="headerlink" title="数据库用户角色（Database User Roles)"></a><strong>数据库用户角色（Database User Roles)</strong></h2><ul>
<li>read : 授权User只读数据的权限，允许用户读取指定的数据库</li>
<li>readWrite 授权User读/写数据的权限，允许用户读/写指定的数据库</li>
</ul>
<h2 id="数据库管理角色（Database-Admininstration-Roles"><a href="#数据库管理角色（Database-Admininstration-Roles" class="headerlink" title="数据库管理角色（Database Admininstration Roles)"></a><strong>数据库管理角色（Database Admininstration Roles)</strong></h2><ul>
<li>dbAdmin：在当前的数据库中执行管理操作，如索引的创建、删除、统计、查看等</li>
<li>dbOwner：在当前的数据库中执行任意操作，增、删、改、查等</li>
<li>userAdmin ：在当前的数据库中管理User<strong>，</strong>创建、删除和管理用户。</li>
</ul>
<h2 id="备份和还原角色（Backup-and-Restoration-Roles"><a href="#备份和还原角色（Backup-and-Restoration-Roles" class="headerlink" title="备份和还原角色（Backup and Restoration Roles)"></a><strong>备份和还原角色（Backup and Restoration Roles)</strong></h2><ul>
<li>backup</li>
<li>restore</li>
</ul>
<h2 id="跨库角色（All-Database-Roles"><a href="#跨库角色（All-Database-Roles" class="headerlink" title="跨库角色（All-Database Roles)"></a><strong>跨库角色（All-Database Roles)</strong></h2><ul>
<li>readAnyDatabase：授权在所有的数据库上读取数据的权限，只在admin 中可用</li>
<li>readWriteAnyDatabase：授权在所有的数据库上读写数据的权限，只在admin 中可用</li>
<li>userAdminAnyDatabase：授权在所有的数据库上管理User的权限，只在admin中可用</li>
<li>dbAdminAnyDatabase： 授权管理所有数据库的权限，只在admin 中可用</li>
</ul>
<h2 id="集群管理角色（Cluster-Administration-Roles"><a href="#集群管理角色（Cluster-Administration-Roles" class="headerlink" title="集群管理角色（Cluster Administration Roles)"></a><strong>集群管理角色（Cluster Administration Roles)</strong></h2><ul>
<li>clusterAdmin：授权管理集群的最高权限，只在admin中可用</li>
<li>clusterManager：授权管理和监控集群的权限</li>
<li>clusterMonoitor：授权监控集群的权限，对监控工具具有readonly的权限</li>
<li>hostManager：管理server</li>
</ul>
<h2 id="超级角色（super-master-Roles"><a href="#超级角色（super-master-Roles" class="headerlink" title="超级角色（super master  Roles)"></a><strong>超级角色（super master  Roles)</strong></h2><ul>
<li>root ：超级账户和权限，只在admin中可用le</li>
</ul>
<h1 id="单机开启认证"><a href="#单机开启认证" class="headerlink" title="单机开启认证"></a>单机开启认证</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line">systemLog:</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#认证相关配置</span></span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure>

<h1 id="单机创建用户并授予角色权限"><a href="#单机创建用户并授予角色权限" class="headerlink" title="单机创建用户并授予角色权限"></a>单机创建用户并授予角色权限</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"><span class="comment">#创建一个用户shijiange 并设置密码 授予root权限 以及操作的库</span></span><br><span class="line">db.createUser(&#123;</span><br><span class="line">  user: <span class="string">&quot;shijiange&quot;</span>,</span><br><span class="line">  <span class="built_in">pwd</span>: <span class="string">&quot;mypwd&quot;</span>,</span><br><span class="line">  roles: [ &#123; role: <span class="string">&quot;root&quot;</span>, db: <span class="string">&quot;admin&quot;</span>&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="副本集开启认证"><a href="#副本集开启认证" class="headerlink" title="副本集开启认证"></a>副本集开启认证</h1><h2 id="副本集开启认证集群必须开启秘钥通讯"><a href="#副本集开启认证集群必须开启秘钥通讯" class="headerlink" title="副本集开启认证集群必须开启秘钥通讯"></a>副本集开启认证集群必须开启秘钥通讯</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成key 所有节点key必须一致</span></span><br><span class="line">openssl rand -base64 756 &gt; /data/mongodb/shijiange.key</span><br><span class="line">chmod 700 /data/mongodb/shijiange.key</span><br><span class="line"><span class="comment">#编辑配置文件</span></span><br><span class="line"></span><br><span class="line">systemLog:</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">#认证相关配置</span></span><br><span class="line">security:</span><br><span class="line">  keyFile: /data/mongodb/shijiange.key</span><br><span class="line">  authorization: enabled</span><br><span class="line">  </span><br><span class="line"><span class="comment">#配置调试集群 以及优先级</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<h2 id="创建用户并赋予角色"><a href="#创建用户并赋予角色" class="headerlink" title="创建用户并赋予角色"></a>创建用户并赋予角色</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">#创建一个用户shijiange 并设置密码 授予root权限 以及操作的库</span><br><span class="line">db.createUser(&#123;</span><br><span class="line">  user: &quot;shijiange&quot;,</span><br><span class="line">  pwd: &quot;mypwd&quot;,</span><br><span class="line">  roles: [ &#123; role: &quot;root&quot;, db: &quot;admin&quot;&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="登录并认证"><a href="#登录并认证" class="headerlink" title="登录并认证"></a>登录并认证</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启认证后 必须登录 否则不能进行读写操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#登录方法1</span></span><br><span class="line">~]<span class="comment"># mongo</span></span><br><span class="line">&gt;use admin</span><br><span class="line">&gt;db.auth(<span class="string">&#x27;shijiange&#x27;</span>, <span class="string">&#x27;mypwd&#x27;</span>)</span><br><span class="line"><span class="comment">#登录方法2</span></span><br><span class="line">~]<span class="comment"># mongo -ushijiange -pmypwd --authenticationDatabase admin</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDB/" rel="tag">MongoDB</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-安装与配置"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/"
    >配置</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="配置文件优先级"><a href="#配置文件优先级" class="headerlink" title="配置文件优先级"></a>配置文件优先级</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从高到低</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#变量</span></span><br><span class="line"><span class="variable">$ANSIBLE_CONFIG</span></span><br><span class="line"><span class="comment">#当前目录</span></span><br><span class="line">ansible.cfg </span><br><span class="line"><span class="comment">#家目录</span></span><br><span class="line">.ansible.cfg </span><br><span class="line"><span class="comment">#etc</span></span><br><span class="line">/etc/ansible/ansible.cfg </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/ansible.cfg</span><br><span class="line"></span><br><span class="line">inventory      = /etc/ansible/hosts       <span class="comment">#主机列表配置文件</span></span><br><span class="line">library        = /usr/share/my_modules/   <span class="comment">#库文件存放目录</span></span><br><span class="line">remote_tmp     = ~/.ansible/tmp           <span class="comment">#临时py文件存放在远程主机目录</span></span><br><span class="line">local_tmp      = ~/.ansible/tmp           <span class="comment">#本机的临时执行目录</span></span><br><span class="line">forks          = 5                        <span class="comment">#默认并发数(同时操作主机的数量)命令行可以使用-f单次临时更改</span></span><br><span class="line">sudo_user      = root                     <span class="comment">#默认sudo用户</span></span><br><span class="line">ask_sudo_pass = True                      <span class="comment">#每次执行是否询问sudo的ssh密码</span></span><br><span class="line">ask_pass      = True                      <span class="comment">#每次执行是否询问ssh密码</span></span><br><span class="line">remote_port    = 22                       <span class="comment">#远程主机端口</span></span><br><span class="line">host_key_checking = False                 <span class="comment">#跳过检查主机指纹</span></span><br><span class="line">log_path = /var/<span class="built_in">log</span>/ansible.log           <span class="comment">#ansible日志</span></span><br><span class="line">host_key_checking = False                 <span class="comment">#是否检查host指纹信息 如果是false 就跳过了第一次连接的yes/no的交互操作</span></span><br><span class="line">[privilege_escalation]					<span class="comment">#如果被控是普通用户则需要配置提权</span></span><br><span class="line"><span class="comment">#become=True</span></span><br><span class="line"><span class="comment">#become_method=sudo</span></span><br><span class="line"><span class="comment">#become_user=root</span></span><br><span class="line"><span class="comment">#become_ask_pass=False</span></span><br></pre></td></tr></table></figure>

<h2 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认会加载/etc/ansible/hosts 或使用 -i 指定位置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#组名称</span></span><br><span class="line">[group_name]</span><br><span class="line">ip或者域名  配置 配置 ....</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于密码的连接 ansible_ssh_port可省略默认22 </span></span><br><span class="line"><span class="comment">#这三行可以简化为一行 192.168.1.9[1:3] ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=&#x27;123456&#x27;</span></span><br><span class="line">[nginx_server]</span><br><span class="line">192.168.1.91 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">&#x27;123456&#x27;</span></span><br><span class="line">192.168.1.92 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">&#x27;123456&#x27;</span></span><br><span class="line">192.168.1.93 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">&#x27;123456&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#host别名</span></span><br><span class="line">[nginx_server]</span><br><span class="line">web01 ansible_ssh_host=192.168.1.91</span><br><span class="line">web02 ansible_ssh_host=192.168.1.92</span><br><span class="line">web03 ansible_ssh_host=192.168.1.93</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#通常不会使用密码连接 基本都是用秘钥连接 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-常用模块"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/"
    >常用模块</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><ul>
<li>command                 # 执行shell命令(不支持管道等特殊字符)</li>
<li>shell                           # 执行shell命令</li>
<li>scripts                        # 执行shell脚本</li>
<li>yum_repository      # 配置yum仓库</li>
<li>联网下载        get_url</li>
<li>安装            yum</li>
<li>配置            copy</li>
<li>启动            service、systemd</li>
<li>创建用户与组    user、group</li>
<li>授权            file</li>
<li>定时任务        crond</li>
<li>挂载            mount</li>
<li>firewalld        firewall</li>
<li>selinux            selinux</li>
</ul>
<h2 id="ad-hoc"><a href="#ad-hoc" class="headerlink" title="ad-hoc"></a>ad-hoc</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看帮助</span></span><br><span class="line">ansible-doc -l        <span class="comment"># 查看所有模块说明</span></span><br><span class="line">ansible-doc copy      <span class="comment"># 表示指定模块方法</span></span><br><span class="line">ansible-doc -s copy   <span class="comment"># 表示指定模块参数</span></span><br></pre></td></tr></table></figure>

<h2 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a <span class="string">&#x27;df -h&#x27;</span>    </span><br></pre></td></tr></table></figure>

<h2 id="script"><a href="#script" class="headerlink" title="script"></a>script</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行脚本</span></span><br><span class="line">ansible all -m script -a <span class="string">&quot;./test.sh&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装包</span></span><br><span class="line">ansible all -m yum -a <span class="string">&#x27;name=wget &#x27;</span></span><br><span class="line"><span class="comment">#卸载</span></span><br><span class="line">ansible all -m yum -a <span class="string">&#x27;name=wget state=absent&#x27;</span></span><br><span class="line"><span class="comment">#更新所有软件包</span></span><br><span class="line">ansible all -m yum -a <span class="string">&quot;name=* state=latest&quot;</span></span><br><span class="line"><span class="comment">#name可以是一个rpm包的url下载路径或者本地绝对路径</span></span><br><span class="line"><span class="comment">#state 指定使用yum的方法 present安装软件包 absent移除软件包 latest安装最新软件包 </span></span><br><span class="line"><span class="comment">#默认state=present</span></span><br></pre></td></tr></table></figure>

<h2 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制</span></span><br><span class="line">ansible all -m copy -a <span class="string">&quot;src=./anaconda-ks.cfg dest=/tmp/ owner=root group=root mode=0600 backup=yes&quot;</span></span><br><span class="line"><span class="comment">#backup默认是no 将直接覆盖目标路径 backup=yes时 将在目标目录生成文件名加日期的文件作为备份</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用content直接指定文本内容 并在目标主机生成文件</span></span><br><span class="line">ansible all -m copy -a <span class="string">&#x27;content=&quot;/data 192.168.1.0/24(rw,sync,no_all_squash)&quot; dest=/etc/exports&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="file"><a href="#file" class="headerlink" title="file"></a>file</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改权限 recurse 是递归 默认recurse=no , state=directory 声明此路径是目录默认是文件</span></span><br><span class="line">ansible all -m file -a <span class="string">&quot;path=/app state=directory mode=0600 owner=www group=www recurse=yes&quot;</span></span><br><span class="line"><span class="comment">#创建一个空文件</span></span><br><span class="line">ansible all -m file -a <span class="string">&quot;path=/app/file1 state=touch  ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#state</span></span><br><span class="line">directory <span class="comment">#目录</span></span><br><span class="line">touch <span class="comment">#创建</span></span><br><span class="line">link  <span class="comment">#软连接</span></span><br><span class="line">absent <span class="comment">#删除</span></span><br></pre></td></tr></table></figure>

<h2 id="get-url"><a href="#get-url" class="headerlink" title="get_url"></a>get_url</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#长用于下载一些文件dist可以是目录 也可以是文件</span></span><br><span class="line">ansible all -m get_url -a <span class="string">&quot;url=https://.../file.rpm dist=/usr/local/src mode=0600 checksum =md5:lkixjhdiujjdldljj&quot;</span></span><br><span class="line"></span><br><span class="line">checksum <span class="comment">#用于哈希验证 可省略 </span></span><br></pre></td></tr></table></figure>

<h2 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m systemd -a <span class="string">&quot; name=nginx state=stopped enabled=no&quot;</span></span><br><span class="line"><span class="comment">#enabled是设定此服务是否开机自动启动</span></span><br><span class="line"><span class="comment">#state</span></span><br><span class="line">startde <span class="comment">#启动</span></span><br><span class="line">restarted <span class="comment">#重新启动</span></span><br><span class="line">stopped <span class="comment">#停止</span></span><br><span class="line">reload <span class="comment">#重载服务</span></span><br></pre></td></tr></table></figure>

<h2 id="group"><a href="#group" class="headerlink" title="group"></a>group</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#删除组</span></span><br><span class="line">ansible all -m group -a <span class="string">&quot;name=test state=absent&quot;</span></span><br><span class="line"><span class="comment">#创建组</span></span><br><span class="line">ansible all -m group -a <span class="string">&quot;name=test gid=8888 &quot;</span></span><br><span class="line"><span class="comment">#state</span></span><br><span class="line">absent <span class="comment">#删除</span></span><br><span class="line">present <span class="comment">#创建 默认就是创建</span></span><br></pre></td></tr></table></figure>

<h2 id="user"><a href="#user" class="headerlink" title="user"></a>user</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户</span></span><br><span class="line">ansible all -m user -a <span class="string">&quot;name=nero comment=&#x27;nidelaofuqin&#x27; uid=8888 group=root create_home=no&quot;</span></span><br><span class="line"><span class="comment">#删除用户</span></span><br><span class="line">ansible all -m user -a <span class="string">&quot;name=nero state=absent remove=yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给用户添加秘钥对</span></span><br><span class="line">ansible all -m user -a <span class="string">&quot;name=nero generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa&quot;</span></span><br><span class="line"></span><br><span class="line">create_home <span class="comment">#是否创建家目录默认创建</span></span><br><span class="line">remove <span class="comment">#是否删除家目录</span></span><br><span class="line">name <span class="comment">#名称</span></span><br><span class="line">shell <span class="comment">#指定shell 如 shell=/bin/bash</span></span><br><span class="line">comment <span class="comment">#描述</span></span><br><span class="line">uid <span class="comment">#uid</span></span><br><span class="line">group <span class="comment">#加入那个组 这个组必须事先存在</span></span><br><span class="line">groups <span class="comment">#附加组 如 groups=www,root</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给用户添加密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#给密码做哈希  salt 是盐</span></span><br><span class="line">╰─➤  ansible localhost -m debug -a <span class="string">&quot;msg=&#123;&#123; &#x27;123456&#x27; | password_hash(&#x27;sha512&#x27;, &#x27;salt&#x27;) &#125;&#125;&quot;</span> </span><br><span class="line">localhost | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;<span class="variable">$6</span><span class="variable">$salt</span><span class="variable">$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w</span>.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#给用户添加密码 注意一定要单引号</span></span><br><span class="line">ansible all -m user -a <span class="string">&#x27;name=nero password=$6$salt$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.igcOo1R7vBYR65JquIQ/7siC7VRpmteKvZmfSkNc69.&#x27;</span></span><br><span class="line"><span class="comment">#也可以在创建用户的时候直接给定密码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#添加定时任务</span></span><br><span class="line">ansible all -m cron -a <span class="string">&quot;name=test minute=0 hour=5,2 job=&#x27;/bin/bash test.sh &amp;&gt;/dev/null&#x27;&quot;</span></span><br><span class="line"><span class="comment">#删除定时任务</span></span><br><span class="line">ansible all -m cron -a <span class="string">&quot;name=test state=absent&quot;</span></span><br><span class="line"><span class="comment">#注释定时任务 必须跟job</span></span><br><span class="line">ansible all -m cron -a <span class="string">&quot;name=test disable=yes job=&#x27;/bin/bash test.sh &amp;&gt;/dev/null&#x27;&quot;</span></span><br><span class="line">╰─➤  crontab -l</span><br><span class="line"><span class="comment">#Ansible: test</span></span><br><span class="line"><span class="comment">#* * * * * /bin/bash test.sh &amp;&gt;/dev/null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#name 可以自定义 且建议都写上 因为 ansible删除的时候也是基于name的值 </span></span><br><span class="line">minute hour day month weekday <span class="comment">#分,时,日,月,星期</span></span><br><span class="line"><span class="comment">#如果是*可以省略</span></span><br></pre></td></tr></table></figure>

<h2 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m mount -a <span class="string">&quot;src=172.16.1.7:/data path=/data fstype=nfs opts=defaults state=mounted&quot;</span></span><br><span class="line"><span class="comment">#state</span></span><br><span class="line">present     <span class="comment"># 开机挂载，仅将挂载配置写入/etc/fstab</span></span><br><span class="line">mounted     <span class="comment"># 挂载设备，并将配置写入/etc/fstab</span></span><br><span class="line">unmounted   <span class="comment"># 卸载设备，不会清除/etc/fstab写入的配置</span></span><br><span class="line">absent      <span class="comment"># 卸载设备，会清理/etc/fstab写入的配置</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-playbook"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/playbook/"
    >Playbook</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/playbook/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ansible/">ansible</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Playbook"><a href="#Playbook" class="headerlink" title="Playbook"></a>Playbook</h1><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#安装一个httpd 并启动</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment">#yum模块 安装httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="comment">#systemd模块 启动并设置开机启动</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">startde</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web1</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> </span><br><span class="line">        <span class="attr">content:</span> <span class="string">&#x27;this is the web1&#x27;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web2</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">&#x27;this is the web2&#x27;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/var/www/html/index.html</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法2</span></span><br><span class="line">---</span><br><span class="line"><span class="comment">#安装一个httpd 并启动</span></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">    <span class="comment">#yum模块 安装httpd</span></span><br><span class="line">    - name: install httpd</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line">    <span class="comment">#systemd模块 启动并设置开机启动</span></span><br><span class="line">    - name: start httpd</span><br><span class="line">      systemd: name=httpd state=startde enabled=yes </span><br><span class="line">- hosts: web1</span><br><span class="line">  tasks:</span><br><span class="line">    - name: web1 file</span><br><span class="line">      copy: content=<span class="string">&#x27;this is the web1&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line">    </span><br><span class="line">- hosts: web2</span><br><span class="line">  tasks:</span><br><span class="line">    - name: web2 file</span><br><span class="line">      copy: content=<span class="string">&#x27;this is the web2&#x27;</span> dest=/var/www/html/index.html</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -C httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="语法校验"><a href="#语法校验" class="headerlink" title="语法校验"></a>语法校验</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook --syntax-check httpd.yml</span><br></pre></td></tr></table></figure>

<h3 id="真正执行"><a href="#真正执行" class="headerlink" title="真正执行"></a>真正执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook  httpd.yml</span><br></pre></td></tr></table></figure>

<h2 id="触发handlers"><a href="#触发handlers" class="headerlink" title="触发handlers"></a>触发handlers</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web2</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment">#此任务如执行成功就触发handlers 的 restart httpd任务</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web2</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">content=&#x27;this</span> <span class="string">is</span> <span class="string">the</span> <span class="string">web2&#x27;</span> <span class="string">dest=/var/www/html/index.html</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>

<h1 id="变量vars"><a href="#变量vars" class="headerlink" title="变量vars"></a>变量vars</h1><h2 id="定义变量方式"><a href="#定义变量方式" class="headerlink" title="定义变量方式"></a>定义变量方式</h2><ul>
<li>通过命令行定义变量</li>
<li>通过playbook文件中定义变量</li>
<li>通过主机清单定义组的变量或者主机的变量</li>
</ul>
<h2 id="变量优先级"><a href="#变量优先级" class="headerlink" title="变量优先级"></a>变量优先级</h2><ul>
<li>命令行变量  &gt;  playbook变量  &gt; 主机清单变量</li>
</ul>
<h2 id="playboot定义变量示例"><a href="#playboot定义变量示例" class="headerlink" title="playboot定义变量示例"></a>playboot定义变量示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#playbook 定义变量 此方式只在此任务生效</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">db_package:</span> <span class="string">mariadb-server</span></span><br><span class="line">  <span class="attr">task:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; db_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">          </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vars_files 方式定义playbook变量</span></span><br><span class="line">~ ]<span class="comment"># vim vars.yml</span></span><br><span class="line">web_package: httpd</span><br><span class="line">db_package: mariadb-server</span><br><span class="line"><span class="comment">#playbook引用变量文件</span></span><br><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  <span class="comment">#vars_files: ./vars.yml</span></span><br><span class="line">  vars_files:</span><br><span class="line">    - ./vars.yml</span><br><span class="line">  task:</span><br><span class="line">    - name: install package</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - <span class="string">&quot;&#123;&#123; web_package &#125;&#125;&quot;</span></span><br><span class="line">          - <span class="string">&quot;&#123;&#123; db_package &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br></pre></td></tr></table></figure>

<h2 id="主机清单定义变量示例"><a href="#主机清单定义变量示例" class="headerlink" title="主机清单定义变量示例"></a>主机清单定义变量示例</h2><ul>
<li>主机清单变量包括 主机变量 和组变量 其中 主机变量 &gt; 组变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此方式 官方不推荐</span></span><br><span class="line"><span class="comment">#定义变量</span></span><br><span class="line">vim hosts</span><br><span class="line">[web]</span><br><span class="line">192.168.1.123</span><br><span class="line">192.168.1.124</span><br><span class="line">[web:vars]</span><br><span class="line">file_name=file1</span><br><span class="line"></span><br><span class="line"><span class="comment">#引用变量</span></span><br><span class="line">---</span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name create file</span><br><span class="line">      file:</span><br><span class="line">        path: /tmp/&#123;&#123; file_name &#125;&#125;</span><br><span class="line">        state: touch</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方推荐的范式</span></span><br><span class="line"><span class="comment"># 在ansible的项目目录中创建额外的两个变量目录 分别是 host_vars 和 group_vars 名字必须是这两个</span></span><br><span class="line"><span class="comment"># group_vars目录用于保存针对某个组生效的变量文件 文件名应该与组名相同 此时playbook文件此组的任务中无需配置 自动加载此文件位变量文件</span></span><br><span class="line"><span class="comment"># 如果你想所有组都生效 可以利用自带的特殊组 all  在group_vars中建立all文件别再文件中编写变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group_vars 示例</span></span><br><span class="line">vim group_vars/web</span><br><span class="line">file_name=file1</span><br><span class="line"><span class="comment">#引用变量</span></span><br><span class="line">---</span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name create file</span><br><span class="line">      file:</span><br><span class="line">        path: /tmp/&#123;&#123; file_name &#125;&#125;</span><br><span class="line">        state: touch</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="命令行定义变量"><a href="#命令行定义变量" class="headerlink" title="命令行定义变量"></a>命令行定义变量</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#命令行定义变量优先级最好 可以覆盖所有相同名称的变量</span></span><br><span class="line">ansible-playbook f1.yml -e <span class="string">&quot;web_package=httpd&quot;</span> -e <span class="string">&quot;db_package=mariadb-server&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="层级变量定义"><a href="#层级变量定义" class="headerlink" title="层级变量定义"></a>层级变量定义</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#定义变量</span></span><br><span class="line"><span class="string">vim</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">rainbow:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">web_package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="attr">db_package:</span> <span class="string">mariadb</span></span><br><span class="line"><span class="attr">code:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">filename:</span> <span class="string">cede_filename</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#引用变量</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="comment">#vars_files: ./vars.yml</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./vars.yml</span></span><br><span class="line">  <span class="attr">task:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; rainbow.web.web_package &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; rainbow.web.db_package &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br></pre></td></tr></table></figure>

<h1 id="变量注册register"><a href="#变量注册register" class="headerlink" title="变量注册register"></a>变量注册register</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># ss -tnlp 的执行结果将会保存在 net_prot这个变量中</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">net_prot</span></span><br><span class="line">      <span class="comment">#打印出一个变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">optput</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; net_prot &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#输出结果</span><br><span class="line">TASK [optput network port status] *******************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">    #可以看到 输出是json格式mag 里面的内容内容 就是 你定义的变量的内容 可以使用 &#123;&#123; net_prot.stdout_lines &#125;&#125; 来只输出 标准输出的数据 </span><br><span class="line">ok: [192.168.1.81] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &#123;</span><br><span class="line">        &quot;changed&quot;: true, </span><br><span class="line">        &quot;cmd&quot;: &quot;ss -tnlp&quot;, </span><br><span class="line">        &quot;delta&quot;: &quot;0:00:00.022127&quot;, </span><br><span class="line">        &quot;end&quot;: &quot;2020-12-30 14:08:51.630273&quot;, </span><br><span class="line">        &quot;failed&quot;: false, </span><br><span class="line">        &quot;rc&quot;: 0, </span><br><span class="line">        &quot;start&quot;: &quot;2020-12-30 14:08:51.608146&quot;, </span><br><span class="line">        &quot;stderr&quot;: &quot;&quot;, </span><br><span class="line">        &quot;stderr_lines&quot;: [], </span><br><span class="line">        &quot;stdout&quot;: &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              \nLISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=33))\nLISTEN     0      128    192.168.1.83:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2156,fd=3))\nLISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=10))\nLISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=12))\nLISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=3049,fd=3))\nLISTEN     0      128    192.168.1.83:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=2339,fd=3))\nLISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2212,fd=3))\nLISTEN     0      128    127.0.0.1:41836                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=11))\nLISTEN     0      128    192.168.1.83:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=11))\nLISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=3160,fd=7))\nLISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=823,fd=3))\nLISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=29))\nLISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=823,fd=4))&quot;, </span><br><span class="line">            #这里是标准输出多行结果</span><br><span class="line">        &quot;stdout_lines&quot;: [</span><br><span class="line">            &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              &quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=33))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2156,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=10))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=12))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=3049,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=2339,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2212,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    127.0.0.1:41836                    *:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=11))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128    192.168.1.83:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=819,fd=11))&quot;, </span><br><span class="line">            &quot;LISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=3160,fd=7))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=823,fd=3))&quot;, </span><br><span class="line">            &quot;LISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1350,fd=29))&quot;, </span><br><span class="line">            <span class="string">&quot;LISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=823,fd=4))&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">get</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="comment"># ss -tnlp 的执行结果将会保存在 net_prot这个变量中</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">net_prot</span></span><br><span class="line">      <span class="comment">#打印出一个变量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">optput</span> <span class="string">network</span> <span class="string">port</span> <span class="string">status</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; net_prot.stdout_lines &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># net_prot.stdout_lines  输出结果</span><br><span class="line">TASK [optput network port status] ******************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.1.81] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: [</span><br><span class="line">        &quot;State      Recv-Q Send-Q Local Address:Port               Peer Address:Port              &quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:10248                    *:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=35))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128          *:32585                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=10))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:8681                     *:*                   users:((\&quot;cephcsi\&quot;,pid=2462,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:10249                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=12))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:9099                     *:*                   users:((\&quot;calico-node\&quot;,pid=4271,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:2379                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=7))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:2379                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=6))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:9100                     *:*                   users:((\&quot;kube-rbac-proxy\&quot;,pid=3482,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:9100                     *:*                   users:((\&quot;node_exporter\&quot;,pid=2574,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:2380                     *:*                   users:((\&quot;etcd\&quot;,pid=1642,fd=5))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    127.0.0.1:32783                    *:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=12))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128    192.168.1.81:10256                    *:*                   users:((\&quot;kube-proxy\&quot;,pid=828,fd=11))&quot;, </span><br><span class="line">        &quot;LISTEN     0      8            *:179                      *:*                   users:((\&quot;bird\&quot;,pid=4354,fd=7))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128          *:22                       *:*                   users:((\&quot;sshd\&quot;,pid=827,fd=3))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:10250                 [::]:*                   users:((\&quot;kubelet\&quot;,pid=1212,fd=36))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:8080                  [::]:*                   users:((\&quot;traefik\&quot;,pid=4836,fd=9))&quot;, </span><br><span class="line">        &quot;LISTEN     0      128       [::]:80                    [::]:*                   users:((\&quot;traefik\&quot;,pid=4836,fd=8))&quot;, </span><br><span class="line">        <span class="string">&quot;LISTEN     0      128       [::]:22                    [::]:*                   users:((\&quot;sshd\&quot;,pid=827,fd=4))&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="facts变量"><a href="#facts变量" class="headerlink" title="facts变量"></a>facts变量</h1><ul>
<li>facts变量 是在被控主机上自动采集到的信息</li>
<li>包含主机名 ip 系统版本 cpu 内存 磁盘状态等信息</li>
</ul>
<h2 id="获取一台主机的facts变量信息"><a href="#获取一台主机的facts变量信息" class="headerlink" title="获取一台主机的facts变量信息"></a>获取一台主机的facts变量信息</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible 192.168.1.81 -m setup</span><br></pre></td></tr></table></figure>

<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ansible_fqdn &#125;&#125;</span><br><span class="line">&#123;&#123; ansible_memory_mb.nocache.free &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关闭facts获取"><a href="#关闭facts获取" class="headerlink" title="关闭facts获取"></a>关闭facts获取</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认执行playbook的时候每次首先都要自动获取facts</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  <span class="comment"># 关闭facts采集</span></span><br><span class="line">  gather_facts: no</span><br><span class="line">  vars: </span><br><span class="line">    - zabbix_server: 172.16.1.71</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Zabbix Agent Configure</span><br><span class="line">      template: src=./zabbix_agentd.conf dest=/tmp/zabbix_agent.conf</span><br></pre></td></tr></table></figure>

<h1 id="条件执行"><a href="#条件执行" class="headerlink" title="条件执行"></a>条件执行</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#根据系统版本判断是否执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#语法1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      <span class="comment">#当facts变量 ansible_distribution 等于 CentOS 才执行此task</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">Ubuntu</span></span><br><span class="line">      <span class="attr">apt:</span> <span class="string">name=httpd2</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment">#语法2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd</span> </span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="comment">#当facts变量 ansible_distribution 等于 CentOS 才执行此task</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nsible_distribution</span> <span class="string">==</span> <span class="string">&quot;CentOS&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">Ubuntu</span></span><br><span class="line">      <span class="attr">apt:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">httpd2</span> </span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">&quot;Ubuntu&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字符串匹配.</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">Nginx</span> <span class="string">Repos</span></span><br><span class="line">      <span class="attr">yum_repository:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx_tet</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">Nginx</span> <span class="string">YUM</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">baseurl:</span> <span class="string">http://nginx.org/packages/centos/7/$basearch/</span></span><br><span class="line">        <span class="attr">gpgcheck:</span> <span class="literal">no</span></span><br><span class="line">      <span class="comment"># ansible_hostname是获取的主机名 此主机名以web开头 或者以lb开头的 执行此任务 or 后可以换行</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;web*&quot;)</span> <span class="string">or</span> <span class="string">(ansible_hostname</span> <span class="string">is</span> <span class="string">match</span> <span class="string">(&quot;lb*&quot;))</span></span><br></pre></td></tr></table></figure>

<h1 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#标准循环</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">server</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">yum:</span> </span><br><span class="line">        <span class="comment"># item变量 来自with_items列表 会循环执行 没一个值都会执行一次</span></span><br><span class="line">        <span class="attr">name:</span> &#123;&#123; <span class="string">item</span> &#125;&#125;</span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">httpd</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mariadb</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#变量循环</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: ensure a list of packages installed</span><br><span class="line">      yum: name= <span class="string">&quot;&#123;&#123; packages &#125;&#125;&quot;</span> state=present</span><br><span class="line">      vars:</span><br><span class="line">        packages:</span><br><span class="line">          - httpd</span><br><span class="line">          - httpd-tools</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#字典循环</span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Add Users</span><br><span class="line">      user: name=&#123;&#123; item.name &#125;&#125; groups=&#123;&#123; item.groups &#125;&#125; state=present</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; name: <span class="string">&#x27;testuser1&#x27;</span>, groups: <span class="string">&#x27;bin&#x27;</span> &#125;</span><br><span class="line">        - &#123; name: <span class="string">&#x27;testuser2&#x27;</span>, groups: <span class="string">&#x27;root&#x27;</span> &#125;</span><br><span class="line"><span class="comment">#示例2        </span></span><br><span class="line">- hosts: web</span><br><span class="line">  tasks:</span><br><span class="line">    - name: Copy Rsync configure and Rsync passwd</span><br><span class="line">      copy: src=&#123;&#123; item.src &#125;&#125; dest=&#123;&#123; item.dest &#125;&#125; mode=&#123;&#123; item.mode &#125;&#125;</span><br><span class="line">      with_items:</span><br><span class="line">        - &#123; src: <span class="string">&quot;./rsyncd.conf&quot;</span>, dest: <span class="string">&quot;/etc/rsyncd.conf&quot;</span>, mode: <span class="string">&quot;0644&quot;</span> &#125;</span><br><span class="line">        - &#123; src: <span class="string">&quot;./rsync.passwd&quot;</span>, dest: <span class="string">&quot;/tmp/rsync.passwd&quot;</span>, mode: <span class="string">&quot;0600&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<h1 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h1><ul>
<li>同一个 handlers任务,无论playbook中触发了多少次 只会在tasks任务执行完最后执行一次</li>
<li>只有task任务在被控主机发生了改变 才会触发 handlers任务</li>
<li>不能使用 handlers 代替tasks</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="comment">#正常情况下handlers被调用,但随后的task失败后整个任务停止,handlers 不会被调用</span></span><br><span class="line">  <span class="comment">#此配置是指 只要handlers被调用就必须执行handlers,无论后面是成功还是失败</span></span><br><span class="line">  <span class="comment">#不常用 通常用不到</span></span><br><span class="line">  <span class="attr">force_handlers:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Http</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configure</span> <span class="string">httpd</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line">      <span class="comment">#当此任务执行成功且目标主机发生改变触发以下两个handlers任务</span></span><br><span class="line">      <span class="attr">notify:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Restart</span> <span class="string">PHP</span> <span class="string">Server</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Httpd</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span> </span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">PHP</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=php-fpm</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>



<h1 id="任务标签"><a href="#任务标签" class="headerlink" title="任务标签"></a>任务标签</h1><h2 id="配置标签"><a href="#配置标签" class="headerlink" title="配置标签"></a>配置标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim test.yml</span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8083</span><br><span class="line">  tasks:</span><br><span class="line"></span><br><span class="line">    - name: Install Http Server</span><br><span class="line">      yum: name=httpd state=present</span><br><span class="line">      tags: install_httpd</span><br><span class="line"></span><br><span class="line">    - name: configure httpd server</span><br><span class="line">      template: src=./httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">      <span class="comment">#当此任务执行成功且目标主机发生改变触发以下两个handlers任务</span></span><br><span class="line">      notify: </span><br><span class="line">        - Restart Httpd Server</span><br><span class="line">      tags: configure_httpd</span><br><span class="line">    - name: start httpd server</span><br><span class="line">      service: name=httpd state=started enabled=yes</span><br><span class="line">      tags: start_httpd</span><br><span class="line">  handlers:</span><br><span class="line">    - name: Restart Httpd Server</span><br><span class="line">      systemd: name=httpd state=restarted </span><br></pre></td></tr></table></figure>

<h2 id="查看playbook中的标签"><a href="#查看playbook中的标签" class="headerlink" title="查看playbook中的标签"></a>查看playbook中的标签</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看playbook中的标签</span></span><br><span class="line">╰─➤  ansible-playbook test.yml --list-tags</span><br><span class="line">playbook: test.yml</span><br><span class="line"></span><br><span class="line">  play <span class="comment">#1 (webservers): webservers      TAGS: []</span></span><br><span class="line">      TASK TAGS: [configure_httpd, install_httpd, start_httpd]</span><br></pre></td></tr></table></figure>
<h2 id="指定执行某个标签的任务"><a href="#指定执行某个标签的任务" class="headerlink" title="指定执行某个标签的任务"></a>指定执行某个标签的任务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定执行某个标签的任务</span></span><br><span class="line">ansible-playbook test.yml -t start_httpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#指定运行多个标签的任务</span></span><br><span class="line">ansible-playbook test.yml -t install_httpd,start_httpd</span><br></pre></td></tr></table></figure>

<h1 id="Playbook文件复用"><a href="#Playbook文件复用" class="headerlink" title="Playbook文件复用"></a>Playbook文件复用</h1><h2 id="从文件调用tasks任务列表"><a href="#从文件调用tasks任务列表" class="headerlink" title="从文件调用tasks任务列表"></a>从文件调用tasks任务列表</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从文件调用tasks任务列表</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">f1.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">f2.yml</span></span><br></pre></td></tr></table></figure>

<h2 id="tasks任务列表文件格式"><a href="#tasks任务列表文件格式" class="headerlink" title="tasks任务列表文件格式"></a>tasks任务列表文件格式</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- name: Install Http Server</span><br><span class="line">  yum: name=httpd state=present</span><br><span class="line">  </span><br><span class="line">- name: start httpd server</span><br><span class="line">  service: name=httpd state=started enabled=yes</span><br></pre></td></tr></table></figure>

<h2 id="从文件调用整个playbook文件"><a href="#从文件调用整个playbook文件" class="headerlink" title="从文件调用整个playbook文件"></a>从文件调用整个playbook文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#顺序执行多个playbook</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">install_httpd.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">install_mysql.yml</span></span><br></pre></td></tr></table></figure>

<h1 id="忽略task任务失败"><a href="#忽略task任务失败" class="headerlink" title="忽略task任务失败"></a>忽略task任务失败</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Http</span> <span class="string">Server</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">      <span class="comment">#如果此任务失败继续执行其他任务 不会终止此playbook</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<h1 id="changed状态的抑制"><a href="#changed状态的抑制" class="headerlink" title="changed状态的抑制"></a>changed状态的抑制</h1><ul>
<li>changed_when中的条件成立时，将对应任务的执行状态设置为changed</li>
<li>changed_when  等于false 时  永远都是ok 除非报错</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例1</span></span><br><span class="line">- hosts: webservers</span><br><span class="line">  vars:</span><br><span class="line">    - http_port: 8083</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get port</span><br><span class="line">      <span class="comment">#很多shell命令一直都是changed状态无论执行多少次</span></span><br><span class="line">      shell: <span class="string">&quot;ss -tnlp&quot;</span></span><br><span class="line">      <span class="comment">#抑制changed状态, 永远都是ok状态</span></span><br><span class="line">      changed_when: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例2字符串匹配</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chack</span> <span class="string">nginx</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;nginx -t&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_t</span></span><br><span class="line">      <span class="comment">#如果变量中包含successful字符串 才会是changed状态,否则报错 报错则不会触发restart nginx的handlers</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="string">nginx_t.stdout.find(&#x27;successful&#x27;)</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">systemd:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> </span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#示例3 混合使用</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">8083</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">chack</span> <span class="string">nginx</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">&quot;nginx -t&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">nginx_t</span></span><br><span class="line">      <span class="attr">changed_when:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx_t.stdout.find(&#x27;successful&#x27;)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h1 id="ansible-vault-加密"><a href="#ansible-vault-加密" class="headerlink" title="ansible-vault 加密"></a>ansible-vault 加密</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#语法</span></span><br><span class="line">ansible-vault [-h] [--version] [-v]</span><br><span class="line">                     &#123;create,decrypt,edit,view,encrypt,encrypt_string,rekey&#125;</span><br><span class="line">                     ...</span><br><span class="line"><span class="comment">#动作</span></span><br><span class="line">    create              Create new vault encrypted file</span><br><span class="line">    decrypt             Decrypt vault encrypted file <span class="comment">#移除密码</span></span><br><span class="line">    edit                Edit vault encrypted file <span class="comment">#编辑一个加密文件</span></span><br><span class="line">    view                View vault encrypted file <span class="comment">#查看一个加密的文件</span></span><br><span class="line">    encrypt             Encrypt YAML file <span class="comment">#加密一个文件</span></span><br><span class="line">    encrypt_string      Encrypt a string <span class="comment">#加密字符串</span></span><br><span class="line">    rekey               Re-key a vault encrypted file  <span class="comment">#修改密码</span></span><br></pre></td></tr></table></figure>

<h1 id="jinja2模板"><a href="#jinja2模板" class="headerlink" title="jinja2模板"></a>jinja2模板</h1><h2 id="变量调用"><a href="#变量调用" class="headerlink" title="变量调用"></a>变量调用</h2><ul>
<li>jinja2变量调用 同样适用 表示变量</li>
<li>变量可以使用playbook中可以使用的所有变量包括facts变量</li>
</ul>
<h2 id="模板的推送"><a href="#模板的推送" class="headerlink" title="模板的推送"></a>模板的推送</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">./motd.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br></pre></td></tr></table></figure>

<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送示例</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">http_port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server_name:</span> <span class="string">www.nero.com</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Nginx</span> <span class="string">COnfigure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./nero.com.conf.j2</span> <span class="string">dest=/etc/nginx/conf.d/nero.com.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#jinja2模板示例</span><br><span class="line"></span><br><span class="line">upstream &#123;&#123; server_name &#125;&#125; &#123;</span><br><span class="line">#循环语句 </span><br><span class="line">&#123;% for i in range(1,20) %&#125;</span><br><span class="line">  server 172.16.1.&#123;&#123;i&#125;&#125;:&#123;&#123;http_port&#125;&#125;;</span><br><span class="line">&#123;%endfor%&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen &#123;&#123; http_port &#125;&#125;;</span><br><span class="line">	server_name &#123;&#123; server_name &#125;&#125;;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://&#123;&#123; server_name &#125;&#125;;</span><br><span class="line">		proxy_set_header Host $http_host;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="判断语句"><a href="#判断语句" class="headerlink" title="判断语句"></a>判断语句</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Keepalived</span> <span class="string">Configure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./kee.conf.j2</span> <span class="string">dest=/tmp/keepalived.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#模板内容</span><br><span class="line">global_defs &#123;     </span><br><span class="line">    router_id &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"> #判断语句</span><br><span class="line">&#123;%if ansible_hostname ==&quot;web01&quot; %&#125;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 150</span><br><span class="line">&#123;%elif ansible_hostname == &quot;web02&quot; %&#125;</span><br><span class="line">    state BACKUP</span><br><span class="line">    priority 100</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line"></span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">&#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">10.0</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推送.</span></span><br><span class="line"><span class="comment">#变量的开关</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">PORT:</span> <span class="number">13366</span></span><br><span class="line">    <span class="comment">#关闭这个变量</span></span><br><span class="line">    <span class="comment">#PORT: false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">mysql</span> <span class="string">Configure</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=./my.cnf.j2</span> <span class="string">dest=/tmp/my.cnf</span></span><br></pre></td></tr></table></figure>



<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#判断变量是否有值</span><br><span class="line">&#123;% if PORT %&#125;</span><br><span class="line">#如果 PORT 变量有值就使用此配置</span><br><span class="line">bind-address=0.0.0.0:&#123;&#123; PORT &#125;&#125;</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">#PORT没有值 就使用3306</span><br><span class="line">bind-address=0.0.0.0:3306</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h1><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#手动创建目录结构 </span></span><br><span class="line"><span class="built_in">cd</span> /etc/ansible/roles/</span><br><span class="line">mkdir nfs/&#123;vars,file,meta,tasks,handlers,templates&#125; -p</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  tree</span><br><span class="line">.</span><br><span class="line">└── nfs				<span class="comment">#角色名称</span></span><br><span class="line">    ├── file         <span class="comment">#存放文件</span></span><br><span class="line">    ├── handlers     <span class="comment">#触发任务</span></span><br><span class="line">    ├── meta         <span class="comment">#依赖关系</span></span><br><span class="line">    ├── tasks        <span class="comment">#具体任务 只能加载main.yml 再有main调用其他文件</span></span><br><span class="line">    ├── templates    <span class="comment">#模板文件</span></span><br><span class="line">    └── vars         <span class="comment">#定义变量</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用ansible-galaxy 生成结构</span></span><br><span class="line">ansible-galaxy init <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">╰─➤  tree</span><br><span class="line">.</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── defaults</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── files</span><br><span class="line">    ├── handlers</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── meta</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── README.md</span><br><span class="line">    ├── tasks</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    ├── templates</span><br><span class="line">    ├── tests</span><br><span class="line">    │   ├── inventory</span><br><span class="line">    │   └── test.yml</span><br><span class="line">    └── vars</span><br><span class="line">        └── main.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat roles/wordpress/meta/main.yml</span><br><span class="line">---</span><br><span class="line">dependencies:</span><br><span class="line">  - &#123; role: nginx &#125;</span><br><span class="line">  - &#123; role: php-fpm &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">#此时wordpress的role 会先执行 nginx 和php-fpm 的role 然后在执行本身wordpress的role</span></span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/" rel="tag">ansible</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-禅道忘记密码"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/%E7%A6%85%E9%81%93%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81/"
    >禅道忘记密码</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/%E7%A6%85%E9%81%93%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="禅道忘记密码处理"><a href="#禅道忘记密码处理" class="headerlink" title="禅道忘记密码处理"></a>禅道忘记密码处理</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/opt/zbox/run/mysql/mysql -uroot -p</span><br><span class="line">禅道数据库root默认密码123456</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| zentao             |</span><br><span class="line">| zentaobiz          |</span><br><span class="line">| zentaopro          |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use zentao;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">忘记admin密码后，修改zt_user表</span><br><span class="line"></span><br><span class="line">MariaDB [zentao]&gt; select id,account,password from zt_user;</span><br><span class="line">+----+---------+----------------------------------+</span><br><span class="line">| id | account | password                         |</span><br><span class="line">+----+---------+----------------------------------+</span><br><span class="line">|  1 | admin   | 070b17106ddfd497e1018e6a9990fb5f |</span><br><span class="line">+----+---------+----------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [zentao]&gt; update zt_user <span class="built_in">set</span> password=<span class="string">&#x27;e10adc3949ba59abbe56e057f20f883e&#x27;</span> <span class="built_in">where</span> id=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [zentao]&gt;</span><br><span class="line"></span><br><span class="line">e10adc3949ba59abbe56e057f20f883e即：123456</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A6%85%E9%81%93/" rel="tag">禅道</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-nginx-ingress"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/nginx-ingress/"
    >ingress-nginx</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/nginx-ingress/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/K8S/">K8S</a> / <a class="article-category-link" href="/categories/K8S/ingress/">ingress</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="HELM-安装-ingress-nginx-不推荐"><a href="#HELM-安装-ingress-nginx-不推荐" class="headerlink" title="HELM  安装  ingress-nginx (不推荐)"></a>HELM  安装  ingress-nginx (不推荐)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns ingress-nginx</span><br><span class="line">kubectl label nodes k-n2.sp.com IngressProxy=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx </span><br><span class="line">helm repo update</span><br><span class="line">helm pull ingress-nginx/ingress-nginx </span><br><span class="line">tar xf ingress-nginx-3.19.0.tgz </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">EOF &gt; ingress-nginx/values-prod.yaml</span></span><br><span class="line"><span class="string">controller:</span></span><br><span class="line"><span class="string">  name: controller</span></span><br><span class="line"><span class="string">  image:</span></span><br><span class="line"><span class="string">    repository: k8s.gcr.io/ingress-nginx/controller</span></span><br><span class="line"><span class="string">    #这里要与你当时下载的values.yaml内中的相符</span></span><br><span class="line"><span class="string">    tag: &quot;v0.43.0&quot;</span></span><br><span class="line"><span class="string">  dnsPolicy: ClusterFirstWithHostNet</span></span><br><span class="line"><span class="string">  hostNetwork: true</span></span><br><span class="line"><span class="string">  # hostNetwork 模式下设置为false，通过节点IP地址上报ingress status数据</span></span><br><span class="line"><span class="string">  publishService:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">  kind: DaemonSet</span></span><br><span class="line"><span class="string">  #节点选择</span></span><br><span class="line"><span class="string">  nodeSelector: </span></span><br><span class="line"><span class="string">    IngressProxy: &quot;true&quot;</span></span><br><span class="line"><span class="string">  # HostNetwork 模式不需要创建service</span></span><br><span class="line"><span class="string">  service:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">defaultBackend:</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  name: defaultbackend</span></span><br><span class="line"><span class="string">  image:</span></span><br><span class="line"><span class="string">    repository: k8s.gcr.io/defaultbackend-amd64</span></span><br><span class="line"><span class="string">    tag: &quot;1.5&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install --namespace ingress-nginx ingress-nginx ./ingress-nginx -f ./ingress-nginx/values-prod.yaml</span><br></pre></td></tr></table></figure>

<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n ingress-nginx </span><br><span class="line">NAME                                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">ingress-nginx-controller-tr2x7                  1/1     Running   0          34s</span><br><span class="line">ingress-nginx-defaultbackend-559f8cbf9f-pkq8p   1/1     Running   0          34s</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─root@k-n2.sp.com ~  </span><br><span class="line">╰─➤  ss -tnlp |grep -E <span class="string">&quot;80|443&quot;</span></span><br><span class="line">4LISTEN     0      128          *:443           *:*           users:((<span class="string">&quot;nginx&quot;</span>,pid=28683,fd=35),(<span class="string">&quot;nginx&quot;</span>,pid=28671,fd=35))</span><br><span class="line">LISTEN     0      128          *:443            *:*           users:((<span class="string">&quot;nginx&quot;</span>,pid=28682,fd=21),(<span class="string">&quot;nginx&quot;</span>,pid=28671,fd=21))</span><br><span class="line">LISTEN     0      128    192.168.1.82:2380      *:*           users:((<span class="string">&quot;etcd&quot;</span>,pid=753,fd=5))</span><br><span class="line">LISTEN     0      128          *:80             *:*           users:((<span class="string">&quot;nginx&quot;</span>,pid=28683,fd=34),(<span class="string">&quot;nginx&quot;</span>,pid=28671,fd=34))</span><br><span class="line">LISTEN     0      128          *:80             *:*           users:((<span class="string">&quot;nginx&quot;</span>,pid=28682,fd=17),(<span class="string">&quot;nginx&quot;</span>,pid=28671,fd=17))</span><br><span class="line">LISTEN     0      128       [::]:8443           [::]:*        users:((<span class="string">&quot;nginx-ingress-c&quot;</span>,pid=28646,fd=41))</span><br></pre></td></tr></table></figure>

<p><img src="/2019/05/13/nginx-ingress/image-20210112172951589.png" alt="image-20210112172951589"></p>
<h2 id="手动部署"><a href="#手动部署" class="headerlink" title="手动部署"></a>手动部署</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-configuration</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: udp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-serviceaccount</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - endpoints</span><br><span class="line">      - nodes</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - nodes</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - events</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">      - patch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      - <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;extensions&quot;</span></span><br><span class="line">      - <span class="string">&quot;networking.k8s.io&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - ingresses/status</span><br><span class="line">    verbs:</span><br><span class="line">      - update</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: Role</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">      - pods</span><br><span class="line">      - secrets</span><br><span class="line">      - namespaces</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    resourceNames:</span><br><span class="line">      <span class="comment"># Defaults to &quot;&lt;election-id&gt;-&lt;ingress-class&gt;&quot;</span></span><br><span class="line">      <span class="comment"># Here: &quot;&lt;ingress-controller-leader&gt;-&lt;nginx&gt;&quot;</span></span><br><span class="line">      <span class="comment"># This has to be adapted if you change either parameter</span></span><br><span class="line">      <span class="comment"># when launching the nginx-ingress-controller.</span></span><br><span class="line">      - <span class="string">&quot;ingress-controller-leader-nginx&quot;</span></span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - update</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - configmaps</span><br><span class="line">    verbs:</span><br><span class="line">      - create</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - <span class="string">&quot;&quot;</span></span><br><span class="line">    resources:</span><br><span class="line">      - endpoints</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-role-nisa-binding</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: nginx-ingress-role</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-clusterrole-nisa-binding</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: nginx-ingress-clusterrole</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: nginx-ingress-serviceaccount</span><br><span class="line">    namespace: ingress-nginx</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - min:</span><br><span class="line">      memory: 90Mi</span><br><span class="line">      cpu: 100m</span><br><span class="line">    <span class="built_in">type</span>: Container</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ingress-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io&#x2F;name: ingress-nginx</span><br><span class="line">    app.kubernetes.io&#x2F;part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io&#x2F;name: ingress-nginx</span><br><span class="line">      app.kubernetes.io&#x2F;part-of: ingress-nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io&#x2F;name: ingress-nginx</span><br><span class="line">        app.kubernetes.io&#x2F;part-of: ingress-nginx</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io&#x2F;port: &quot;10254&quot;</span><br><span class="line">        prometheus.io&#x2F;scrape: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      # wait up to five minutes for the drain of connections</span><br><span class="line">      terminationGracePeriodSeconds: 300</span><br><span class="line">      serviceAccountName: nginx-ingress-serviceaccount</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io&#x2F;os: linux</span><br><span class="line">      containers:</span><br><span class="line">        - name: nginx-ingress-controller</span><br><span class="line">          image: quay.io&#x2F;kubernetes-ingress-controller&#x2F;nginx-ingress-controller:0.30.0</span><br><span class="line">          args:</span><br><span class="line">            - &#x2F;nginx-ingress-controller</span><br><span class="line">            - --configmap&#x3D;$(POD_NAMESPACE)&#x2F;nginx-configuration</span><br><span class="line">            - --tcp-services-configmap&#x3D;$(POD_NAMESPACE)&#x2F;tcp-services</span><br><span class="line">            - --udp-services-configmap&#x3D;$(POD_NAMESPACE)&#x2F;udp-services</span><br><span class="line">            - --publish-service&#x3D;$(POD_NAMESPACE)&#x2F;ingress-nginx</span><br><span class="line">            - --annotations-prefix&#x3D;nginx.ingress.kubernetes.io</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: true</span><br><span class="line">            capabilities:</span><br><span class="line">              drop:</span><br><span class="line">                - ALL</span><br><span class="line">              add:</span><br><span class="line">                - NET_BIND_SERVICE</span><br><span class="line">            # www-data -&gt; 101</span><br><span class="line">            runAsUser: 101</span><br><span class="line">          env:</span><br><span class="line">            - name: POD_NAME</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.name</span><br><span class="line">            - name: POD_NAMESPACE</span><br><span class="line">              valueFrom:</span><br><span class="line">                fieldRef:</span><br><span class="line">                  fieldPath: metadata.namespace</span><br><span class="line">          ports:</span><br><span class="line">            - name: http</span><br><span class="line">              containerPort: 80</span><br><span class="line">              protocol: TCP</span><br><span class="line">            - name: https</span><br><span class="line">              containerPort: 443</span><br><span class="line">              protocol: TCP</span><br><span class="line">          livenessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            initialDelaySeconds: 10</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 10</span><br><span class="line">          readinessProbe:</span><br><span class="line">            failureThreshold: 3</span><br><span class="line">            httpGet:</span><br><span class="line">              path: &#x2F;healthz</span><br><span class="line">              port: 10254</span><br><span class="line">              scheme: HTTP</span><br><span class="line">            periodSeconds: 10</span><br><span class="line">            successThreshold: 1</span><br><span class="line">            timeoutSeconds: 10</span><br><span class="line">          lifecycle:</span><br><span class="line">            preStop:</span><br><span class="line">              exec:</span><br><span class="line">                command:</span><br><span class="line">                  - &#x2F;wait-shutdown</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#部署测试应用</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    app: myapp</span><br><span class="line">    release: canary</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    targetPort: 80</span><br><span class="line">    port: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-deploy</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector: </span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      release: canary</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">        release: canary</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp</span><br><span class="line">        image: ikubernetes/myapp:v2</span><br><span class="line">        ports: </span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ingress规则</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress </span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-myapp</span><br><span class="line">  namespace: default </span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">spec:</span><br><span class="line">  rules: </span><br><span class="line">  - host: myapp.nero.com</span><br><span class="line">    http:</span><br><span class="line">      paths: </span><br><span class="line">      - path:  </span><br><span class="line">        backend: </span><br><span class="line">          serviceName: myapp</span><br><span class="line">          servicePort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><h3 id="常用全局配置"><a href="#常用全局配置" class="headerlink" title="常用全局配置"></a>常用全局配置</h3><ul>
<li>更多配置可以配置 见官方文档:</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a></li>
<li>通过configmap nginx-configuration 新版本可能是 ingress-nginx-controller   定义一些全局常规参数</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">data:</span><br><span class="line">  multi_accept: on;</span><br><span class="line">  use: epoll;</span><br><span class="line">  user: www;</span><br><span class="line">  worker_connections: 65535;</span><br><span class="line">  worker_cpu_affinity: auto;</span><br><span class="line">  worker_processes: auto;</span><br><span class="line">  worker_rlimit_nofile: 300000;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 把真实IP地址传给后端</span></span><br><span class="line">  compute-full-forwarded-for: <span class="string">&quot;true&quot;</span></span><br><span class="line">  forwarded-for-header: <span class="string">&quot;X-Forwarded-For&quot;</span></span><br><span class="line">  use-forwarded-headers: <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="comment"># 关闭版本显示</span></span><br><span class="line">  server-tokens: <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="comment"># 客户端请求头的缓冲区大小 </span></span><br><span class="line">  client-header-buffer-size: <span class="string">&quot;512k&quot;</span></span><br><span class="line">  <span class="comment"># 设置用于读取大型客户端请求标头的最大值number和size缓冲区</span></span><br><span class="line">  large-client-header-buffers: <span class="string">&quot;16 512k&quot;</span></span><br><span class="line">  <span class="comment"># 读取客户端请求body的缓冲区大小</span></span><br><span class="line">  client-body-buffer-size: <span class="string">&quot;968k&quot;</span></span><br><span class="line">  <span class="comment"># 代理缓冲区大小</span></span><br><span class="line">  proxy-buffer-size: <span class="string">&quot;1024k&quot;</span></span><br><span class="line">  <span class="comment"># 代理body大小</span></span><br><span class="line">  proxy-body-size: <span class="string">&quot;50m&quot;</span></span><br><span class="line">  <span class="comment"># 服务器名称哈希大小</span></span><br><span class="line">  server-name-hash-bucket-size: <span class="string">&quot;128&quot;</span></span><br><span class="line">  <span class="comment"># map哈希大小</span></span><br><span class="line">  map-hash-bucket-size: <span class="string">&quot;128&quot;</span></span><br><span class="line">  <span class="comment"># SSL加密套件</span></span><br><span class="line">  ssl-ciphers: <span class="string">&quot;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA&quot;</span></span><br><span class="line">  <span class="comment"># ssl 协议</span></span><br><span class="line">  ssl-protocols: <span class="string">&quot;TLSv1 TLSv1.1 TLSv1.2&quot;</span></span><br><span class="line"><span class="comment">#定义json 访问日志格式</span></span><br><span class="line">log-format-upstream: <span class="string">&#x27;&#123;&quot;time&quot;: &quot;$time_iso8601&quot;, &quot;remote_addr&quot;: &quot;$proxy_protocol_addr&quot;, &quot;x-forward-for&quot;: &quot;$proxy_add_x_forwarded_for&quot;, &quot;request_id&quot;: &quot;$req_id&quot;, &quot;remote_user&quot;: &quot;$remote_user&quot;, &quot;bytes_sent&quot;: $bytes_sent, &quot;request_time&quot;: $request_time, &quot;status&quot;:$status, &quot;vhost&quot;: &quot;$host&quot;, &quot;request_proto&quot;: &quot;$server_protocol&quot;, &quot;path&quot;: &quot;$uri&quot;, &quot;request_query&quot;: &quot;$args&quot;, &quot;request_length&quot;: $request_length, &quot;duration&quot;: $request_time,&quot;method&quot;: &quot;$request_method&quot;, &quot;http_referrer&quot;: &quot;$http_referer&quot;, &quot;http_user_agent&quot;: &quot;$http_user_agent&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="string">&quot;/CN=myapp.nero.com&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n default create secret tls tls-test --key=tls.key --cert=tls.crt</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: networking.k8s.io/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-myapp</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: myapp.nero.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: myapp</span><br><span class="line">              servicePort: 80</span><br><span class="line">            <span class="comment">#路径匹配可以是正则如/app(/|$)(.*) </span></span><br><span class="line">            path: /</span><br><span class="line">  tls:</span><br><span class="line">    - secretName: tls-test</span><br><span class="line">      hosts:</span><br><span class="line">        - myapp.nero.com</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">╰─➤  curl -I myapp.nero.com</span><br><span class="line">HTTP/1.1 308 Permanent Redirect</span><br><span class="line"><span class="comment">#默认情况的308永久跳转https 但很多浏览器是不支持308跳转的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认情况下 创建https的ingress 此域名的http会自动以308形式自动跳转到https</span></span><br><span class="line"><span class="comment">#此配置添加到注解中 关闭308跳转</span></span><br><span class="line">nginx.ingress.kubernetes.io/ssl-redirect: <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#由于308跳转 很多浏览器不支持 所以需要改为301</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx-controller</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">data:</span><br><span class="line">  http-redirect-code: <span class="string">&#x27;301&#x27;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#而后需要重启pod 使其重新挂载 生效配置</span></span><br></pre></td></tr></table></figure>

<p>更多配置可以配置 见官方文档:</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</a></p>
<h3 id="四层负载"><a href="#四层负载" class="headerlink" title="四层负载"></a>四层负载</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建测试使用的mysqlpod</span></span><br><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql</span><br><span class="line">  namespace: tcp-test</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    app: mysql</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: mysql</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: mysql</span><br><span class="line">        image: mysql</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3306</span><br><span class="line">        env:</span><br><span class="line">        - name: MYSQL_ROOT_PASSWORD</span><br><span class="line">          value: <span class="string">&quot;123456&quot;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: ingress-nginx</span><br><span class="line">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class="line">  name: tcp-services</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">data:</span><br><span class="line">  3306: <span class="string">&quot;tcp-test/mysql:3306&quot;</span></span><br><span class="line">EOF</span><br><span class="line"><span class="comment">#此时发现并没有生效重启pod也不行  后来发现新版本都没有tcp和udp的两个configmap</span></span><br><span class="line"><span class="comment">#所以未果</span></span><br></pre></td></tr></table></figure>

<h3 id="客户端地址记录"><a href="#客户端地址记录" class="headerlink" title="客户端地址记录"></a><strong>客户端地址记录</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-dt</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;configuration-snippet: |</span><br><span class="line">      proxy_set_header Host $host;</span><br><span class="line">      proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">      proxy_set_header X-Forwarded-Proto $scheme;</span><br></pre></td></tr></table></figure>

<h3 id="匹配优先级"><a href="#匹配优先级" class="headerlink" title="匹配优先级"></a><strong>匹配优先级</strong></h3><ul>
<li>首先在nginx中我们知道location的匹配优先级大致为</li>
<li>精准匹配 &gt; 前缀匹配 &gt; 正则匹配&gt; /</li>
<li>其中,前缀匹配:^~，精准匹配 =，正则匹配细分为：</li>
<li>~ 区分大小写（大小写敏感）匹配成功；<del>* 不区分大小写匹配成功；!</del> 区分大小写匹配失败；!~* 不区分大小写匹配失败</li>
<li>而ingress资源对象中，spec.rules.http.paths.path字段默认只支持不区分大小写的正则匹配,但前提需要设置nginx.ingress.kubernetes.io/use-regex注释设置为true(默认值为false)来启用此功能</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-dt</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">test.haha.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">nginx-front</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/wifi</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">serviceName:</span> <span class="string">nginx-wifi</span></span><br><span class="line">              <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#进入到ingress-controller的pod中，观察nginx配置文件，发现location的正则匹配已生效   </span></span><br><span class="line"> ...</span><br><span class="line">   ...</span><br><span class="line">        <span class="comment">## start server test.haha.com                        </span></span><br><span class="line">        server &#123;                </span><br><span class="line">                server_name test.haha.com ;                     </span><br><span class="line">                listen 80  ;</span><br><span class="line">                listen [::]:80  ; </span><br><span class="line">                <span class="built_in">set</span> <span class="variable">$proxy_upstream_name</span> <span class="string">&quot;-&quot;</span>;                                     </span><br><span class="line">                ssl_certificate_by_lua_block &#123;                                   </span><br><span class="line">                        certificate.call()                                       </span><br><span class="line">                &#125;</span><br><span class="line">                location ~* <span class="string">&quot;^/wifi&quot;</span> &#123;</span><br><span class="line">                        <span class="built_in">set</span> <span class="variable">$namespace</span>      <span class="string">&quot;default&quot;</span>; </span><br><span class="line">                        <span class="built_in">set</span> <span class="variable">$ingress_name</span>   <span class="string">&quot;ingress-dt&quot;</span>;</span><br><span class="line">                        <span class="built_in">set</span> <span class="variable">$service_name</span>   <span class="string">&quot;nginx-wifi&quot;</span>;</span><br><span class="line">                        <span class="built_in">set</span> <span class="variable">$service_port</span>   <span class="string">&quot;80&quot;</span>;                                 </span><br><span class="line">                        <span class="built_in">set</span> <span class="variable">$location_path</span>  <span class="string">&quot;/wifi&quot;</span>;   </span><br></pre></td></tr></table></figure>

<h3 id="跨域配置"><a href="#跨域配置" class="headerlink" title="跨域配置"></a><strong>跨域配置</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-dt</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">&quot;PUT, GET, POST, OPTIONS&quot;</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/cors-allow-headers：&quot;DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="支持websocket配置"><a href="#支持websocket配置" class="headerlink" title="支持websocket配置"></a><strong>支持websocket配置</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ingress-dt</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">Upgrade</span> <span class="string">&quot;websocket&quot;</span><span class="string">;</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">Connection</span> <span class="string">&quot;Upgrade&quot;</span><span class="string">;</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/proxy-read-timeout</span> <span class="number">3600</span><span class="string">;</span> </span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/proxy-send-timeout</span> <span class="number">3600</span><span class="string">;</span></span><br></pre></td></tr></table></figure>

<h3 id="七层负载均衡算法"><a href="#七层负载均衡算法" class="headerlink" title="七层负载均衡算法"></a><strong>七层负载均衡算法</strong></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##默认算法rr</span></span><br><span class="line"><span class="comment">#通过会话cookie进行一致性hash均衡算法</span></span><br><span class="line">ingress.kubernetes.io/affinity: <span class="string">&quot;cookie&quot;</span></span><br><span class="line">ingress.kubernetes.io/session-cookie-name: <span class="string">&quot;route&quot;</span></span><br><span class="line">ingress.kubernetes.io/session-cookie-hash: <span class="string">&quot;sha1&quot;</span></span><br><span class="line"><span class="comment">#通过客户端ip进行一致性hash的均衡算法</span></span><br><span class="line">nginx.ingress.kubernetes.io/upstream-hash-by: <span class="string">&quot;<span class="variable">$&#123;remote_addr&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#通过请求uri进行一致性hash的均衡算法</span></span><br><span class="line">nginx.ingress.kubernetes.io/upstream-hash-by: <span class="string">&quot;<span class="variable">$&#123;request_uri&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="速率限制"><a href="#速率限制" class="headerlink" title="速率限制**"></a>速率限制**</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置 test.haha.com/login 登陆页为每秒100个连接数，192.168.1.0/24,192.168.2.8 IP段不在限速范围</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubernetes.io/ingress.class: <span class="string">&quot;nginx&quot;</span></span><br><span class="line">nginx.ingress.kubernetes.io/whitelist-source-range: 192.168.1.0/24,192.168.2.8</span><br><span class="line">nginx.ingress.kubernetes.io/limit-rps: <span class="string">&#x27;100&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置白名单IP范围"><a href="#配置白名单IP范围" class="headerlink" title="配置白名单IP范围"></a><strong>配置白名单IP范围</strong></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/24,172.10.0.1</span><br></pre></td></tr></table></figure>

<h3 id="rewrite-配置"><a href="#rewrite-配置" class="headerlink" title="rewrite 配置"></a><strong>rewrite 配置</strong></h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问 http://www.example.com/hello/(.*) 跳转到 http://www.example.com/(.*)</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># 绑定ingress-class</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">&quot;/$1&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello/(.*)$</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">demo-svc</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">demo-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">&quot;nginx&quot;</span> <span class="comment"># 绑定ingress-class</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">rewrite</span> <span class="string">^/hello/(.*)$</span> <span class="string">/$1</span> <span class="string">redirect;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/hello/(.*)$</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">demo-svc</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h3 id><a href="#" class="headerlink" title></a></h3> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/K8S/" rel="tag">K8S</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
    <article
  id="post-nginx"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/05/13/nginx/"
    >Nginx优化和常用全局配置</a> 
</h2>
 

    </header>
     
    <div class="article-meta">
      <a href="/2019/05/13/nginx/" class="article-date">
  <time datetime="2019-05-13T03:14:26.000Z" itemprop="datePublished">2019-05-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>
 
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><ul>
<li>官方网站: nginx.org</li>
</ul>
<h2 id="性能优化相关配置"><a href="#性能优化相关配置" class="headerlink" title="性能优化相关配置"></a>性能优化相关配置</h2><h3 id="worker-processes"><a href="#worker-processes" class="headerlink" title="worker_processes"></a>worker_processes</h3><ul>
<li>用来设置worker进程数量 通常是小于等于本机cpu核心或cpu线程数量  </li>
<li>也可以设置为 auto 为当前cpu核心数量</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#可以是auto 可以是数字 auto等于设置与当前cpu核心数量相同</span><br><span class="line">worker_processes  16;</span><br><span class="line">events &#123;</span><br><span class="line">    #单个worker进程最大的并发连接数</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="worker-cpu-affinity"><a href="#worker-cpu-affinity" class="headerlink" title="worker_cpu_affinity"></a>worker_cpu_affinity</h3><ul>
<li>worker与cpu的亲和 设置哪个work对应使用哪个cpu</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#2核心2work设置</span><br><span class="line">worker_processes     2;</span><br><span class="line">worker_cpu_affinity 01 10;</span><br><span class="line">#2核心4work</span><br><span class="line">worker_processes     2;</span><br><span class="line">worker_cpu_affinity 01 10 01 10;</span><br><span class="line">#4核心4work</span><br><span class="line">worker_processes     4;</span><br><span class="line">worker_cpu_affinity 0001 0010 0100 1000;</span><br></pre></td></tr></table></figure>

<h3 id="worker-priority"><a href="#worker-priority" class="headerlink" title="worker_priority"></a>worker_priority</h3><ul>
<li>在Linux和Unix中，当许多进程都处于可执行状态时，按照优先级来决定本次内核选择哪一个进程执行。进程分配的CPU时间片大小也与优先级有关，优先级越高，时间片越长（例如，在默认情况下，最小时间片是5ms，最大则有800ms）。优先级由静态优先级和内核根据进程的执行情况所做的动态调整（目前只有+-5的调整）共同决定。nice是进程的优先级，他的取值范围是-20~+19，-20是最高优先级，+19是最低优先级。不建议把nice的值设为比内核进程（t通常为-5）还要小</li>
<li>指明worker进程的nice值：数字越小,优先级越高</li>
<li>worker的优先级是通过worker_priority参数调整的，其取值范围为[-20, 20]</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_priority -19;</span><br></pre></td></tr></table></figure>



<h3 id="work-rlimit-nofile-number"><a href="#work-rlimit-nofile-number" class="headerlink" title="work_rlimit_nofile_number"></a>work_rlimit_nofile_number</h3><ul>
<li>每一个worker进程打开文件的数量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>



<h3 id="event"><a href="#event" class="headerlink" title="event{}"></a>event{}</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    #单个worker进程最大的并发连接数</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">    #使用epoll模型</span><br><span class="line">    use epoll;</span><br><span class="line">    #互斥锁 默认是 on 当所有worker处于睡眠态 来了一个请求就只唤醒一个worker </span><br><span class="line">    #如果off 即便来了一个请求 也要唤醒所有worker(惊群) 会导致负载上升 但最求吞吐量的话建议off</span><br><span class="line">    accept_mutex on;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="http字段常用配置"><a href="#http字段常用配置" class="headerlink" title="http字段常用配置"></a>http字段常用配置</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    #打开或关闭错误页面中的nginx版本号</span><br><span class="line">    server_tokens off;</span><br><span class="line">    #优化磁盘IO设置，指定nginx是否调用sendfile函数来输出文件，普通应用设为on，下载等磁盘IO高的应用，可设为off</span><br><span class="line">    sendfile on;</span><br><span class="line">    #设置nginx在一个数据包里发送所有头文件，而不是一个接一个的发送</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">    #长连接的超时时长，默认为75s</span><br><span class="line">    keepalive_timeout 30;</span><br><span class="line">    #在一个长连接所能够允许请求的最大资源数 不常用</span><br><span class="line">    keepalive_requests 20;</span><br><span class="line">    #设置默认字符集</span><br><span class="line">    charset UTF-8;</span><br><span class="line">    #设置nginx采用gzip压缩的形式发送数据，减少发送数据量，但会增加请求处理时间及CPU处理时间，需要权衡</span><br><span class="line">    gzip on;</span><br><span class="line">    #加vary给代理服务器使用，针对有的浏览器支持压缩，有个不支持，根据客户端的HTTP头来判断是否需要压缩</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    #nginx在压缩资源之前，先查找是否有预先gzip处理过的资源 不常用</span><br><span class="line">    gzip_static on;</span><br><span class="line">    #设置对数据启用压缩的最少字节数，如果请求小于10240字节则不压缩，会影响请求速度</span><br><span class="line">    gzip_min_length 10240;</span><br><span class="line">    #设置数据压缩等级，1-9之间，9最慢压缩比最大</span><br><span class="line">    gzip_comp_level 2;</span><br><span class="line">    #设置需要压缩的数据格式</span><br><span class="line">    gzip_types text/plain text/css text/xml text/javascript  application/json application/x-javascript application/xml application/xml+rss; </span><br><span class="line">    #开发缓存的同时也指定了缓存文件的最大数量，20s如果文件没有请求则删除缓存</span><br><span class="line">    open_file_cache max=100000 inactive=20s;</span><br><span class="line">    #指多长时间检查一次缓存的有效信息</span><br><span class="line">    open_file_cache_valid 60s;</span><br><span class="line">    #文件缓存最小的访问次数，只有访问超过5次的才会被缓存</span><br><span class="line">    open_file_cache_min_uses 5;</span><br><span class="line">    #允许客户端请求的最大单文件字节数</span><br><span class="line">    client_max_body_size 8m;</span><br><span class="line">    #冲区代理缓冲用户端请求的最大字节数</span><br><span class="line">    client_header_buffer_size 32k;</span><br><span class="line">    #引用/etc/nginx/vhosts下的所有配置文件，如果主机名众多的情况下可以每个主机名建立一个文件，以方便管理</span><br><span class="line">    include /etc/nginx/vhosts/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>

    </footer>
  </div>

    
 
   
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/6/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> Nero
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/logo.png" alt="Nero 的个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->


<script src="/js/clickBoom2.js"></script>


<!-- CodeCopy -->


<link rel="stylesheet" href="/css/clipboard.css">

<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>


<!-- CanvasBackground -->


<script src="/js/dz.js"></script>



    
  </div>
</body>

</html>